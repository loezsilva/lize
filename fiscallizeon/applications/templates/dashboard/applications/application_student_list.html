{% extends 'redesign/base.html' %}
{% comment %} {% extends 'dashboard/base_fixed.html' %} {% endcomment %}
{% load static %}
{% load proportion %}
{% load exclude_especific_params %}

{% block title %}Listagem de provas dos alunos - Lize{% endblock title %}
{% block css-additional %}
  <style>
    .tippy-box[data-theme~='custom'] {
      background-color: #fff;
      border: 1px solid #E1E5ED;
      padding: .3rem;
    }
    .tippy-box[data-theme~='custom'][data-placement^='bottom'] > .tippy-arrow::before {
      border-bottom-color: #E1E5ED;
    }
    .no-data-cell {
      text-align: center;
      vertical-align: middle; 
      width: 100%;
      padding: 200px !important; 
      height: 100%;
      min-height: 100%%;
    }
  </style>
{% endblock css-additional %}

{% block breadcrumb-fixed %}
  <div class="ls px-3" style="margin-top: 1rem; margin-bottom: 1rem; justify-content: space-between;">
    <nav class="ls" aria-label="Breadcrumb">
      <ol role="list" class="ls yu abe" style="list-style: none; margin: 0; padding: 0;">
        <li>
          <div>
            <a href="{% url 'core:redirect_dashboard' %}" class="axk bks">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="nu rw uk" style="width: 1.25rem; height: 1.25rem; flex-shrink: 0;">
                <path fill-rule="evenodd" d="M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 11h-1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-3a1 1 0 00-1-1H9a1 1 0 00-1 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-6H3a1 1 0 01-.707-1.707l7-7z" clip-rule="evenodd"></path>
              </svg>
              <span class="t" style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0;">Painel</span>
            </a>
          </div>
        </li>
        <li>
          <div class="ls yu">
            <svg class="nu rw uk axj" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true" style="width: 1.25rem; height: 1.25rem; flex-shrink: 0; color: rgb(209 213 219);">
              <path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z"></path>
            </svg>
            <a href="data:text/plain," class="js avv avz axm bku" aria-current="page" style="margin-left: 1rem; font-size: 0.875rem; line-height: 1.25rem; font-weight: 500; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; overflow-wrap: normal;">
              Provas
            </a>
          </div>
             
        </li>
      </ol>
    </nav>
  </div>
{% endblock breadcrumb-fixed %}

{% block content-fixed %}
<div class="ard cer dcv tw-mb-16">

  {% if is_mobile %}
    <!-- Mobile screen -->
    <div class="d-block d-lg-none">
      <div class="card-header mt-4 p-0 d-flex flex-column flex-sm-row align-items-sm-start justify-content-sm-between">
        <h6 class="mg-b-5">Lista de provas</h6>
          <p class="tx-12 tx-color-03 mg-b-0">Visualize todas as provas realizadas ou que estão agendadas.</p>
          <div class="float-right text-right">
            <div class="justify-content-end">
              <button data-toggle-off-canvas="#right-off-canvas"
                class="btn btn-sm btn-info btn-icon rounded-pill off-canvas-menu  mb-2">
                <i class="fas fa-search"></i> Filtrar listagem 
                {% if count_filters > 0 %}
                <span class="badge badge-danger">{{count_filters}} Aplicado(s)</span>
                {% endif %}
              </button>
              {% if count_filters %}
                {% if only_scheduled %}
                  <a href="?year={{year|force_escape}}&only_scheduled=true"
                    class="btn btn-sm btn-info btn-icon rounded-pill mb-2">
                    <i class="fas fa-eraser"></i> Apagar filtro(s)
                  </a>
                {% else %}
                  <a href="?year={{year|force_escape}}"
                    class="btn btn-sm btn-info btn-icon rounded-pill mb-2">
                    <i class="fas fa-eraser"></i> Apagar filtro(s)
                  </a>
                {% endif %}
              {% endif %}

            </div>
          </div>

        <div class="btn-group mt-1">
          <a href="?year=2024{{request|exclude_especific_params:'year,page'}}" class="btn btn-xs {% if year == '2024' or year == 2024 %} btn-primary {% else %} btn-white {% endif %} btn-uppercase">2024</a>
          <a href="?year=2025{{request|exclude_especific_params:'year,page'}}" class="btn btn-xs {% if year == '2025' or year == 2025 %} btn-primary {% else %} btn-white {% endif %} btn-uppercase">2025</a>
        </div> 
        <div class="btn-group mt-1">
          <a  href="?{{request|exclude_especific_params:'year,page,only_scheduled'}}" class="btn btn-xs {% if not only_scheduled %} btn-primary {% else %} btn-white {% endif %} btn-uppercase">Liberadas</a>
          <a  href="?only_scheduled=true{{request|exclude_especific_params:'year,page,only_scheduled'}}" class="btn btn-xs {% if only_scheduled %} btn-primary {% else %} btn-white {% endif %} btn-uppercase">Agendadas</a>
        </div>
        <button class="btn btn-white mt-1" onclick="history.back()">Voltar</button>
      </div>
      <hr>
      <div class="row mb-0 mt-2">
        <div v-for="application in applications.slice((page-1)*10,(page)*10)" class="col-12 mb-3">
            <div class="card card-body shadow-sm">
              <div class="d-flex justify-content-between">
                <div>
                    <span v-if="application.category_display == 'Online'" class="badge badge-primary text-center" style="max-width: 7rem;">Prova Online</span>
                  
                    <span v-if="application.category_display == 'Presencial'" class="badge badge-success text-center" style="max-width: 7rem;">Prova Presencial</span>
                  
                    <span v-if="application.category_display == 'Lista de Exercício'" class="badge badge-success text-center" style="max-width: 7rem;">Lista de Exercício</span>
                </div>
                <div>
                  <i class="fas fa-ellipsis-v" data-toggle="dropdown" aria-expanded="false"></i>
                  <div class="dropdown-menu">
                    <template v-if="!application.has_open_applications_exam && client_show_previews_template_student">
                        <a :href="url('{% url 'applications:application_previous_feedback' pk='00000000-0000-0000-0000-000000000000'  %}', {'00000000-0000-0000-0000-000000000000': application.application_student_id})" class="nav-link">
                            <i class="fas fa-grip-vertical"></i> Gabarito Prévio
                        </a>
                    </template>
                    <template v-if="application.is_time_finished">
                      <template v-if="new Date(today) >= new Date(application.student_stats_permission_date) || !application.student_stats_permission_date">
                        <a v-if="application.student_stats_permission_date || application.release_results_at_end" :href="url('{% url 'applications:application_exam_student_detail_insight' pk='00000000-0000-0000-0000-000000000000'  %}', {'00000000-0000-0000-0000-000000000000': application.application_student_id})" class="dropdown-item"><i class="fas fa-eye"></i> Ver questões para revisar</a>
                      </template>
                    </template>
                    <template v-else-if="application.release_results_at_end && application.end">
                      <a v-if="application.student_stats_permission_date || application.release_results_at_end" :href="url('{% url 'applications:application_exam_student_detail_insight' pk='00000000-0000-0000-0000-000000000000'  %}', {'00000000-0000-0000-0000-000000000000': application.application_student_id})" class="dropdown-item"><i class="fas fa-eye"></i> Ver questões para revisar</a>
                    </template>
                    <template v-if="application.application_student_total_answered_questions > 0 && !application.application_student_is_omr">
                      <template v-if="application.is_time_finished || application.category == 4">
                          <a target="_blank" :href="url('{% url 'answers:proof_of_answers_create' pk='00000000-0000-0000-0000-000000000000'  %}', {'00000000-0000-0000-0000-000000000000': application.application_student_id})" class="dropdown-item"><i class="fas fa-receipt"></i> Imprimir comprovante</a>
                      </template>
                    </template>
                  </div>
                </div>
              </div>
                <h6 class="mb-0 text-truncate mt-2">${application.exam_name}</h6>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        <p style="margin-bottom: 0; font-size: 14px; color: #7987A1;">
                          <template v-if="application.category_display == 'Lista de Exercício'">
                            <template v-if="application.date_end == today">
                              ${application.date} <br/>
                              <span class="text-muted">${application.start} até ${application.end}</span>
                              </template>
                              <template v-else>
                                ${application.date} ${application.start} <br/>
                                <span class="text-muted"> Até ${application.date_end} ${application.end}</span>
                              </template>
                          </template>
                          <template v-else>
                            ${application.date} <br/>
                            <span class="text-muted">${application.start} até ${application.end}</span>
                          </template>
                        </p>
                    </div>
                    <div>
                        <div class="col-6 col-sm media">
                            <div class="media-body">
                                <h6 class="tx-sans tx-uppercase tx-10 tx-spacing-1 tx-color-03 tx-semibold mg-b-5 mg-md-b-8">Nota</h6>
                                <h4 class="tx-24 tx-sm-24 tx-md-30 tx-normal tx-rubik mg-b-0">
                                  <template v-if="application.release_results_at_end && application.application_student_end_time || application.release_results_at_end && application.is_time_finished">
                                    ${application.application_student_total_grade}
                                  </template>
                                  <span v-else-if="application.release_results_at_end && !application.application_student_end_time" class="text-muted">
                                    --
                                  </span>
                                  <template v-else-if="application.student_stats_permission_date">
                                    <template v-if="application.is_time_finished && new Date(today) >= new Date(application.student_stats_permission_date)">
                                      ${application.application_student_total_grade}
                                    </template>
                                    <template v-else>
                                      <span class="text-muted">--</span>
                                    </template>

                                  </template>
                                  <template v-else>
                                    ${application.application_student_total_grade}
                                  </template>
                                </h4>
                            </div>
                        </div>
                    </div>
                </div>
                <hr class="my-2">
                <div class="d-flex flex-column flex-sm-row align-items-sm-start justify-content-sm-between">
                  <template v-if="application.is_time_finished">
                    <template v-if="new Date(today) >= new Date(application.student_stats_permission_date) || !application.student_stats_permission_date">
                      <div class="btn-group mt-1">
                        <a v-if="application.student_stats_permission_date || application.release_results_at_end" :href="url('{% url 'applications:application_exam_student_detail_v2' pk='00000000-0000-0000-0000-000000000000'  %}', {'00000000-0000-0000-0000-000000000000': application.application_student_id})" class="btn btn-xs btn-primary btn-uppercase">
                          <i class="fas fa-search"></i> Ver resultado
                        </a>
                      </div>
                    </template>
                    <template v-else>
                      <div class="btn-group mt-1">
                        <button type="button" disabled class="btn btn-xs btn-white btn-uppercase"><i class="far fa-calendar"></i> Resultado não divulgado</button>
                      </div>
                    </template>
                  </template>
                  <template v-else-if="application.release_results_at_end && application.application_student_end_time">
                    <a v-if="application.student_stats_permission_date || application.release_results_at_end" :href="url('{% url 'applications:application_exam_student_detail_v2' pk='00000000-0000-0000-0000-000000000000'  %}', {'00000000-0000-0000-0000-000000000000': application.application_student_id})" class="btn btn-xs btn-primary btn-uppercase">
                      <i class="fas fa-search"></i> Ver resultado
                    </a>
                  </template>
                  <template v-else>
                    <a href="javascript:void(0)" class="btn btn-xs btn-white btn-uppercase">
                      <template v-if="new Date(today).getTime() < new Date(application.date_time_start_tz).getTime()">
                        <i class="far fa-calendar-times"></i>
                        A prova ainda não começou!
                      </template>
                      <template v-else>
                        <template v-if="application.is_time_finished">
                          <i class="far fa-clock"></i>
                          Aguarde a divulgação
                        </template>
                        <template v-else>
                          <i class="far fa-clock"></i>  
                          Prova em andamento
                        </template>
                      </template>
                    </a>
                  </template>
                </div>
            </div>
        </div>
      {% include 'includes/pagination.html' with objects=applications %}
    </div>
  {% else %}
    <!-- Large screen -->
    <div class="d-none d-md-block">
      <div class="ls" style="margin-top: 1.25rem; margin-bottom: 1rem; justify-content: space-between;">
        {% include "dashboard/breadcrumb-year.html" with year=year|force_escape %}
        <div class="justify-content-end">
          <button data-toggle-off-canvas="#right-off-canvas"
            class="btn btn-sm btn-info btn-icon rounded-pill off-canvas-menu  mb-2">
            <i class="fas fa-search"></i> Filtrar listagem 
            {% if count_filters > 0 %}
            <span class="badge badge-danger">{{count_filters}} Aplicado(s)</span>
            {% endif %}
          </button> 
          {% if count_filters %}
            {% if only_scheduled %}
              <a href="?year={{year|force_escape}}&only_scheduled=true"
                class="btn btn-sm btn-info btn-icon rounded-pill mb-2">
                <i class="fas fa-eraser"></i> Apagar filtro(s)
              </a>
            {% else %}
            <a href="?year={{year|force_escape}}"
              class="btn btn-sm btn-info btn-icon rounded-pill mb-2">
              <i class="fas fa-eraser"></i> Apagar filtro(s)
            </a>
            {% endif %}
          {% endif %}
        </div>
      </div>
      
      <div class="row">
          <div class="col-md-12">
              <div class="card mg-b-10">
                  <div class="card-header pd-t-20 d-sm-flex align-items-start justify-content-between bd-b-0 pd-b-0">
                    <div>
                      <h6 class="mg-b-5">{% if category == 'homework' %}Listas de exercício{% else %}Provas{% endif %}</h6>
                      <p class="tx-13 tx-color-03 mg-b-5">Visualize todas as {% if category == 'homework' %}listas de exercício{% else %}provas{% endif %} que você já realizou ou que estão agendadas</p>
                    </div>
                  </div>
                  <div class="table-responsive" style="min-height: 400px">
                    <table class="table table-dashboard mg-b-1 table-bordered">
                      <thead>
                        <tr>
                          <th>Quando</th>
                          <th>Disciplina(s)</th>
                          <th>Nota</th>                    
                          <th class="text-wrap"></th>
                        </tr>
                      </thead>
                      <tbody>
                        <template v-if= "applications.length > 0">
                          <template v-for="application in applications.slice((page-1)*10,(page)*10)">
                            <tr>
                              <td class="tx-medium" style="white-space: nowrap;">
                                <div v-if="application.category_display == 'Lista de Exercício'">
                                  <div v-if="application.end_today">
                                    ${application.date} <br/>
                                    <span class="text-muted">${application.start} até ${application.end}</span>
                                  </div>
                                  <div v-else>
                                    ${application.date} ${application.start} <br/> 
                                    <span class="text-muted"> Até ${application.date_end} ${application.end}</span>
                                  </div>
                                </div>
                                <div v-else>
                                  ${application.date} <br/>
                                  <span class="text-muted">${application.start} até ${application.end}</span>
                                </div>
                              </td>
                              <td>
                                <span v-if="application.category_display == 'Online'" class="badge badge-primary">Prova Online</span>
                                <span v-else-if="application.category_display == 'Presencial'" class="badge badge-success" data-toggle="tooltip">Prova Presencial</span>
                                <span v-else-if="application.category_display == 'Lista de Exercício'" class="badge badge-success">Lista de Exercício</span>
                                <br>
                                ${application.exam_name}
                              </td>
                              <td v-if="application.release_results_at_end && application.end || application.release_results_at_end && application.is_time_finished">
                                ${application.application_student_total_grade}
                              </td>
                              
                              <td v-else-if="application.release_results_at_end && !application.application_student_end_time" class="tx-medium">
                                Divulgação <br>
                                <span class="text-muted">
                                  Após o término do caderno
                                </span>
                              </td>
                              <template v-else-if="application.student_stats_permission_date">
                                <td v-if="application.is_time_finished && new Date(today) >= new Date(application.student_stats_permission_date)">
                                    ${application.application_student_total_grade} 
                                </td>
                                <td v-else class="tx-medium">  
                                  Divulgação <br>
                                  <span class="text-muted">
                                    ${new Date(application.student_stats_permission_date).toLocaleString()}
                                  </span>
                                </td>
                              </template>
                              <td v-else>
                                ${application.application_student_total_grade}
                              </td>
                              <td class="text-wrap">
                                <div class="d-flex justify-content-end">
                                  <div class="dropdown mr-2">
                                      <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        Opções
                                      </button>
                                      <div class="dropdown-menu" style="min-width: 230px; position:relative !important" aria-labelledby="dropdownMenuButton">
                                        <template v-if="application.application_student_total_answered_questions > 0 && !application.application_student_is_omr">
                                            <template v-if="application.is_time_finished || application.category == 4">
                                                <a target="_blank" :href="url('{% url 'answers:proof_of_answers_create' pk='00000000-0000-0000-0000-000000000000'  %}', {'00000000-0000-0000-0000-000000000000': application.application_student_id})" class="nav-link">
                                                    <i class="fas fa-receipt"></i> Imprimir comprovante
                                                </a>
                                            </template>
                                        </template>
                                        <template v-if="application.is_time_finished">
                                            <template v-if="new Date(today) >= new Date(application.student_stats_permission_date) || !application.student_stats_permission_date">
                                                <a v-if="application.student_stats_permission_date || application.release_results_at_end" :href="url('{% url 'applications:application_exam_student_detail_v2' pk='00000000-0000-0000-0000-000000000000'  %}', {'00000000-0000-0000-0000-000000000000': application.application_student_id})" class="nav-link">
                                                    <i class="fas fa-search"></i> Ver Resultado
                                                </a>
                                                
                                                {% if user.client_has_essay_system %}
                                                  <template v-if="application.has_essay_questions">
                                                    <a :href="url('{% url 'applications:application_student_essay_detail' pk='00000000-0000-0000-0000-000000000000'  %}', {'00000000-0000-0000-0000-000000000000': application.application_student_id})" class="nav-link d-flex">
                                                      <svg width="18" height="18" class="mr-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M13 5.99985L6.50182 7.29948C6.13883 7.37208 5.95733 7.40838 5.80952 7.49665C5.67886 7.57469 5.56772 7.68152 5.4846 7.80901C5.39057 7.95321 5.34714 8.13314 5.26028 8.49299L2 21.9998M2 21.9998L15.5069 18.7396C15.8667 18.6527 16.0466 18.6093 16.1908 18.5153C16.3183 18.4321 16.4252 18.321 16.5032 18.1903C16.5915 18.0425 16.6278 17.861 16.7004 17.498L18 10.9998M2 21.9998L9.586 14.4138M20.8686 7.86848L16.1314 3.13122C15.7354 2.7352 15.5373 2.53719 15.309 2.46301C15.1082 2.39775 14.8918 2.39775 14.691 2.46301C14.4627 2.53719 14.2646 2.7352 13.8686 3.13122L13.1314 3.86848C12.7354 4.2645 12.5373 4.4625 12.4632 4.69083C12.3979 4.89168 12.3979 5.10802 12.4632 5.30887C12.5373 5.53719 12.7354 5.7352 13.1314 6.13122L17.8686 10.8685C18.2646 11.2645 18.4627 11.4625 18.691 11.5367C18.8918 11.6019 19.1082 11.6019 19.309 11.5367C19.5373 11.4625 19.7354 11.2645 20.1314 10.8685L20.8686 10.1312C21.2646 9.7352 21.4627 9.53719 21.5368 9.30887C21.6021 9.10802 21.6021 8.89168 21.5368 8.69083C21.4627 8.4625 21.2646 8.2645 20.8686 7.86848ZM11 10.9998C12.1046 10.9998 13 11.8953 13 12.9998C13 14.1044 12.1046 14.9998 11 14.9998C9.89543 14.9998 9 14.1044 9 12.9998C9 11.8953 9.89543 10.9998 11 10.9998Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                      </svg> Ver redação
                                                    </a>
                                                  </template>
                                                {% endif %}
                                    
                                                <a v-if="application.student_stats_permission_date || application.release_results_at_end" :href="url('{% url 'applications:application_exam_student_detail_insight' pk='00000000-0000-0000-0000-000000000000'  %}', {'00000000-0000-0000-0000-000000000000': application.application_student_id})" class="nav-link">
                                                    <i class="fas fa-eye"></i> Ver questões para revisar
                                                </a>
                                            </template>
                                            <template v-else>
                                                <a href="javascript:void(0)" class="nav-link disabled">
                                                    Resultado não divulgado
                                                </a>
                                            </template>
                                            <template v-if="!application.has_open_applications_exam && client_show_previews_template_student">
                                                <a :href="url('{% url 'applications:application_previous_feedback' pk='00000000-0000-0000-0000-000000000000'  %}', {'00000000-0000-0000-0000-000000000000': application.application_student_id})" class="nav-link">
                                                    <i class="fas fa-grip-vertical"></i> Gabarito Prévio
                                                </a>
                                            </template>
                                        </template>
                                        <template v-else-if="application.release_results_at_end && application.end">
                                            <a v-if="application.student_stats_permission_date || application.release_results_at_end" :href="url('{% url 'applications:application_exam_student_detail_v2' pk='00000000-0000-0000-0000-000000000000'  %}', {'00000000-0000-0000-0000-000000000000': application.application_student_id})" class="nav-link">
                                                <i class="fas fa-search"></i> Ver Resultado
                                            </a>
                                    
                                            <a v-if="application.student_stats_permission_date || application.release_results_at_end" :href="url('{% url 'applications:application_exam_student_detail_insight' pk='00000000-0000-0000-0000-000000000000'  %}', {'00000000-0000-0000-0000-000000000000': application.application_student_id})" class="nav-link">
                                                <i class="fas fa-eye"></i> Ver questões para revisar
                                            </a>
                                        </template>
                                        <template v-else>
                                          <template>
                                            <div>                                          
                                              <template v-if="new Date(today) <  new Date(application.date_time_start_tz)">
                                                <a  href="javascript:void(0)" class="nav-link">
                                                  <i class="far fa-calendar-times"></i>
                                                  A prova ainda não começou!
                                              </a>
                                            </template>
                                            <template v-else>
                                              {% if application.is_time_finished %}
                                                <a  href="javascript:void(0)" class="nav-link">
                                                  <i class="far fa-clock"></i>
                                                  Aguarde a divulgação
                                                </a>
                                              {% else %}
                                                <a 
                                                {% comment %}
                                                {% if not application.get_category_display == 'Online' %}
                                                  :href="buildUrlMonitoringStudent(application.application_student_id)" 
                                                {% endblock %}
                                                {% endcomment %}
                                                target="_blank" class="nav-link">
                                                  <i class="far fa-clock"></i>
                                                  Prova em andamento
                                                </a>
                                              {% endif %}
                                            </template>
                                            </div>
                                        </template>
                                        </template>
                                        <template v-if="application.category == 4 && Date(today) >= Date(application.date_time_start_tz)">
                                            <a :href="url('{% url 'exams:exam_homework_print' pk='00000000-0000-0000-0000-000000000000' application_student='00000000-0000-0000-0000-000000000000' %}', {'00000000-0000-0000-0000-000000000000': application.exam_pk, '00000000-0000-0000-0000-000000000000': application.application_student_id})" target="_blank" class="nav-link">
                                                <i class="fas fa-file-alt"></i> Imprimir Caderno
                                            </a>
                                        </template>
                                    </div>
                                    
                                  </div>
                                </div>
                              </td>
                            </tr>
                          </template>
                        </template>
                        <template v-else>
                          <tr class="no-data-row">
                            <td colspan="5" class="no-data-cell">
                              Nenhuma {% if category == 'homework' %}listas de exercício{% else %}prova{% endif %}  agendada.
                            </td>
                          </tr>
                        </template>                
                      </tbody>
                    </table>
                  </div>
              </div>
          </div>
      </div>
      {% include 'includes/pagination.html' with objects=applications %}
    </div>
    <div class="d-block d-md-none d-flex flex-column align-items-center mt-4">
      <span class="mb-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.77 4.78 4 4 0 0 1-6.75 0 4 4 0 0 1-4.78-4.77 4 4 0 0 1 0-6.76Z"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
      </span>
      <h3>
        Tela responsiva disponível apenas para dispositivos móveis
      </h3>
    </div>
  {% endif %}
</div>
{% endblock content-fixed %}

{% block off-canvas %}

  <div id="right-off-canvas" class="off-canvas off-canvas-right wd-400 bg-white"
    style="overflow-y: auto; overflow-x: hidden;">
    <form action="" method="GET">
    <input type="hidden" name="year" value="{{year|force_escape}}">
    <input type="hidden" name="only_scheduled" value="{% if only_scheduled %}true{% endif %}">
    <div class="row p-3">
      <div class="col-12">
        <h5>Filtrar turmas</h5>
        <p>Adiciona abaixo os filtros que você deseja aplicar na listagem abaixo</p>
        <hr/>
      </div>
        <div class="col-12">
          <div class="form-group mb-3">
            <label for="subject_id" class="mb-1">Disciplinas</label>
            <select name="q_subjects" id="subject_id" class="form-control" multiple="multiple" >
              {% for subject in subjects %}
                <option value="{{subject.pk}}" {% if subject.pk|stringformat:'s' in q_subjects %}selected="selected" {% endif %}>
                  {{subject.name}} > {{subject.knowledge_area__name}}
              </option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="col-12">
            <div class="form-group mb-3">
              <label for="classe_id" class="mb-1">Turmas</label>
              <select id="classe_id" name="q_classes" class="form-control"  multiple="multiple">
              {% for classe in classes %}
                <option value="{{classe.pk}}" {% if classe.pk|stringformat:'s' in q_classes %}selected="selected" {% endif %}>
                  {{classe.name}} - {{ classe.coordination.unity.name }} - {{ classe.school_year|force_escape }}
                </option>
              {% endfor %}
            </select>
            </div>
        </div>
        <div class="col-12">
          <div class="form-group mb-3">
            <label for="end_time_start" class="mb-1">Data de Realização</label>
            <input type="date" id="end_time_start" name="q_date"placeholder="dd-mm-yyyy" class="form-control" value="{{q_end_time_start}}">
          </div>
        </div>
        <div class="col-12 mt-5">
          <button type="submit" class="btn btn-primary btn-block">
            <i class="fas fa-search"></i>
            Aplicar filtro
          </button>
        </div>
      </div>
    </form>
  </div>
{% endblock %}



{% block js-additional %}

<link href="{% static 'administration/lib/select2/css/select2.min.css' %}" rel="stylesheet" />
<link href="{% static 'administration/lib/bootstrap-tagsinput/bootstrap-tagsinput.css' %}" rel="stylesheet">
<script src="{% static 'js/annotorious/openseadragon.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/@recogito/annotorious@2.6.0/dist/annotorious.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@recogito/annotorious-openseadragon@2.6.0/dist/openseadragon-annotorious.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="{% static 'new/administration/lib/jquery.flot/jquery.flot.js' %}"></script>
<script src="{% static 'administration/lib/bootstrap-tagsinput/bootstrap-tagsinput.min.js' %}"></script>
<script src="{% static 'administration/lib/select2/js/select2.min.js' %}"></script>
<script src="https://unpkg.com/@sjmc11/tourguidejs/dist/tour.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="{% static 'js/tippy/popper.min.js' %}"></script>
<script src="{% static 'js/tippy/tippy.min.js' %}"></script>

<script>
const app_student = new Vue({
  delimiters: ["${", "}"],
  el: "#app",
  data: {
    client_show_previews_template_student: {{ user.client_show_previews_template_student|lower }},
    today: "{{ today|date:'Y-m-d\\TH:i' }}",
    page: {{ page }},
    createNewFilter: false,
    filterType: '',
    baseUrlMonitoringStudent: "{% url 'applications:applications_monitoring_student' pk='00000000-0000-0000-0000-000000000000' %}",
    applications: [
      {% for application_student in applications %}
        {% with application_student.application as application %}
        {
          id: "{{ application.id }}",
          application_student_id: "{{ application_student.id }}",
          exam_name: "{{ application.exam }}",
          exam_id: "{{ application.exam.id }}",
          category_display: "{{ application.get_category_display }}",
          date: "{{ application.date|date:'d/m/Y' }}",
          end: "{{ application.end|date:'TH:i' }}",
          start: "{{ application.start|date:'TH:i' }}",
          date_end: "{{ application.date_end|date:'d/m/Y' }}",
          date_start: "{{ application.date_start|date:'d/m/Y' }}",
          end_today: {% if application.date_end == today %}true{% else %}false{% endif %},
          release_results_at_end: {{ application.release_result_at_end|lower }},
          is_time_finished: {{ application.is_time_finished|lower }},
          student_stats_permission_date: "{{ application.student_stats_permission_date|date:'Y-m-d\\TH:i' }}",
          application_student_end_time: "{{ application_student.end_time|date:'Y-m-d\\TH:i' }}",

          {% if application.student_stats_permission_date or application.release_result_at_end %}
            application_student_total_grade: "{{ application_student.total_grade|floatformat:2 }}",
          {% else %}
            application_student_total_grade: "Resultado não divulgado",
          {% endif %}

          application_student_total_answered_questions: "{{ application_student.total_answered_questions }}",
          application_student_is_omr: {{ application_student.is_omr|lower }},
          category: "{{ application.category }}",
          has_open_applications_exam: {{ application.has_open_applications_exam|lower }},
          date_time_start_tz: "{{ application.date_time_start_tz|date:'Y-m-d\\TH:i' }}",
          has_essay_questions: {{application.exam.has_essay_questions|lower}},
        },
        {% endwith %}
      {% endfor %}
    ],
  },
  mounted() {
    this.today = new Date("{{ today|date:'Y-m-d\\TH:i' }}")

    $('#classe_id').select2({
        placeholder: "Selecione uma opção",
        closeOnSelect: false,
      }).on('select2:selecting', function(e) {
        let cur = e.params.args.data.id;
        let old = (e.target.value == '') ? [cur] : $(e.target).val().concat([cur]);
        $(e.target).val(old).trigger('change');
        $(e.params.args.originalEvent.currentTarget).attr('aria-selected', 'true');
        return false;
      });
    $('#subject_id').select2({
      placeholder: "Selecione uma opção",
      closeOnSelect: false,
      templateResult: function (data, container) {
        let subject_name = data.text.split('>')[0]
        let knowledge_area_name = data.text.split('>')[1]
        return $(
          `<strong class="select2-results__custom_option">${subject_name}</strong> <br> <span class="select2-results__custom_option">${knowledge_area_name}</span>`
        );
      },
    }).on('select2:selecting', function(e) {
      let cur = e.params.args.data.id;
      let old = (e.target.value == '') ? [cur] : $(e.target).val().concat([cur]);
      $(e.target).val(old).trigger('change');
      $(e.params.args.originalEvent.currentTarget).attr('aria-selected', 'true');
      return false;
    });


    $('#status_id').select2({
      placeholder: "Selecione uma opção",
      closeOnSelect: false,
    });

    $('#unity_id').select2({
      placeholder: "Selecione uma opção",
      closeOnSelect: false,
    });

    $('#grade_id').select2({
      placeholder: "Selecione uma opção",
      closeOnSelect: false,
    });

    $(function () {
      'use strict'

      $('.off-canvas-menu').on('click', function (e) {
        e.preventDefault();
        var target = $(this).attr('data-toggle-off-canvas');
        $(target).addClass('show');
      });

      $('.off-canvas .close').on('click', function (e) {
        e.preventDefault();
        $(this).closest('.off-canvas').removeClass('show');
      })

      $(document).on('click touchstart', function (e) {
        if($(e.target).hasClass('select2-results__option') || $(e.target).hasClass('select2-results__custom_option')) {
          return
        }
        e.stopPropagation();

        if (!$(e.target).closest('.off-canvas-menu').length) {
          var offCanvas = $(e.target).closest('.off-canvas').length;
          if (!offCanvas) {
            $('.off-canvas.show').removeClass('show');
          }
        }
      });
    });
  },
  methods: {
    setFilterType(type) {
      this.filterType = type;
      console.log(type)
      document.getElementById('only_scheduled').value = type;

      // Submete o formulário automaticamente após definir o valor
      {% comment %} document.getElementById('filter-form').submit(); {% endcomment %}
    },
    buildUrlMonitoringStudent(studentApplicationId) {
      return this.baseUrlMonitoringStudent.replace('00000000-0000-0000-0000-000000000000', studentApplicationId);
    },
    url(name, params) {
      function replaceMultiple(str, replacements) {
        return str.replace(new RegExp(Object.keys(replacements).join('|'), 'g'), match => replacements[match]);
      }
      let result = replaceMultiple(name, params);
      
      return result;
    },  
    preserveFilters() {
      const form = document.getElementById('filter-form');
      const formData = new FormData(form);
      const urlParams = new URLSearchParams(window.location.search);

      // Adiciona os dados do formulário aos parâmetros da URL
      for (const [key, value] of formData.entries()) {
        urlParams.set(key, value);
      }

      // Cria a URL final
      const newUrl = `${window.location.pathname}?${urlParams.toString()}`;

      // Redireciona para a nova URL
      window.location.href = newUrl;
    },
},
});
</script>
{% endblock js-additional %}