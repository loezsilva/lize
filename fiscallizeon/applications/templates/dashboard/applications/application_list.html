{% extends 'redesign/base.html' %}
{% comment %} {% extends 'dashboard/base_fixed.html' %} {% endcomment %}
{% load permissions %}
{% load static %}
{% load get_answer_sheet_link %}
{% load getlist %}
{% load cdn_url %}

{% block title %}Listagem de aplicações - Lize{% endblock title %}

{% block css-additional %}
<link href="{% static 'administration/lib/select2/css/select2.min.css' %}" rel="stylesheet" />

<!-- <link href="{% static 'administration/lib/bootstrap-tagsinput/bootstrap-tagsinput.css' %}" rel="stylesheet"> -->

<style>
  .select2-selection__choice__remove{
    display: none !important;
  }
  .column-300 {
    max-width: 400px;
  }
  #blocked:hover { /* round facebook icon*/
    background: #dc3545;
    border: 1px solid #dc3545;
  }
  #unlock:hover { /* round facebook icon*/
    background: #009ede;
    border: 1px solid #009ede;
  }
</style>
{% endblock %}

{% comment %}
{% block breadcrumb-fixed %}
  <div class="d-sm-flex align-items-center justify-content-between mg-b-20 mg-lg-b-25 mg-xl-b-10">
    <div>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb breadcrumb-style1 mg-b-10">
          <li class="breadcrumb-item"><a href="#">APLICAÇÕES</a></li>
          <li class="breadcrumb-item active" aria-current="page">LISTAGEM</li>
        </ol>
      </nav> 
      <h4>Suas aplicações</h4>
    </div>
    <div class="d-none d-md-block">
        <a href="{% url 'applications:applications_create' %}" class="btn btn-sm pd-x-15 btn-primary btn-uppercase">
            <i data-feather="plus" class="wd-10 mg-r-5"></i> Agendar aplicação
        </a>
        <a href="{% url 'applications:applications_create_multiple' %}" class="btn btn-sm pd-x-15 btn-primary btn-uppercase">
            <i data-feather="plus" class="wd-10 mg-r-5"></i> Agendar várias aplicações
        </a>
    </div>
  </div>
{% endblock breadcrumb-fixed %}
{% endcomment %}

{% block top-menu %}
  {% if request.resolver_match.url_name == 'applications_list' and request.GET.category == 'online' or request.GET.category == 'homework' %}
    <header>
      <nav class="ls add afa agv arx" style="display: flex; overflow-x: auto; border-width: 0px; border-style: solid; border-color: rgb(229, 231, 235); border-bottom-width: 1px; border-color: #E2E5ED; padding-top: 1rem; padding-bottom: 1rem;">
        <ul role="list" class="ls tn uj aad ard avv awb awk axk cer dcv" style="list-style: none; margin: 0px; min-width: 100%; flex: 0 0 auto; column-gap: 1.5rem; font-size: 0.875rem; line-height: 1.5rem; font-weight: 500;">
          <li>
            <a href="{% url 'applications:applications_list' %}?category=online" class="axz font-display" style="{% if request.resolver_match.url_name == 'applications_list' and request.GET.category == 'online' %}color: #FEA464;{% else %}color: #9CA3AF;{% endif %}">
              Prova
            </a>
          </li>
          <li>
            <a href="{% url 'applications:applications_list' %}?category=homework" class="font-display" style="{% if request.resolver_match.url_name == 'applications_list' and request.GET.category == 'homework' %}color: #FEA464;{% else %}color: #9CA3AF;{% endif %}">
              Lista de Exercício
            </a>
          </li>
        </ul>
      </nav>
    </header>
  {% endif %}
{% endblock top-menu %}

{% block content-fixed %}
<div class="ard cer dcv tw-mb-16">
  <div class="ls" style="margin-top: 1.25rem; margin-bottom: 1rem; justify-content: space-between;">
    {% include "dashboard/breadcrumb-year.html" with year=year|force_escape %}
    {% if user|has_perm:'applications.add_application' %}
      <div>
        <a href="{% url 'applications:applications_create' %}?category={{category}}" class="btn btn-sm pd-x-15 btn-primary btn-uppercase">
          <i data-feather="plus" class="wd-10 mg-r-5"></i> Agendar aplicação
        </a>
        <a href="{% url 'applications:applications_create_multiple' %}?category={{category}}" class="btn btn-sm pd-x-15 btn-primary btn-uppercase ml-2">
          <i data-feather="plus" class="wd-10 mg-r-5"></i> Agendar várias aplicações
        </a>
      </div>
    {% endif %}
  </div>
<div class="row">
    <div class="col-md-12">
        <div class="card mg-b-10">
            <div class="card-header pd-t-20 d-sm-flex align-items-start justify-content-between bd-b-0 pd-b-0">
              
              <div>
                <h6 class="mg-b-5">Aplicações</h6>
                <p class="tx-13 tx-color-03 mg-b-5">Gerencie todas as suas aplicações listadas abaixo</p>
              </div>
              
              <div class="float-right text-right">

                <button data-toggle-off-canvas="#right-off-canvas"
                  class="btn btn-sm btn-info btn-icon rounded-pill off-canvas-menu  mb-2">
                  <i class="fas fa-search"></i> Filtrar listagem 
                  
                  {% if count_filters > 0 %}
                  <span class="badge badge-danger">{{count_filters}} Aplicado(s)</span>
                  {% endif %}

                </button>
                {% if count_filters > 0 %}
                <a href="{% url 'applications:applications_list' %}?year={{year|force_escape}}&category={{category}}"
                  class="btn btn-sm btn-info btn-icon rounded-pill mb-2">
                  <i class="fas fa-eraser"></i> Apagar filtro(s)
                </a>
                {% endif %}
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-dashboard mg-b-1">
                <thead>
                  <tr>
                    <th>Quando</th>
                    <th>Prova/Turmas</th>
                    {% if user_type != 'teacher' %}
                      <th>Fiscais</th>
                    {% endif %}
                    <th></th>
                    <th class="text-wrap"></th>
                  </tr>
                </thead>
                <tbody>                  
                  <tr v-for="application in applications">
                    <td class="tx-medium">  
                        <div>  
                          <span v-if="application.duplicate_application" class="badge badge-secondary">
                            <i class="fas fa-lock"></i> Aplicação Bloqueada 
                          </span>
                        </div>                     
                        ${ momentRef(application.date).format('DD/MM/YYYY') } <br/>
                        <span class="text-muted">${ application.start.slice(0,5) } até ${application.end.slice(0,5) }</span>
                        <br>
                        <kbd v-if="isApplicationDisclosable(application)" class="p-0 bg-transparent text-dark">
                          Divulgação:
                          <template v-if="application.releaseResultAtEnd">
                            Ao finalizar
                          </template>
                          <template v-else>
                            ${ momentRef(application.studentStatsPermissionDate).format('DD/MM/YYYY') }
                          </template>
                        </kbd>
                        <kbd v-else-if="application.studentStatsPermissionDate == today" class="p-0 bg-transparent text-info">Divulgada Hoje</kbd>
                        <kbd v-else class="p-0 bg-transparent text-success">Resultado Divulgado</kbd>
                    </td>
                    <td class="column-300">                      
                      <span v-if="application.category == 2" class="badge badge-primary">Online</span>
                      <span v-if="application.category == 3" class="badge badge-success">Presencial</span>
                      <span v-if="application.category == 4" class="badge badge-success">Lista de Exercício</span>
                      <p class="mb-0">${ application.exam }</p>                
                      <span                          
                        v-for="schoolClass in application.schoolClasses" 
                        class="badge badge-light mr-1">
                          ${ schoolClass }
                      </span>
                      <span v-if="application.schoolClasses.length == 0" class="badge badge-light">
                        ${ application.studentsCount } aluno(s) avulso(s)
                      </span>
                    </td>
                    {% if user_type != 'teacher' %}
                      <td class=" tx-pink column-300">
                        <span v-if="application.inspectors.length > 0">
                          <span  v-for="inspector in application.inspectors"
                            class="badge badge-light mr-1">
                            ${ inspector }
                          </span>
                        </span>
                        <span v-else>
                          -
                        </span>
                      </td>
                    {% endif %}
                    <td>
                      <template v-if="application.category == 3">
                        <template v-if="application.sheetsExportingStatus === 1">
                          Gerando cartões... 
                          <i class="fas fa-spinner fa-spin text-primary"></i>
                          <div class="progress">
                            <div
                                class="progress-bar bg-primary progress-bar-striped progress-bar-animated" 
                                role="progressbar"
                                :style="{ width: application.sheetsExportingProgress + '%' }">
                            </div>
                          </div>
                        </template>
                        <span 
                          v-else-if="application.sheetsExportingStatus == 2 && application.answerSheetUrl"
                        >
                          <a :href="application.answerSheetUrl" target="_blank">
                            <i class="fas fa-file-download"></i> Baixar folha de respostas
                          </a><br>
                          <span class="text-muted">Gerado ${ application.lastAnswerSheetGeneration }</span>
                        </span>
                        <span class="text-danger" v-else-if="application.sheetsExportingStatus == 3">
                          Erro na exportação                  
                        </span>
                      </template>
                      <p v-if="application.print_ready" class="rounded text-success tx-bold">Pronto para impressão <i class="fas fa-check">
                    </td>
                    <td class="text-wrap">
                      <div class="d-flex justify-content-end">
                        <div v-if="application.duplicate_application" class="dropdown">
                          <div class="dropdown mr-2">
                            <button id="blocked" v-if="momentRef(application.date + 'T' + application.start) < momentRef()" class="btn btn-secondary" type="button"
                              data-toggle="tooltip" data-placement="top" title="Não é possível desbloquear aplicação com data e hora anterior">
                              <i class="fas fa-ban"></i>
                            </button>
                            <button id="unlock" v-else class="btn btn-secondary" type="button" @click="getUnlockApplication(application)"
                              data-toggle="tooltip" data-placement="top" title="Desbloquear aplicação">
                              <i class="fas fa-lock-open"></i>
                            </button>
                          </div>
                        </div>
                        <div class="dropdown mr-2">
                          <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Opções
                          </button>
                          <div class="dropdown-menu" style="min-width: 230px;" aria-labelledby="dropdownMenuButton">
                            {% if user|has_perm:'applications.change_application' %}
                            <a :href="replaceUrlId(updateApplicationUrl, application.id)"
                              class="nav-link d-none d-sm-block" data-toggle="tooltip" data-placement="top"
                              title="Relatório">
                              <i class="fas fa-edit"></i> Editar
                            </a>
                            {% endif %}
                            {% if user|has_perm:'applications.can_add_and_remove_students' %}
                            <template v-if="application.examNotApplicable">
                              <a @click.prevent.default="alertExamNotApplicable()" href="#" class="nav-link d-none d-sm-block" data-toggle="tooltip" data-placement="top" title="Adiciona ou remove alunos desta aplicação">
                                <i class="fas fa-user-plus"></i> Adicionar ou remover alunos
                              </a>
                            </template>
                            <template v-else>
                              <a v-if="!application.is_printed && application.answerSheetUrl == ''" :href="replaceUrlId(addAndDeleteStudentUrl, application.id)" class="nav-link d-none d-sm-block" data-toggle="tooltip" data-placement="top" title="Adiciona ou remove alunos desta aplicação">
                                <i class="fas fa-user-plus"></i> Adicionar ou remover alunos
                              </a>
                              <a v-else @click.prevent.default="alertPrintedApplicationManageStudents()" href="#" class="nav-link d-none d-sm-block" data-toggle="tooltip" data-placement="top" title="Adiciona ou remove alunos desta aplicação">
                                <i class="fas fa-user-plus"></i> Adicionar ou remover alunos
                              </a>
                            </template>
                            {% endif %}
                            {% if user|has_perm:'applications.can_duplicate_application' %}
                              <a href="javascript:void(0)" class="nav-link d-none d-sm-block" @click="getDuplicateAplication(application)" data-toggle="tooltip" data-placement="top" title="Duplicar Aplicação">
                                <i class="far fa-copy"></i> Duplicar Aplicação
                              </a>
                            {% endif %}

                            <a :href="replaceUrlId(detailsApplicationUrl, application.id)"
                              class="nav-link d-none d-sm-block" data-toggle="tooltip" data-placement="top"
                              title="Relatório">
                              <i class="fas fa-chart-bar"></i> Detalhes
                            </a>
                            {% if user|has_perm:'applications.change_application' %}
                              <a v-if="!application.is_printed && application.answerSheetUrl == ''" href="javascript:void(0)" class="nav-link d-none d-sm-block" 
                              @click="confirmCancel(replaceUrlId(deleteApplicationUrl, application.id))" 
                              data-toggle="tooltip" data-placement="top" title="Deletar">
                                <i class="fas fa-trash"></i> Apagar
                              </a>  
                            {% endif %}
                            {% if user|has_perm:'applications.delete_application' %}
                            
                              <a v-else href="javascript:void(0)" class="nav-link d-none d-sm-block"
                              @click="alertPrintedApplicationDelete()" 
                              data-toggle="tooltip" data-placement="top" title="Deletar">
                                <i class="fas fa-trash"></i> Apagar
                              </a>
                            {% endif %}
                            {% if user|has_perm:'applications.can_remove_generated_bag' %}
                              <a v-if="!application.category != 3 && !application.is_printed && application.answerSheetUrl != ''" href="javascript:void(0)" class="nav-link d-none d-sm-block" 
                              @click="alertBagDelete(application)"
                              data-toggle="tooltip" data-placement="top" title="Remover Malote">
                                <i class="fas fa-times"></i> Remover malote gerado
                              </a>  
                            {% endif %}
                            {% if user|has_perm:'applications.can_disclose_application' %}
                              <a 
                                href="#" 
                                class="nav-link d-none d-sm-block" 
                                v-if="isApplicationDisclosable(application)"
                                @click.prevent.default="confirmCancel(replaceUrlId(discloseApplicationUrl, application.id))"
                                data-toggle="tooltip" data-placement="top" title="Divulgar resultado imediatamente"
                              >
                                <i class="fas fa-bullhorn"></i> Divulgar Resultado
                              </a>                        
                            {% endif %}
                          </div>
                        </div>
                        {% if user.client_has_omr %}
                        <template v-if="application.examNotApplicable">
                          {% if user|has_perm:'applications.can_print_bag_application' %}
                          <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" @click.prevent.default="alertGenerateBagExamNotApplicable()">
                              <i class="fas fa-print"></i>
                            </button>
                          </div>
                          {% endif %}
                        </template>
                        <template v-else>
                          {% if user|has_perm:'applications.can_print_bag_application' %}
                            <div class="dropdown">
                              <button class="btn btn-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" :disabled="application.category != 3">
                                <i class="fas fa-print"></i>
                              </button>
                              <div class="dropdown-menu" x-placement="bottom-start">
                                <h6 class="dropdown-header tx-uppercase tx-11 tx-bold tx-inverse tx-spacing-1">Geração de malote de provas</h6>
                                <a href="javascript:void(0)" class="dropdown-item" @click="changePrintReady(application)">
                                  <span v-if="application.print_ready"><i class="far fa-square"></i> Desmarcar como pronto para impressão</span>
                                  <span v-else><i class="fa fa-check-double"></i> Marcar como pronto para impressão</span>
                                </a>
                                <template v-if="!application.print_ready">
                                  <a class="dropdown-item nav-link" href="#" @click.prevent.default="showPrintModal(application)">
                                    <i class="fas fa-copy"></i> Todos os alunos
                                  </a>
                                  <div class="dropdown-divider"></div>
                                </template>
                                  <h6 class="dropdown-header tx-uppercase tx-11 tx-bold tx-inverse tx-spacing-1">Folha de respostas avulsa</h6>
                                  <a class="dropdown-item nav-link" href="#" @click.prevent.default="showPrintDetachedModal(application)">
                                    <i class="fas fa-file-pdf"></i> Nominal ou avulsa
                                  </a>

                                  {% if 10 in user.client_omr_categories_sequentials %}
                                  <div class="dropdown-divider"></div>
                                  <h6 class="dropdown-header tx-uppercase tx-11 tx-bold tx-inverse tx-spacing-1">Exportar folhas de resposta ELIT</h6>
                                  <a class="dropdown-item nav-link" href="#" @click.prevent.default="generateElitExamsBag(application)">
                                    <i class="fas fa-file-pdf"></i> Nominais
                                  </a>
                                  <a class="dropdown-item nav-link" href="#" @click.prevent.default="generateDetachedAnswerSheet(application, true)">
                                    <i class="fas fa-file-pdf"></i> Avulso
                                  </a>
                                  {% endif %}
                              </div>
                            </div>
                          {% endif %}
                        </template>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div><!-- table-responsive -->
        </div><!-- card -->
        {% include 'includes/pagination.html' with objects=object_list %}
    </div>
</div>
</div>

{% endblock content-fixed %}

{% block off-canvas %}
<div id="right-off-canvas" class="off-canvas off-canvas-right wd-400 bg-white"
  style="overflow-y: auto; overflow-x: hidden;">
  <form action="" method="GET">
  <div class="row p-3">
      <div class="col-12">
        <h5>Filtrar aplicações</h5>
        <p>Adiciona abaixo os filtros que você deseja aplicar na listagem abaixo</p>
        <hr/>
      </div>

      <div class="col-12">
        <div class="form-group mb-3">
          <label for="application_name_id" class="mb-1">Nome do caderno</label>
          <input type="text" value="{{q_name}}" id="application_name_id" name="q_name" class="form-control" placeholder="Digite o nome do caderno aqui">
        </div>
      </div>

      <div class="col-6">
        <div class="form-group mb-3">
          <label for="initial_date" class="mb-1">Data Inicial</label>
          <input type="date" value="{{q_initial_date}}" id="initial_date" name="q_initial_date" class="form-control">
        </div>
      </div>

      <div class="col-6">
        <div class="form-group mb-3">
          <label for="final_date" class="mb-1">Data Final</label>
          <input type="date" value="{{q_final_date}}" id="final_date" name="q_final_date" class="form-control">
        </div>
      </div>
      
      {% if user.client_has_exam_elaboration %}
        <div class="col-12">
          <div class="form-group mb-3">
            <label for="id_category" class="mb-1">Categoria</label>
            <select name="category" id="id_category" class="form-control">
                <option value=""></option>
                <option value="online" {% if category == 'online' %} selected="selected" {% endif %}>Online</option>
                <option value="presential" {% if category == 'presential' %} selected="selected" {% endif %}>Presencial</option>
                <option value="homework" {% if category == 'homework' %} selected="selected" {% endif %}>Lista de Exercício</option>
            </select>
          </div>
        </div>
      {% endif %}

      <div class="col-12">
        <div class="form-group mb-3">
          <label for="subject_id" class="mb-1">Disciplina</label>
          <select name="q_subjects" id="subject_id" class="form-control" multiple="multiple">
            {% for subject in subjects %}
              <option value="{{subject.pk}}" {% if subject.pk|stringformat:'s' in q_subjects %} selected="selected" {% endif %}>
                {{subject.name}} > {{subject.knowledge_area__name}}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="col-12">
        <div class="form-group mb-3">
          <label for="classe_id" class="mb-1">Turmas</label>
          <select name="q_classes" id="classe_id" class="form-control" multiple="multiple">
            {% for classe in classes %}
              <option value="{{classe.pk}}" {% if classe.pk|stringformat:'s' in q_classes %}selected="selected" {% endif %}>
                {{classe.name}} - {{ classe.coordination__unity__name }}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="col-12">
        <div class="form-group mb-3">
          <label for="grade_id" class="mb-1">Séries</label>
          <select name="q_grades" id="grade_id" class="form-control" multiple="multiple">
            {% for grade in grades %}
              <option value="{{grade.pk}}" {% if grade.pk|stringformat:'s' in q_grades %} selected="selected" {% endif %}>
                {{grade}}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="col-12">
        <div class="custom-control custom-switch ">
          <input {% if q_already_disclosed %}checked="checked"{% endif %} type="checkbox" id="already_disclosed_id" name="q_already_disclosed" class="custom-control-input">
          <label class="custom-control-label" for="already_disclosed_id">Resultado divulgado</label>
          <small class="form-text text-muted mt-0">Selecine caso queira ver apenas aplicações que o resultado já foi divulgado.</small>
        </div>
      </div>

      <div class="col-12">
        <div class="custom-control custom-switch ">
          <input {% if q_no_disclosed %}checked="checked"{% endif %} type="checkbox" id="no_disclosed_id" name="q_no_disclosed" class="custom-control-input">
          <label class="custom-control-label" for="no_disclosed_id">Resultado não divulgado</label>
          <small class="form-text text-muted mt-0">Selecine caso queira ver apenas aplicações que o resultado ainda não foi divulgado.</small>
        </div>
      </div>

      <div class="col-12 mt-5">
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-search"></i>
          Aplicar filtro
        </button>
      </div>
  </div>
  <input type="hidden" value="{{year|force_escape}}" name="year">
  </form>
</div>
{% endblock %}

{% block extra-modal %}
  {% include 'includes/confirm_modal.html' %}

  <div class="modal fade" id="configureDetachedSheetModal" role="dialog" tabindex="-1">
    <div class="modal-dialog modal-md modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Configure a impressão da folha de respostas avulsa</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" style="max-height: fit-content; height: fit-content;">
          <div class="form-group">
            <h6> Modelo da folha de resposta:</h6>
            <div v-if="selectedApplication && selectedApplication.hasSumQuestions" class="btn-group btn-group-toggle">
              <label class="btn btn-outline-primary btn-lg active">
                <input type="radio" name="sum" value="sum" v-model="answer_sheet_model">
                <i class="fas fa-file fa-lg"></i>
                <span>
                    Modelo somatório
                </span>
              </label>
            </div>
            <div v-else class="btn-group btn-group-toggle">
                <label class="btn btn-outline-primary btn-lg" :class="{active: answer_sheet_model == 'fiscallize'}">
                  <input type="radio" name="enem" value="fiscallize" v-model="answer_sheet_model">
                  <i class="fas fa-file fa-lg"></i>
                  <span>
                    Lize
                  </span>
                </label>
                <label class="btn btn-outline-primary btn-lg" :class="{active: answer_sheet_model == 'enem'}">
                  <input type="radio" name="enem" value="enem" v-model="answer_sheet_model">
                  <i class="fas fa-file fa-lg"></i>
                  <span>
                    ENEM
                  </span>
                </label>
                {% if user.client_has_hybrid_omr %}
                <label class="btn btn-outline-primary btn-lg" :class="{active: answer_sheet_model == 'hybrid'}">
                  <input type="radio" name="enem" value="hybrid" v-model="answer_sheet_model">
                  <i class="fas fa-file fa-lg"></i>
                  <span>
                    Híbrido
                  </span>
                </label>
                {% endif %}
                {% if user.client_has_discursive_omr %}
                <label class="btn btn-outline-primary btn-lg" :class="{active: answer_sheet_model == 'discursive'}">
                  <input type="radio" name="enem" value="discursive" v-model="answer_sheet_model">
                  <i class="fas fa-file fa-lg"></i>
                  <span>
                    Discursivo
                  </span>
                </label>
                {% endif %}
            </div>
          </div>
        
          <div class="form-group">
            <h6>Selecione um aluno caso deseje que a folha de respostas gerada seja nominal:</h6> 
            <div class="d-flex align-items-center">
              <select
                  id="student-detached"
                  class="form-control"
              >
              </select>
            </div>
          </div>
          
        </div>
        <div class="modal-footer">
            <div class="form-buttons-w text-right">
              <button v-if="loadingDetached" class="btn btn-primary disable" disabled="disabled">
                <i class="os-icon os-icon-check"></i>
                <span><i class="fas fa-spinner fa-spin"></i> Imprimindo folha de respostas</span>
              </button>
              <button v-else class="btn btn-primary not-disable" @click="generateDetachedAnswerSheet(selectedApplication)">
                <i class="os-icon os-icon-check"></i>
                <span>Imprimir folha de respostas</span>
              </button>
            </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="configurePrintModal" role="dialog" tabindex="-1">
    <div class="modal-dialog modal-md modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Configure a impressão do malote nesta exportação</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" style="max-height: fit-content; height: fit-content;">
          <div class="form-group">
            <h6>Folhas de resposta objetivas:</h6>
            <template v-if="selectedApplication"> 
              <div v-if="selectedApplication.hasSumQuestions" class="btn-group btn-group-toggle">
                <label class="btn btn-outline-primary btn-lg active">
                  <input type="radio" name="sum" value="sum" v-model="answer_sheet_model">
                  <i class="fas fa-file fa-lg"></i>
                  <span>
                      Modelo somatório
                  </span>
                </label>
              </div>

              <div v-else class="btn-group btn-group-toggle">
                  <label class="btn btn-outline-primary btn-lg" :class="{active: answer_sheet_model == 'fiscallize'}">
                    <input type="radio" name="enem" value="fiscallize" v-model="answer_sheet_model">
                    <i class="fas fa-file fa-lg"></i>
                    <span>
                        Modelo Lize
                    </span>
                  </label>
                  <label class="btn btn-outline-primary btn-lg" :class="{active: answer_sheet_model == 'enem'}">
                      <input type="radio" name="enem" value="enem" v-model="answer_sheet_model">
                      <i class="fas fa-file fa-lg"></i>
                      <span>
                      Modelo ENEM
                      </span>
                  </label>
                  {% if user.client_has_hybrid_omr %}
                  <label class="btn btn-outline-primary btn-lg" :class="{active: answer_sheet_model == 'hybrid'}">
                    <input type="radio" name="hybrid" value="hybrid" v-model="answer_sheet_model">
                    <i class="fas fa-file fa-lg"></i>
                    <span>
                    Modelo Híbrido
                    </span>
                  </label>
                  {% endif %}
              </div>
            </template>
          </div>
        
          <div class="form-group">
            <input type="checkbox" name="blank-pages" v-model="blank_pages" :checked="!blank_pages" id="blank-pages">
            <label class="mb-0" for="blank-pages">Impressão frente e verso</label>
            <small class="form-text text-muted mt-0 mb-2" style="line-height: initial;">
              Marque esta opção caso deseje exportar o arquivo do malote para ser impresso em modo frente e verso (folha em branco após as folhas de respostas e listas).
            </small>
          </div>
          {% if has_discursives %}
            <div class="form-group">
              <input type="checkbox" name="print-discursives" v-model="includeDiscursives" :checked="!includeDiscursives" id="print-discursives">
              <label class="mb-0" for="print-discursives">Incluir folhas de respostas discursivas</label>
              <small class="form-text text-muted mt-0 mb-2" style="line-height: initial;">
                Marque esta opção caso deseje exportar as folhas de resposta discursivas.
              </small>
            </div>

            <template v-if="includeDiscursives">
              <h6 class="mt-3">Separar disciplinas:</h6>
              <div class="btn-group btn-group-toggle" data-toggle="buttons">
                <label class="btn btn-outline-primary btn-lg" :class="{'active': !discursiveOptions.split_subjects }" @click="discursiveOptions.split_subjects = false">
                  <input type="radio" name="split_subjects" id="split_subjects_false" value="0" autocomplete="off" :checked="!discursiveOptions.split_subjects">
                    <i class="fas fa-times fa-lg"></i>
                  Não
                </label>
                <label class="btn btn-outline-primary btn-lg" :class="{'active': discursiveOptions.split_subjects }" @click="discursiveOptions.split_subjects = true">
                  <input type="radio" name="split_subjects" id="split_subjects_true" value="1" autocomplete="off" :checked="discursiveOptions.split_subjects">
                  <i class="fas fa-check fa-lg"></i>
                  Sim, separar!
                </label>
              </div>
              <small class="form-text text-muted mt-0 mb-3">
                Marque esta opção se deseja separar as folhas de respostas discursivas por disciplina
              </small>
            </template>
          {% endif %}
          {% if exam_custom_pages %}
            <h6>Página customizada:</h6>
            <select name="custom_page" id="id_custom_page" class="form-control" multiple>
                {% for custom_page in exam_custom_pages %}
                    <option value="{{custom_page.id}}">{{custom_page.name}} - {{custom_page.get_location_display}}</option>
                {% endfor %}
            </select>
          {% endif %}
          {% if user.client_has_exam_elaboration %}
          <template v-if="selectedApplication && !selectedApplication.abstractExam">
            <div class="form-group mt-3">
              <input type="checkbox" name="print-exam" v-model="includeExams" :checked="!includeExams" id="print-exam">
              <label class="mb-0" for="print-exam">Incluir cadernos de prova</label>
              <small class="form-text text-muted mt-0 mb-2" style="line-height: initial;">
                Marque esta opção caso deseje exportar os cadernos de prova além das folhas de resposta.
              </small>
            </div>
            <template v-if="includeExams">
              <div class="alert alert-warning">
                <span class="font-weight-bold">Atenção!</span> Caso a prova esteja marcada com parâmetros de randomização de questões ou alternativas, os alunos terão cadernos de prova distintos entre si. Além disso, caso esteja utilizando cabeçalhos customizados, ao menos o parâmetro <span class="font-weight-bold">#NomeDoAluno</span> deve estar cadastrado.
              </div>
              {% include 'dashboard/exams/includes/exam/print/modal_print.html' %}
            </template>
          </template>
          {% endif %}
        </div>
        <div class="modal-footer">
            <div class="form-buttons-w text-right">
              <button class="btn btn-primary not-disable" @click="generateExamsBag(selectedApplication)">
                <i class="os-icon os-icon-check"></i>
                <span>Imprimir malote</span>
              </button>
            </div>
        </div>
      </div>
    </div>
  </div>
{% endblock extra-modal %}

{% block js-additional %}
<script src="{% static 'administration/lib/bootstrap-tagsinput/bootstrap-tagsinput.min.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.26.0/moment-with-locales.min.js"></script>
<script src="{% static 'administration/lib/select2/js/select2.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
<script>

  var app = new Vue({
    delimiters: ['${', '}'],
    el: '#app',
    data: {
      today: "{% now 'Ymd' %}",
      selectedApplication: null,
      selectedDetachedStudent: '',
      loadingDetached: false,
      answer_sheet_model: "fiscallize",
      blank_pages: false,
      includeDiscursives: false,
      includeExams: false,
      discursiveOptions: {
        split_subjects: 0,
      },
      examPrintConfigObject: {
        header: '',
        backgroundImage: '',
        customPages: [],
        headerFormat: 1,
        columnType: 0,
        kind: 0,
        textQuestionFormat: 1,
        lineHeight: 0,
        fontSize: 0,
        fontFamily: 0,
        printSubjectsName: false,
        printWithCorrectAnswers: false,
        hideAlternativesIndicator: false,
        hideQuestionsReferencies: false,
        hideKnowledgeAreasName: false,
        printBlackAndWhiteImages: false,
        hyphenate: false,
        discursiveLineHeight: 1,
        breakAlternatives: false,
      },
      examPrintConfig: {},
      printDefaults: [],
      addAndDeleteStudentUrl: "{% url "applications:applications_add_del_student" '00000000-0000-0000-0000-000000000000' %}",
      deleteApplicationUrl: "{% url "applications:applications_delete" '00000000-0000-0000-0000-000000000000' %}",
      detailsApplicationUrl: "{% url "applications:applications_detail" '00000000-0000-0000-0000-000000000000' %}",
      updateApplicationUrl: "{% url "applications:applications_update" '00000000-0000-0000-0000-000000000000' %}",
      discloseApplicationUrl: "{% url "applications:applications_disclose" '00000000-0000-0000-0000-000000000000' %}",
      exportExamsBag: "{% url "applications:export_application_exams_bag" pk="00000000-0000-0000-0000-000000000000" %}",
      exportDetachedAnswerSheetUrl: "{% url "omr:export_answer_sheet_application_detached" '00000000-0000-0000-0000-000000000000' %}",
      exportDetachedElitAnswerSheetUrl: "{% url "omr:export_elit_answer_sheet_detached" '00000000-0000-0000-0000-000000000000' %}",
      exportElitExamsBag: "{% url "applications:export_application_elit_exams_bag" pk="00000000-0000-0000-0000-000000000000" %}",
      {% if has_discursives %}
        exportDetachedDiscursiveAnswerSheetUrl: "{% url "omr:export_answer_sheet_discursive_detached" '00000000-0000-0000-0000-000000000000' %}",
      {% endif %}
      applications: [
        {% for application in object_list %}
          {
            "id": "{{ application.pk }}",
            "date": "{{ application.date|safe }}",
            "start": "{{ application.start|safe }}",
            "end": "{{ application.end|safe }}",
            "category": {{ application.category }},
            "subject": "{{ application.subject }}",
            "studentStatsPermissionDate": "{{ application.student_stats_permission_date|safe }}",
            "exam": "{{ application.exam.name|safe }}",
            "hasSumQuestions": {{ application.exam.has_sum_questions|yesno:'true,false' }},
            "examNotApplicable": {{ application.exam.not_applicable|lower }},
            "abstractExam": {{ application.exam.is_abstract|default:False|lower }},
            "exam_urls": {{ application.exam.urls|safe }},
            "studentsCount": {{ application.students.count }},
            "answerSheetUrl": "{{ application|default_if_none:''|get_answer_sheet_link|cdn_url|safe }}",
            "lastAnswerSheetGeneration": moment("{{ application.last_answer_sheet_generation|safe }}").locale('pt-br').fromNow(),
            "schoolClasses": [
              {% for school_class in application.get_classes %}
                "{{ school_class.name }} - {{ school_class.coordination_unity_name }}",
              {% endfor %}
            ],
            "inspectors": [
              {% for inspector in application.inspectors.all %}
                "{{ inspector.name }}",
              {% endfor %}
            ],
            "sheetsExportingStatus": {{ application.sheet_exporting_status }},
            "sheetsExportingCount": {{ application.sheet_exporting_count }},
            "sheetsExportingProgress": 0,
            "duplicate_application": "{{application.duplicate_application|default:''}}",
            "is_printed": {{ application.is_printed|default:False|lower }},
            "print_ready": {{ application.print_ready|default:False|lower }},
            "urls": {{ application.urls|safe }},
            "releaseResultAtEnd": {{ application.release_result_at_end|default:False|lower }},
          },
        {% endfor %}
      ],
      loadedPrintDefaults: false,
    },
    methods: {
      momentRef(args) {
        return moment(args)
      },
      confirmCancel(url) {
        document.getElementById('id_confirm_cancel_form').action = url;
        $("#confirmCancelModal").modal("show");
      },
      alertBagDelete(application){
        Swal.fire({
          title: 'Deseja realmente remover o malote?',
          text: 'Certifique-se de que ele não foi impresso e não será aplicado aos alunos.',
          icon: 'error',
          showDenyButton: true,
          showCancelButton: true,
          confirmButtonText: 'Confirmar',
          cancelButtonText: 'Cancelar',
        }).then((result) => {
          if (result.isConfirmed) {
            axios.post(application.urls.remove_application_exam_bag).then((res) => {
              window.location.reload()
            })
          }
        })
      },
      alertPrintedApplicationDelete(){
        Swal.fire({
          title: 'Não é possível remover essa aplicação',
          text: 'Aplicações com malotes gerados não podem ser removidas',
          icon: 'error',
          confirmButtonText: 'Voltar',
        })
      },
      alertPrintedApplicationManageStudents(){
        Swal.fire({
          title: 'Não é possível modificar os alunos dessa aplicação',
          text: 'Aplicações com malotes gerados não podem sofrer alterações de alunos',
          icon: 'error',
          confirmButtonText: 'Voltar',
        })
      },
      alertExamNotApplicable() {
        Swal.fire({
          title: 'Não é possível modificar os alunos dessa aplicação',
          text: 'O caderno dessa aplicação está marcado como não aplicável.',
          icon: 'warning',
          confirmButtonText: 'Voltar',
        })
      },
      alertGenerateBagExamNotApplicable() {
        Swal.fire({
          title: 'Não é possível gerar malote',
          text: 'O caderno dessa aplicação está marcado como não aplicável.',
          icon: 'warning',
          confirmButtonText: 'Voltar',
        })
      },
      changePrintReady(application) {
        let url = application.urls.api_change_print_ready
        axios.post(url, {}).then((response) => {
          this.alertTop('Prova marcada como pronta para impressão.')
          window.location.reload()
        }).catch((e) => {
          this.alertTop('Ocorreu um erro ao tentar alterar a prova, tente novamente, caso o erro persista entre em contato com o suporte.', 'error')
        })
      },
      selectPrintDefault() {
        const id = $(this.$refs['inputPrintDefault']).children(":selected").attr("id")
        const printDefault = this.printDefaults.find(_default => _default.id == id)
        
        if(printDefault) {
          this.getConfig(printDefault).then((response) => {
            this.examPrintConfig = response.data
            this.selectedPrintDefault = response.data
            if(this.examPrintConfig.customPages.length) {
              $("#id_custom_page").val(this.examPrintConfig.customPages).trigger('change')
            }
          })
        } else { 
          if(this.examPrintConfig.customPages.length) {
            $("#id_custom_page").val([]).trigger('change')
          }
          this.selectedPrintDefault = null
          this.examPrintConfig = Object.assign({}, this.examPrintConfigObject)
        }
      },
      getConfig(printDefault) {
        return axios.get(printDefault.urls.getConfig)
      },
      replaceUrlId(url, applicationId) {
        return url.replace('00000000-0000-0000-0000-000000000000', applicationId)+'?{{ request.GET.urlencode|safe }}'
      },
      isApplicationDisclosable(application) {     
        return moment(application.studentStatsPermissionDate).format('YYYYMMDD') > this.today
      },
      showPrintModal(application) {
          this.includeExams = false
          this.selectedApplication = application
          $('#configurePrintModal').modal('show');
      },
      showPrintDetachedModal(application) {
          this.selectedApplication = application
          $('#configureDetachedSheetModal').modal('show');
      },
      generateDetachedAnswerSheet(application, isElit=false) {
        const self = this
        let url = this.replaceUrlId(this.exportDetachedAnswerSheetUrl, application.id)

        if (isElit) {
          url = this.replaceUrlId(this.exportDetachedElitAnswerSheetUrl, application.id)
        }

        if (application.hasSumQuestions) {
          self.answer_sheet_model = 'sum'
        }

        let formData = new FormData()
        formData.append('student_id', self.selectedDetachedStudent)
        formData.append('answer_sheet_model', self.answer_sheet_model)
        self.loadingDetached = true
        const oldApplicationStatus = application.sheetsExportingStatus
        application.sheetsExportingStatus = 1

        fetch(url, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
          },
          body: formData
        }).then(response => {
          const contentDisposition = response.headers.get('Content-Disposition')
          if (contentDisposition) {
              const match = contentDisposition.match(/filename="(.+)"/)
              if (match) {
                  fileName = match[1]
              }
          }
          return response.blob()
          .then(blob => {
              const blobUrl = URL.createObjectURL(blob)
              const a = document.createElement('a')
              a.style.display = 'none'
              a.href = blobUrl
              a.download = fileName

              document.body.appendChild(a)
              a.click()
              
              document.body.removeChild(a)
              URL.revokeObjectURL(blobUrl)
              self.loadingDetached = false
              application.sheetsExportingStatus = oldApplicationStatus
              $('#configureDetachedSheetModal').modal('hide')
          })
        })
      },
      generateExamsBag(application) {
        let self=this
        let url = this.replaceUrlId(this.exportExamsBag, application.id)

        if (application.hasSumQuestions) {
          self.answer_sheet_model = 'sum'
        }
        
        axios.post(url, {
          sheet_model: this.answer_sheet_model,
          discursive_params: this.discursiveOptions,
          exam_params: this.examPrintConfig,
          include_exams: this.includeExams,
          include_discursives: this.includeDiscursives,
          blank_pages: this.blank_pages,
        }).then((response) => {
          application.sheetsExportingStatus = 1
          application.sheetsExportingCount += 1
          $('#configurePrintModal').modal('hide');
          self.fetchStatus(application)
        }).catch((error) => {
          console.log(error)
          Swal.fire({
            position: 'top-end',
            icon: 'error',
            text: error.response.data,
            showConfirmButton: false,
            timer: 3000,
            backdrop: false,
            allowOutsideClick: false,
            timerProgressBar: true,
          })
        })
      },
      generateElitExamsBag(application) {
        let self = this
        let url = this.replaceUrlId(this.exportElitExamsBag, application.id)
        
        axios.post(url, {})
        .then((response) => {
          application.sheetsExportingStatus = 1
          application.sheetsExportingCount += 1
          self.fetchStatus(application)
        }).catch((error) => {
          console.log(error)
          Swal.fire({
            position: 'top-end',
            icon: 'error',
            text: error.response.data,
            showConfirmButton: false,
            timer: 3000,
            backdrop: false,
            allowOutsideClick: false,
            timerProgressBar: true,
          })
        })
      },
      fetchStatus(application){
          let self=this
          let url = "{% url 'omr:omr_export_task_status' '00000000-0000-0000-0000-000000000000' 9999 %}"
          url = url.replace('9999', application.sheetsExportingCount)
          url = url.replace('00000000-0000-0000-0000-000000000000', application.id)
          fetch(url)
          .then(response => response.json())
          .then(data => {
            switch (data.status) {
              case 'PENDING':
                setTimeout(() => self.fetchStatus(application), 10000)
                break
              case 'STARTED':
                application.sheetsExportingProgress = Math.round(data.percent * 100)
                setTimeout(() => self.fetchStatus(application), 10000)
                break
              case 'SUCCESS':
                application.sheetsExportingStatus = 2
                application.answerSheetUrl = data.application.answer_sheet
                application.lastAnswerSheetGeneration = moment().fromNow()
                break
              case 'FAILURE':
                application.sheetsExportingStatus = 3
                break;
            }
          })
        },
      getUnlockApplication(application) {
          Swal.fire({
            title: 'Deseja desbloquear a aplicação?',
            showDenyButton: true,
            showCancelButton: true,
            confirmButtonText: 'Confirmar',
            cancelButtonText: 'Cancelar',
          }).then((result) => {
            if (result.isConfirmed) {
              url = '{% url 'applications:application_duplicate' pk='00000000-0000-0000-0000-000000000000'  %}'
              axios.patch(url.replace("00000000-0000-0000-0000-000000000000", application.id), {duplicate_application: false})
              .then((response) => {
                Swal.fire({
                  position: 'top-end',
                  text: 'Aplicação desbloqueada com sucesso!',
                  showConfirmButton: false,
                  timer: 1500,
                  backdrop: false,
                  allowOutsideClick: false,
                  timerProgressBar: true,
                })
                application.duplicate_application = false
              })
            } else if (result.isDenied) {
              Swal.fire('Changes are not saved', '', 'info')
            }
          })
        }, 
      getDuplicateAplication(application) {
        Swal.fire({
          title: `Aplicação ${moment(application.date).format('DD/MM/YYYY')}`,
          text: `Deseja realmente duplicar?`,
          showCancelButton: true,
          cancelButtonText: 'Cancelar',
          confirmButtonText: 'Confirmar',
          animation: "slide-from-top",
          {% comment %}
          inputAttributes: {
            min: 1,
            max: 50
          },
          inputValue: 1,
          input: 'number'
          {% endcomment %}
        }).then((result) => {
          if (result.value) {
            let amountDuplicate = 1
            url = `{% url 'applications:application_duplicate' pk='00000000-0000-0000-0000-000000000000'  %}?amount=${amountDuplicate}`
            axios.get(url.replace("00000000-0000-0000-0000-000000000000", application.id)
            ).then((response) => {
              response.data.map((application) => this.applications.unshift(application))
              
              Swal.fire({
                position: 'top-end',
                text: 'Aplicação duplicada com sucesso!',
                showConfirmButton: false,
                timer: 1500,
                backdrop: false,
                allowOutsideClick: false,
                timerProgressBar: true,
              })
            })
            
          }
        })
      },
      alertTop(text, icon = 'success') {
        Swal.fire({
          position: 'top-end',
          text: text,
          icon: icon,
          showConfirmButton: false,
          timer: 1500,
          toast: true,
          timerProgressBar: true,
        })
      },
      getExamPrintConfigs(url) {
        return axios.get(url).then((response) => {
          this.examPrintConfig = response.data
          if($("#id_custom_page").val().length) {
            this.examPrintConfig.customPages = $("#id_custom_page").val()
          }
        })
        return axios.get(url).then((response) => this.examPrintConfig = response.data)
      },
      exportDetachedAnswerSheet(url, type) {
        return url.includes('?') ? `${url}&${type}=1`:`${url}?${type}=1`
      },
      getPrintDefaults() {
        axios.get("{% url 'api:clients:print-configs-list' %}").then((response) => {
          this.printDefaults = response.data
        }).finally(() => {
          this.loadedPrintDefaults = true
        })
      },
    },
    watch: {
      includeExams: function(val) {
        if(val) {
          if(!this.loadedPrintDefaults) {
            this.getPrintDefaults()
          }
          this.getExamPrintConfigs(this.selectedApplication.exam_urls.print_configs)
        }
      }
    },
    mounted: function(){   
      let self = this
      $('[data-toggle="tooltip"]').tooltip()
      
      const pendingExports = this.applications.filter(
        application => application.sheetsExportingStatus == 1
      )

      this.examPrintConfig = Object.assign({}, this.examPrintConfigObject)
      
      if(pendingExports) {
        pendingExports.map(function(application){
          self.fetchStatus(application)
        })
      }

      $('.off-canvas-menu').on('click', function (e) {
        e.preventDefault();
        var target = $(this).attr('data-toggle-off-canvas');
        $(target).addClass('show');
      });

      $('.off-canvas .close').on('click', function (e) {
        e.preventDefault();
        $(this).closest('.off-canvas').removeClass('show');
      })

      $(document).on('click touchstart', function (e) {
        if($(e.target).hasClass('select2-results__option') || $(e.target).hasClass('select2-results__custom_option')) {
          return
        }
        e.stopPropagation();

        if (!$(e.target).closest('.off-canvas-menu').length) {
          var offCanvas = $(e.target).closest('.off-canvas').length;
          if (!offCanvas) {
            $('.off-canvas.show').removeClass('show');
          }
        }
      });

      $('#status_id').select2({
        placeholder: "Selecione uma opção",
        closeOnSelect: false,
      });

      $('#id_custom_page').select2({
        placeholder: "Selecione uma opção",
        closeOnSelect: false,
        width: '100%',
      }).on('change', () => {
        this.examPrintConfig.customPages = $("#id_custom_page").val()
      })
    
      $('#classe_id').select2({
        placeholder: "Selecione uma opção",
        closeOnSelect: false,
      }).on('select2:selecting', function(e) {
        let cur = e.params.args.data.id;
        let old = (e.target.value == '') ? [cur] : $(e.target).val().concat([cur]);
        $(e.target).val(old).trigger('change');
        $(e.params.args.originalEvent.currentTarget).attr('aria-selected', 'true');
        return false;
      });
    
      $('#subject_id').select2({
        placeholder: "Selecione uma opção",
        closeOnSelect: false,
        templateResult: function (data, container) {
          let subject_name = data.text.split('>')[0]
          let knowledge_area_name = data.text.split('>')[1]
          return $(
            `<strong class="select2-results__custom_option">${subject_name}</strong> <br> <span class="select2-results__custom_option">${knowledge_area_name}</span>`
          );
        },
      }).on('select2:selecting', function(e) {
        let cur = e.params.args.data.id;
        let old = (e.target.value == '') ? [cur] : $(e.target).val().concat([cur]);
        $(e.target).val(old).trigger('change');
        $(e.params.args.originalEvent.currentTarget).attr('aria-selected', 'true');
        return false;
      });
    
      $('#grade_id').select2({
        placeholder: "Selecione uma opção",
        closeOnSelect: false,
      }).on('select2:selecting', function(e) {
        let cur = e.params.args.data.id;
        let old = (e.target.value == '') ? [cur] : $(e.target).val().concat([cur]);
        $(e.target).val(old).trigger('change');
        $(e.params.args.originalEvent.currentTarget).attr('aria-selected', 'true');
        return false;
      });
    
      $('.table-responsive').on('show.bs.dropdown', function () {
        $('.table-responsive').css( "overflow", "inherit" );
      });
      
      $('.table-responsive').on('hide.bs.dropdown', function () {
        $('.table-responsive').css( "overflow", "auto" );
      })

      $('#student-detached').select2({
          placeholder: 'Buscar pelo nome do aluno (opcional)...',
          minimumInputLength: 3,
          dropdownParent: $('#configureDetachedSheetModal'),
          allowClear: true,
          width: '100%',
          escapeMarkup: function (text) {
            return text
          },
          ajax: {
            url: '{% url "students:students_list_api" %}',
            delay: 250,
            data: function (params) {
                return {
                    search: params.term
                }
            },
            processResults: function(results) {
                let new_results = $.map(results, function(element) {
                  element.text = element.name
                  return element
                })
                
                return {
                    results: new_results,
                }
            }
          },
          templateSelection: (data) => {
            if(data.text) {
              result = `<span class="font-weight-bold "><span>${data.text}</span>`
        
                if (data.classes) {
                    result += "<p class='m-0'>"
                    data.classes.forEach(element => {
                    result += `<span class="badge badge-primary font-weight-bold mr-1">${element.name}</span>`
                    });
                    result += "</p>"
                }
                result += "</span>"
                return result
            } else {
                return "Buscar pelo nome do aluno..."
            }
          },
          templateResult: (data) => {
              if(data.text){
                  result = `
                      <span class="font-weight-bold">
                      <span class="mr-1">${data.text}</span>
                  `
          
              if (data.classes){
                  result += "<p class='m-0'>"
                  data.classes.forEach(element => {
                      result += `<span class="badge mr-1 badge-primary font-weight-bold">${element.name}</span>`
                  });
                  result += "</p>"
              }
              result += "</span>"
              return result
              } else {
                  return "Buscar pelo nome do aluno..."
              }
          }
    })

    $('#student-detached').on('change', (e) => {
      this.selectedDetachedStudent = e.target.value
    })

    },
  })

  // $(function () {
  //   'use strict'    
  // });

</script>
{% endblock %}
