{% extends 'dashboard/base_without_header.html' %}
{% load static %}
{% load compress %}
{% load remove_line_break %}

{% block title %}
  Lize - Sala de prova
{% endblock title %}


{% block css-additional %}
<style>
  *::-webkit-media-controls-panel {
    display: none!important;
    -webkit-appearance: none;
  }

  /* Old shadow dom for play button */

  *::-webkit-media-controls-play-button {
    display: none!important;
    -webkit-appearance: none;
  }

  /* New shadow dom for play button */

  /* This one works! */

  *::-webkit-media-controls-start-playback-button {
    display: none!important;
    -webkit-appearance: none;
  }

    #local-stream {
        position: fixed;
        right: 0;
        bottom: 0;
        min-width: 100%;
        min-height: 100%;
        max-width: 100%;
    }
    .content {
        position: fixed;
        bottom: 0;
        color: #f1f1f1;
        width: 100%;
        padding: 20px;
    }
    .btn-circle {
        width: 60px;
        height: 60px;
        padding: 6px 0px;
        border-radius: 30px;
        text-align: center;
        font-size: 12px;
        line-height: 1.42857;
        margin: 2px;
    }

    .modal-body{
      max-height: 70vh;
      height: 70vh;
      overflow: auto;
    }

    @media (max-width: 767px) {
  
      .modal-dialog {
        width: 100%;
        height: 100%;
        max-height: 100%;
        margin: 0;
        padding: 0;
        max-width: inherit !important; 
    }

    .modal-content {
        height: auto;
        min-height: 100%;
        max-height: 100%;
        overflow: auto;
        border-radius: 0;
        background: white;
        border: 0;
    }
    
    .modal-body{
        padding: 5px;
        padding-top: 65px;
        padding-bottom: 100px;

        max-height: inherit;
        height: inherit;
        overflow: auto;
    } 

    .modal-header{
      position: fixed;
      top: 0;
      right: 0;
      left: 0;
      z-index: 1030;
    }

    .modal-footer{
        position: fixed;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 1030;
    }
  
  }

    
    @keyframes fa-blink {
        0% { opacity: 1; }
        50% { opacity: 0.75; }
        100% { opacity: 0.4; }
    }
    .fa-blink {
        -webkit-animation: fa-blink 1.05s linear infinite;
        -moz-animation: fa-blink 1.05s linear infinite;
        -ms-animation: fa-blink 1.05s linear infinite;
        -o-animation: fa-blink 1.05s linear infinite;
        animation: fa-blink 1.05s linear infinite;
    }
    
  .notification {
    position: relative;
  }

  .notification .badge {
    position: absolute;
    top: -5px;
    right: -5px;
    border-radius: 100%;
    background: red;
    color: white;
    font-weight: bold;
  }
  .opacity{
    background-color: rgba(256, 256, 256, 0.5)  
  }
  .list-orientations ul{
    padding-left: 15px;
  }
  .list-orientations li{
    margin: 0;
    margin-top:4px;
    line-height: 15px;
  }
</style>
{% endblock %}

{% block content %}
    <div class="fixed-top text-right">
        <div class="row  p-2">

          <div class="col-6 col-lg-3 col-md-6 text-left orientations d-none">
            {% if object.application.orientations %}
              <div class="opacity p-1">
                <h6 class="mb-0">ORIENTAÇÕES</h6>
                <div class="list-orientations">
                  {{object.application.orientations|safe}}
                </div>
                <button data-toggle="modal" data-target="#chatOrientations"  class="btn btn-sm btn-primary p-1 btn-block">Ver tudo</button>
              </div>
              {% endif %}
            </div>
            <template v-if="inspectors.length">
                <div class="col-6 offset-lg-6 col-lg-3 col-md-3">
                    <div v-for="inspector in inspectors">
                        <div class="marker pos-absolute p-1">
                        <i alt="Online" title="Online" class="text-success fas fa-circle fa-blink"></i> ${inspector.displayName}
                        </div>
                        <video  style="max-width: 100%; width: 100%; background-image: url('{% static 'administration/assets/img/inspector-icon.png' %}'); background-size: cover; background-position: center;" :id="'remote-video-'+inspector.id" autoplay playsinline />
                    </div>
                </div>
            </template>
        </div>
    </div>
    
    <video class="bg-dark" id="local-stream" autoplay playsinline ></video>
    
    <div class="content text-center">

        <div class="row mb-0">
          <div class="col-12" v-if="state == 'started' || state == 'paused'">
            <h1 id="countDown" class="font-weight-bold text-white mb-0">
              ${time}
            </h1>
          </div>
          <div class="col-12">
              <button @click="beforeStartApplication()" v-if="state == 'waiting'" class="btn btn-circle btn-primary font-weight-bold mt-1">
                  <span class="fas fa-play" style="font-size:20px;"></span> 
                  <p class="m-0 p-0">Iniciar</p>
              </button>
      
              <button @click="requestApplicationPause()" v-if="state == 'started'" class="btn btn-circle btn-success font-weight-bold mt-1">
                  <span class="fas fa-toilet" style="font-size:20px;"></span>
                  <p class="m-0 p-0">Pause</p>
              </button>
      
              <button @click="openedChat=true; chatNotificationCount=0;" id="btnChat" data-toggle="modal" data-target="#chatModal" class="btn notification btn-circle btn-secondary font-weight-bold mt-1">
                <span>
                  <span class="fas fa-comments " style="font-size:20px;"></span> 
                  <p class="m-0 p-0">Chat </p>
                </span>
                <span class="badge"  v-if="chatNotificationCount > 0">
                  ${chatNotificationCount}
                </span>
              </button>


              <button data-toggle="modal" data-target="#noticeModal" class="btn notification btn-circle btn-secondary font-weight-bold mt-1">
                <span>

                  <span class="fas fa-bullhorn" style="font-size:20px;"></span> 
                  <p class="m-0 p-0">Avisos </p>
                </span>
                <span class="badge"  v-if="notices.length">
                  ${notices.length}
                </span>
              </button>
              
      
              <button @click="finishApplication()" v-if="state == 'started'" class="btn btn-circle btn-danger font-weight-bold mt-1">
                  <span class="fas fa-stop" style="font-size:20px;"></span> 
                  <p class="m-0 p-0">Finalizar</p>
              </button>
      
              <a href="{% url 'core:redirect_dashboard' %}"  v-if="state == 'waiting'" class="btn btn-circle btn-danger font-weight-bold mt-1">
                <span class="fas fa-times-circle mt-1" style="font-size:20px;"></span> 
                <p class="m-0 p-0">Sair</p>
              </a>
          </div>
        </div>
        
    </div>

    <div class="modal pr-0" tabindex="-1" role="dialog" id="chatModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
            <div class="modal-header bg-white">
                <h5 class="modal-title">
                  <i style="cursor: pointer;" class="fas fa-arrow-left mr-2" data-dismiss="modal" aria-label="Close"></i>
                  Chat com fiscal
                </h5>
                <button @click="openedChat=false;" type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <i class="fas fa-times-circle"></i>
                </button>
            </div>
            <div class="modal-body">
              <div class="divScrollLab">
                <template v-if="messages" v-for="message in messages">
                    <div class="text-left p-2" v-if="message.function == 'Aluno'">
                        <p class="mb-0">
                            <span class="font-weight-bold">${message.name} (Aluno)</span>
                            <span class="text-muted">${message.date_time}</span>
                        </p>
                            <p class="p-2 mb-0 bg-light mr-3">
                                ${message.message}
                            </p>
                    </div>
                    <div class="text-right p-2" v-else>
                        <p class="mb-0">
                            <span class="text-muted"> ${message.date_time}</span>
                            <span class="font-weight-bold"> ${message.name} (${message.function})</span>
                        </p>
                        <p class="p-2 mb-0 bg-light ml-3 text-left">
                            ${message.message}
                        </p>
                    </div>
                </template>
                <template v-else>
                  <p>Ainda não há mensagens entre você e o fiscal</p>
                </template>
              </div>
            </div>
            <div class="modal-footer bg-dark p-2">
                <div class="input-group">
                    <div class="input-group-text border-0 bg-white">
                        <button class="btn btn-default" data-dismiss="modal" aria-label="Close">
                            <i class="fas fa-arrow-left" ></i> 
                        </button>
                      </div>
                    <textarea v-model="textMessage" type="text" class="form-control" placeholder="Escreva sua mensagem" rows="2" maxlength="255"></textarea>
                    <div class="input-group-prepend">
                            <div class="input-group-text border-0 bg-white">
                    <button class="btn btn-primary btnSend" v-on:click="sendMessage()" :disabled="textMessage == '' || sendingMessage">
                        <i v-if="sendingMessage" class="fas fa-spinner fa-spin"></i>
                        <i v-else class="fas fa-paper-plane"></i>
                        </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <div class="modal pr-0" tabindex="-1" role="dialog" id="chatOrientations">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
            <div class="modal-header bg-white">
                <h5 class="modal-title">Orientações da aplicação</h5>
                 <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                {{object.application.orientations|safe}}
            </div>
        </div>
    </div>
    </div>

    <div class="modal pr-0" tabindex="-1" role="dialog" id="noticeModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
            <div class="modal-header bg-white">
                <h5 class="modal-title">Avisos da aplicação</h5>
                 <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
              <div class="row  p-2">
                  <div v-if="notices.length == 0">
                    <p>Não há avisos até o momento</p>
                  </div>
                  <template v-for="notice in notices">
                    <div class="col-12">
                        <blockquote class="blockquote mb-0">
                          <p class="mb-1">${notice.notice}</p>
                          <footer class="blockquote-footer mb-3">${notice.name} (${notice.function}) às ${notice.time}</footer>
                        </blockquote>
                    </div>
                  </template>
                </div>
            </div>
        </div>
      </div>
    </div>

{% endblock content %}


{% block js-additional %}



<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.26.0/moment-with-locales.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>

<script>

  $(function() {
      'use strict'
      // Ja abre o modal com o scroll na ultima mensagem enviada
      $('#btnChat').click(() => {
        setTimeout(() => {
          $('.divScrollLab div').last()[0].scrollIntoView()
        }, 300)
      })
      // Quando o aluno envia uma mensagem envia o scroll para o ultimo elemento depois de 300ms
      $('.btnSend').on("click keypress", () => {
        setTimeout(() => {
          $('.divScrollLab div').last()[0].scrollIntoView()
        }, 300)
      })
  })
  
  moment.locale('pt-br');

  $( window ).on( "load", function() {
    setInterval(function(){
      $(".list-orientations > ul  > li:gt(1)").remove();
      $(".orientations").removeClass("d-none")
    }, 10)
  });


</script>

{% compress js %}
<script type="text/javascript">
  var app = new Vue({
    delimiters: ['${', '}'],
    el: '#app',
    data: {
      server: "{{object.application.prefix}}.rtc.fiscallize.com.br",
      janus: null,
      sfutest: null,
      mypvtid: null,
      mystream:null,
      registred:false,
      openedChat:false,
      chatNotificationCount: 0,
      roomId: {{ object.room_id }},
      studentId: {{object.student_room_id|safe}},
      roomPin: "{{object.room_pin}}",
      firstName: "{{user.get_user_first_name}}",
      functionUser: "{{user.get_user_function}}",
      notificationSound: new Audio("{% static 'administration/assets/sound/not_sound.mp3' %}"),
      sendingMessage: false,
      textMessage:"",
      time: "",
      inspectors: [],
      // waiting, started, paused, finished
      state:"{{object.application_state}}",
      messages: [
        {% for message in object.messages.all %}
          {
            "name": "{{message.sender.get_user_first_name}}",
            "function": "{{message.sender.get_user_function}}",
            "date_time": "{{message.created_at|date:'d/m/Y \à\s H:i'}}",
            "message": "{{message.content|remove_line_break}}",
          },
          {% endfor %}
        ],
        notices: [
          {% for notice in object.application.notices.all %}
            {
              "name":"{{notice.inspector.get_user_first_name}}",
              "function":"{{notice.inspector.get_user_function}}",
              "time":"{{notice.created_at|date:'H:i'}}",
              "notice":"{{notice.notice|remove_line_break}}"
            },
            {% endfor %}
          ],
      pendingRequest: 
      {% if object.pending_event %}
        {
          "pk":"{{object.pending_event.pk}}",
          "get_event_type_display": "{{object.pending_event.get_event_type_display}}",
          "created_at": "{{object.pending_event.created_at|date:'c'}}",
          "start": "{{object.pending_event.start}}",
          "end": "{{object.pending_event.end}}",
          "inspector_first_name": "{{object.pending_event.inspector.get_user_first_name}}",
          "get_response_display": "{{object.pending_event.get_response_display}}",
          "response_datetime": "{{object.pending_event.response_datetime|date:'c'}}",
        },
      {% else %}
      null,
      {% endif %}
    },
    watch:{
      sfutest: function(val){
        if (!this.registred)
          this.registerUsername()
      }
    },
    methods: {
      countDown(){
          var countDownDate = moment("{{object.application.date_time_end_tz|date:'Y-m-d H:i:s'}}", 'YYYY-MM-DD HH:mm:ss').toDate().getTime()

          var x = setInterval(function() {
            var now = new Date().getTime();
            var distance = countDownDate - now;

            var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((distance % (1000 * 60)) / 1000);

            self.time = ('0' + hours).slice(-2) + ":" + ('0' + minutes).slice(-2) + ":" + ('0' + seconds).slice(-2);

            if (distance < 0) {
              clearInterval(x);
              self.time = "Encerrada";
            }
          }, 1000);
      },
      checkPendingRequest(){
        self = this

        if (self.pendingRequest){        
          switch(self.pendingRequest.get_response_display){
            case "Aprovado":
              self.showAnswerRequest("Aprovado")
              break;
            case "Pendente":
              Swal.fire({
                title: 'Aguarde aprovação de um fiscal!',
                text: "Te informaremos assim que algum fiscal disponível responda sua solicitação.",
                icon: 'warning',
                showConfirmButton: false,
              })
              break;
            default:
              break;
          }
        }
      },
      showNotice(data){
        Swal.fire({
          title: 'Aviso importante',
          text: data.notice,
          icon: "warning",
          showCancelButton: false,
          confirmButtonColor: '#3085d6',
          confirmButtonText: 'Ok, entendi',
          showConfirmButton: true,
        })

        this.notices.unshift(data)

      },
      showAnswerRequest(response_display){
        self = this
        var response = response_display == "Aprovado";

        if (!response)
          this.pendingRequest = null

        var title = response ? "aprovada" : "rejeitada";
        var icon = response ? "success" : "error";

        var text_approved = "Assim que voltar do banheiro aperte no botão abaixo."
        var text_rejected = "Faça sua solicitação novamente em breve."
        var text = response ? text_approved : text_rejected

        Swal.fire({
          title: 'Sua solicitação foi '+ title,
          text: text,
          icon: icon,
          showCancelButton: false,
          confirmButtonColor: '#3085d6',
          confirmButtonText: 'Já voltei do banheiro',
          showConfirmButton: response,
          allowEscapeKey : !response,
          allowOutsideClick: !response,
          allowEnterKey: !response,
        }).then((result) => {
          if (result.value) {
            if (response){
              
              url = "{% url 'events:event_finish' pk='00000000-0000-0000-0000-000000000000'  %}"
              axios.put(url.replace("00000000-0000-0000-0000-000000000000", self.pendingRequest.pk)).then(function(response){

              self.state = "started"
              self.pendingRequest = null
              
              var message = {
                "message": self.state,
                "type":"changeState"
              }

              self.sfutest.data({
                text: JSON.stringify(message),
                error: function(reason) { },
                success: function() {},
              });

              Swal.fire(
                'Ok, volte a fazer a prova!',
              )
            }).catch(function(error){
              console.error(" --- Comunicaão com a api ..." + error)
              Swal.fire(
                'Ocorreu algum problema!',
                'Tente novamente mais tarde',
                'error'
              )
            })
            }
          }
        })
      },
      requestApplicationPause(){
        self = this
        if (self.pendingRequest !== null){
          Swal.fire(
            'Solicitação em andamento',
            'Aguarde que um fiscal responda a sua solicitação em andamento',
            'warning'
          )
          return
        }

        data = {
          "event_type": "1",
          "student_application": "{{object.pk}}"
        }
        
        axios.post("{% url 'events:event_create'  %}", data
        ).then(function(response){

          Swal.fire({
            title: 'Aguarde aprovação de um fiscal!',
            text: "Te informaremos assim que algum fiscal disponível responda sua solicitação.",
            icon: 'warning',
            showConfirmButton: false,
          })

          var message = {
            "message": response.data,
            "type":"requestPause"
          }

          self.pendingRequest = response.data

          self.sfutest.data({
            text: JSON.stringify(message),
            error: function(reason) { },
            success: function() {},
          });


        }).catch(function(error){
          alert(error)
          Swal.fire(
            'Horário não permitido',
            'error'
          )
        })

      },
      getApplicationDelay(){
        var now = moment("1970-01-01 " + "{% now "H:i:s" %}", 'YYYY-MM-DD HH:mm:ss').toDate()
        var application_start = moment("1970-01-01 " + "{{object.application.start}}", 'YYYY-MM-DD HH:mm:ss').toDate()
        
        return now - application_start;
      },
      beforeStartApplication(){
        self = this

        var start_time_delay = self.getApplicationDelay()
        var start_time_delay_seconds = start_time_delay/1000

        if(start_time_delay_seconds >= {{object.application.max_time_tolerance.seconds}}){
          Swal.fire({
            title: 'Atraso no início da prova',
            text: 'Você está iniciando a prova após o período de tolerância. Por gentileza, justifique a razão pela qual você está atrasado:',
            input: 'text',
            inputAttributes: {
                autocapitalize: 'off'
            },
            showCancelButton: false,
            confirmButtonText: 'Enviar justificativa',
            showLoaderOnConfirm: true,
            allowOutsideClick: false,
            allowEscapeKey: false,
            preConfirm: (justifyText) => {
              if ($("input.swal2-input").val().trim()) {
                url = "{% url 'applications:application_student_justify_delay' pk='00000000-0000-0000-0000-000000000000'  %}"
                return axios.put(url.replace("00000000-0000-0000-0000-000000000000", "{{ object.pk }}"), { 'justification_delay': justifyText })
                .then(response => {
                    if (!response.status == 200) {
                        throw new Error(response.statusText)
                    }
                    return response.data
                })
                .catch(error => {
                    Swal.showValidationMessage(`Falha no envio: ${error}`)
                })
              } else {
                $("input.swal2-input").val("")
                Swal.showValidationMessage('Preencha o campo acima')   
              }
            },
          }).then((result) => {
            self.startApplication()
          })
        } else {
            self.startApplication()
        }
      },
      startApplication(){
        self = this

        Swal.fire({
          title: 'Certeza que deseja iniciar a prova agora?',
          text: "Certifique-se de estar tudo organizado no seu ambiente de prova!",
          icon: 'question',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Sim, iniciar prova!'
        }).then((result) => {
          if (result.value) {
            axios.post("{% url 'applications:application_start' pk=object.pk  %}", {}
            ).then(function(response){
              self.state = 'started'

              var message = {
                "message": self.state,
                "type":"changeState"
              }

              self.sfutest.data({
                text: JSON.stringify(message),
                error: function(reason) { },
                success: function() {},
              });

            }).catch(function(error){
                data = JSON.parse(error.response.data)
                Swal.fire(
                  'Problema ao iniciar',
                  data.message,
                  'error'
                )
            })
          }
        })

        
      },
      finishApplication(){
        self = this

        Swal.fire({
          title: 'Certeza que deseja finalizar a prova agora?',
          text: "Após confirmação não será possível voltar a este ambiente de fiscalização!",
          icon: 'question',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Sim, finalizar prova!'
        }).then((result) => {
          if (result.value) {
            axios.post("{% url 'applications:application_end' pk=object.pk  %}", {}
            ).then(function(response){

              Swal.fire({
                icon: 'success',
                title: 'Prova finalizada. Boa sorte!',
                showConfirmButton: true,
              }).then((result) => {
                
              })

              self.state = 'finished'

              var message = {
                "message": self.state,
                "type":"changeState"
              }

              self.sfutest.data({
                text: JSON.stringify(message),
                error: function(reason) { },
                success: function() {},
              });

              window.location.href = "{% url 'core:redirect_dashboard' %}"

            }).catch(function(error){
              Swal.fire(
                'Horário não permitido',
                "Você só pode finalizar a partir das {{object.application.min_time_end|date:'H:i'}} horas",
                'error'
              )
            })
          }
        })

        
      },
      sendMessage(){
        self = this

        pluginHandle = self.sfutest

        var newMessage = {
          "application_student": "{{object.pk}}",
          "content": self.textMessage
        }

        var message = {
          "name": self.firstName,
          "function": self.functionUser,
          "date_time": moment().calendar(),
          "message": self.textMessage,
          "type":"message"
        }

        pluginHandle.data({
          text: JSON.stringify(message),
          error: function(reason) { 
            // alert(reason) 
          },
          success: function() { 
              axios.post("{% url 'events:text_message_create'  %}", newMessage).then(function(response){
                self.messages.push({
                "name": self.firstName,
                "function": self.functionUser,
                "date_time": moment().calendar(),
                "message": self.textMessage
              })
              $(".modal-content").animate({ scrollTop: $(document).height() }, 1000);
              self.textMessage = ""
            })
           },
        });
      },
      removeElement: function(array, element) {
        const index = array.indexOf(element);
        array.splice(index, 1);
      },
      getInspector: function(inspectorId){
        return this.inspectors.find(element => element.id == inspectorId)
      },
      publishOwnFeed: function(useAudio, useVideo) {
        var self = this 
        self.sfutest.createOffer({
            media: { audioRecv: false, videoRecv: false, audioSend: useAudio, videoSend: useVideo, data: true },
            simulcast: false,
            simulcast2: false,
            success: function(jsep) {
              Janus.debug("Got publisher SDP!", jsep);
              var publish = { request: "configure", audio: useAudio, video: useVideo };
              self.sfutest.send({ message: publish, jsep: jsep });
            },
            error: function(error) {
              Janus.error("WebRTC error:", error);
              if(useAudio) {
                self.publishOwnFeed(!useAudio, !useVideo);
              } else {
              }
            }
          });
      },
      newRemoteFeed: function(id, display, audio, video) {
        var self = this
        var remoteFeed = null;
        var inspector = null

        var length = self.inspectors.length
        
        inspector = {
            "id":id,
            "pluginHandle":null,
            "displayName": display,
            "audio":audio,
            "video":video
        }

        self.inspectors.push(inspector)

        self.janus.attach(
          {
            plugin: "janus.plugin.videoroom",
            
            success: function(pluginHandle) {
              self.inspectors[length].pluginHandle = pluginHandle

              remoteFeed = pluginHandle;
              remoteFeed.simulcastStarted = false;
              Janus.log("Plugin attached! (" + remoteFeed.getPlugin() + ", id=" + remoteFeed.getId() + ")");
              Janus.log("  -- This is a subscriber");
              // We wait for the plugin to send us an offer
              var subscribe = {
                request: "join",
                room: self.roomId,
                ptype: "subscriber",
                feed: id,
                private_id: self.mypvtid,
                pin: self.roomPin,
              };

              if(Janus.webRTCAdapter.browserDetails.browser === "safari" && (video === "vp9" || (video === "vp8" && !Janus.safariVp8))) {
                if(video)
                  video = video.toUpperCase()
                // alert("Publisher is using " + video + ", but Safari doesn't support it: disabling video");
                subscribe["offer_video"] = false;
              }
              remoteFeed.videoCodec = video;
              remoteFeed.send({ message: subscribe });
            },
            error: function(error) {
              Janus.error("  -- Error attaching plugin...", error);
              // alert("Error attaching plugin... " + error);
            },
            onmessage: function(msg, jsep) {
              Janus.debug(" ::: Got a message (subscriber) :::", msg);
              var event = msg["videoroom"];
              Janus.debug("Event: " + event);
              if(msg["error"]) {
                // alert(msg["error"]);
              } else if(event) {
                if(event === "attached") {
                  
                  remoteFeed.rfid = msg["id"];
                  remoteFeed.rfdisplay = msg["display"];

                  Janus.log("Successfully attached to feed " + remoteFeed.rfid + " (" + remoteFeed.rfdisplay + ") in room " + msg["room"]);
                
                } else if(event === "event") {
                  // Check if we got an event on a simulcast-related event from this publisher
                  var substream = msg["substream"];
                  var temporal = msg["temporal"];
                  if((substream !== null && substream !== undefined) || (temporal !== null && temporal !== undefined)) {
                    if(!remoteFeed.simulcastStarted) {
                      remoteFeed.simulcastStarted = true;}
                  }
                } else {
                  // What has just happened?
                }
              }
              if(jsep !== undefined && jsep !== null) {
                Janus.debug("Handling SDP as well...", jsep);

                remoteFeed.createAnswer(
                  {
                    jsep: jsep,
                    // Add data:true here if you want to subscribe to datachannels as well
                    // (obviously only works if the publisher offered them in the first place)
                    media: { audioSend: false, videoSend: false, data:true },	// We want recvonly audio/video
                    success: function(jsep) {
                      Janus.debug("Got SDP!", jsep);
                      var body = { request: "start", room: self.roomId };
                      remoteFeed.send({ message: body, jsep: jsep });
                    },
                    error: function(error) {
                      Janus.error("WebRTC error: sem camera", error);
                      // alert("WebRTC error... xxxx " + error.message);
                    }
                  });
              }
            },
            iceState: function(state) {
              Janus.log("ICE state of this WebRTC PeerConnection (feed #" + remoteFeed.rfindex + ") changed to " + state);
            },
            webrtcState: function(on) {
              Janus.log("Janus says this WebRTC PeerConnection (feed #" + remoteFeed.rfindex + ") is " + (on ? "up" : "down") + " now");
            },
            onlocalstream: function(stream) {
              // The subscriber stream is recvonly, we don't expect anything here
            },
            onremotestream: function(stream) {

              Janus.debug("Remote feed #" + remoteFeed.rfindex + ", stream:", stream);
              
              if($("#remote-video-"+id).length === 0) {
                $("#remote-video-"+id).bind("playing", function () {

                  if(remoteFeed.spinner)
                    remoteFeed.spinner.stop();
                  remoteFeed.spinner = null;
                });
              }

              Janus.attachMediaStream($('#remote-video-'+id).get(0), stream);

            },
            oncleanup: function() {
              Janus.log(" ::: Got a cleanup notification (remote feed " + id + ") :::");
              if(remoteFeed.spinner)
                remoteFeed.spinner.stop();
              remoteFeed.spinner = null;
            },
            ondataopen: function(data) {
                
            },
            ondata: function(data) {
              message = JSON.parse(data)

              switch(message.type){
                case "message":
                  self.notificationSound.play();
                  self.messages.push(message)
                  self.chatNotificationCount += 1
                  $(".modal-content").animate({ scrollTop: $(document).height() }, 1000);
                  break;
                case "answerRequest":
                  self.notificationSound.play();
                  self.showAnswerRequest(message.message.get_response_display)
                  break;
                  case "notice":
                  self.notificationSound.play();
                  self.showNotice(message);
                  break;
                  case "openmic":
                  // self.publishOwnFeed(true, true)
                  break;
                  case "offmic":
                  // self.publishOwnFeed(false, true)
                  break;
                default:
                  break;
              }
            },
          });
      },
      registerUsername: function() {
        var username = "aluno"
        var self = this
        var register = {
          request: "join",
          room: self.roomId,
          id: self.studentId,
          ptype: "publisher",
          display: username,
          pin: self.roomPin,
        };
        
        try {
          self.sfutest.send({ message: register });
          self.registred = true
        }
        catch (e) {
          console.log(e)
          self.registred = false
        }
        
      },
      isIos: function(){
        return [
          'iPad Simulator',
          'iPhone Simulator',
          'iPod Simulator',
          'iPad',
          'iPhone',
          'iPod'
        ].includes(navigator.platform)
        // iPad on iOS 13 detection
        || (navigator.userAgent.includes("Mac") && "ontouchend" in document)
      },
      isChrome: function(){
        return navigator.userAgent.match('CriOS')
      }
    },
    mounted: function(){
      var self = this;

      if(self.isIos() && self.isChrome()){
        Swal.fire({
            icon: 'error',
            title: 'Navegador não compatível!',
            text: 'O seu navegador não é compatível com as tecnologias utilizadas pela Lize Remote.',
            showConfirmButton: true,
            confirmButtonText: '<i class="fab fa-safari"></i> Irei utilizar o Safari'
        }).then((value) => {
          window.location.href = "/painel/aluno"
        });
      }

      self.checkPendingRequest()
      self.countDown()

      Janus.init({debug: false, callback: function() {
          if(!Janus.isWebrtcSupported()) {
            var confirmButtonText = ""
            var href = ""

            if (self.isIos()){
              confirmButtonText = '<i class="fab fa-safari"></i> Irei utilizar o Safari'
              // href = "https://support.apple.com/pt_BR/downloads/safari"
            }else{
              confirmButtonText = '<i class="fab fa-chrome"></i> Irei utilizar o Google Chrome'
              // href = "https://play.google.com/store/apps/details?id=com.android.chrome&hl=pt_BR"
            }

            Swal.fire({
                icon: 'error',
                title: 'Navegador não compatível!',
                text: 'O seu navegador não é compatível com as tecnologias utilizadas pela Lize Remote.',
                showConfirmButton: true,
                confirmButtonText: confirmButtonText
            }).then((value) => {
              window.location.href = "/painel/aluno"
            });

            return;
          }
          // Create session
          self.janus = new Janus({
            server: "wss://"+self.server+"/ws",
            iceServers :[
              {
                url: 'turn:'+self.server,
                username: 'gA42zcNAp8',
                credential: 'uzQNsqqF8c',
              },
              {
                url: 'stun:stun.fiscallize.com.br'
              },
            ],
            success: function() {
              self.janus.attach(
                {
                  plugin: "janus.plugin.videoroom",
                  success: function(pluginHandle) {
                    self.sfutest = pluginHandle;
                    Janus.log("Plugin attached! (" + self.sfutest.getPlugin() + ", id=" + self.sfutest.getId() + ")");
                    Janus.log("  -- This is a publisher/manager");
                  },
                  error: function(error) {
                    Janus.error("  -- Error attaching plugin...", error);
                    // alert("Error attaching plugin... " + error);
                  },
                  consentDialog: function(on) {
                    Janus.debug("Consent dialog should be " + (on ? "on" : "off") + " now");
                    if(on) {
                      // alert("permita o uso da camera")
                    } else {
                      // Restore screen
                    }
                  },
                  iceState: function(state) {
                    Janus.log("ICE state changed to " + state);
                  },
                  mediaState: function(medium, on) {
                    Janus.log("Janus " + (on ? "started" : "stopped") + " receiving our " + medium);
                  },
                  webrtcState: function(on) {
                    Janus.log("Janus says our WebRTC PeerConnection is " + (on ? "up" : "down") + " now");
                    if(!on)
                      return;
                  },
                  onmessage: function(msg, jsep) {
                    Janus.debug(" ::: Got a message (publisher) :::", msg);
                    var event = msg["videoroom"];
                    Janus.debug("Event: " + event);
                    if(event) {
                      if(event === "joined") {
                        // Publisher/manager created, negotiate WebRTC and attach to existing feeds, if any
                        myid = msg["id"];
                        self.mypvtid = msg["private_id"];
                        Janus.log("Successfully joined room " + msg["room"] + " with ID " + myid);
                        self.publishOwnFeed(false, true);


                        if(msg["publishers"]) {
                          

                          var list = msg["publishers"];
                          Janus.debug("Got a list of available publishers/feeds:", list);
                          for(var f in list) {
                            var id = list[f]["id"];
                            var display = list[f]["display"];
                            var audio = list[f]["audio_codec"];
                            var video = list[f]["video_codec"];
                            Janus.debug("  >> [" + id + "] " + display + " (audio: " + audio + ", video: " + video + ")");
                            // alert("entrou alguem")
                            self.newRemoteFeed(id, display, audio, video);
                          }
                        }
                      } else if(event === "destroyed") {
                        // The room has been destroyed
                        Janus.warn("The room has been destroyed!");
                        alert("The room has been destroyed", function() {
                          window.location.reload();
                        });
                      } else if(event === "event") {
                        // Any new feed to attach to?
                        if(msg["publishers"]) {
                          

                          var list = msg["publishers"];
                          Janus.debug("Got a list of available publishers/feeds:", list);
                          for(var f in list) {
                            var id = list[f]["id"];
                            var display = list[f]["display"];
                            var audio = list[f]["audio_codec"];
                            var video = list[f]["video_codec"];
                            Janus.debug("  >> [" + id + "] " + display + " (audio: " + audio + ", video: " + video + ")");
                            
                            self.newRemoteFeed(id, display, audio, video);
                          }
                        } else if(msg["leaving"]) {
                          var leaving = msg["leaving"];
                          Janus.log("Publisher left: " + leaving);
                          
                          var remoteFeed = null;

                          inspector = self.getInspector(leaving)
                          
                          if (inspector != undefined)
                            remoteFeed = inspector.pluginHandle


                          if(remoteFeed != null) {
                            Janus.debug("Feed " + remoteFeed.rfid + " (" + remoteFeed.rfdisplay + ") has left the room, detaching");
                            self.removeElement(self.inspectors, inspector)
                            remoteFeed.detach();
                          }
                        } else if(msg["unpublished"]) {

                          var unpublished = msg["unpublished"];
                          Janus.log("Publisher left: " + unpublished);
                          if(unpublished === 'ok') {
                            self.sfutest.hangup();
                            return;
                          }
                          var remoteFeed = null;
                          inspector = self.getInspector(unpublished)

                          if (inspector != undefined)
                            remoteFeed = inspector.pluginHandle

                          if(remoteFeed != null) {
                            Janus.debug("Feed " + remoteFeed.rfid + " (" + remoteFeed.rfdisplay + ") has left the room, detaching");                              
                            self.removeElement(self.inspectors, inspector)
                            remoteFeed.detach();
                          }
                        } else if(msg["error"]) {
                          if(msg["error_code"] === 426) {
                            // This is a "no such room" error: give a more meaningful description
                            // alert(
                            //   "<p>Apparently room <code>" + self.roomId + "</code> (the one this demo uses as a test room) " +
                            //   "does not exist...</p><p>Do you have an updated <code>janus.plugin.videoroom.jcfg</code> " +
                            //   "configuration file? If not, make sure you copy the details of room <code>" + self.roomId + "</code> " +
                            //   "from that sample in your current configuration file, then restart Janus and try again."
                            // );
                          } else {
                            // alert(msg["error"]);
                          }
                        }
                      }
                    }
                    if(jsep) {
                      Janus.debug("Handling SDP as well...", jsep);
                      self.sfutest.handleRemoteJsep({ jsep: jsep });
                      // Check if any of the media we wanted to publish has
                      // been rejected (e.g., wrong or unsupported codec)
                      var audio = msg["audio_codec"];
                      if(self.mystream && self.mystream.getAudioTracks() && self.mystream.getAudioTracks().length > 0 && !audio) {
                        // Audio has been rejected
                        // alert("Our audio stream has been rejected, viewers won't hear us");
                      }
                      var video = msg["video_codec"];
                      if(self.mystream && self.mystream.getVideoTracks() && self.mystream.getVideoTracks().length > 0 && !video) {
                        // Video has been rejected
                        // alert("Our video stream has been rejected, viewers won't see us");
                        
                      }
                    }
                  },
                  onlocalstream: function(stream) {
                    Janus.debug(" ::: Got a local stream :::", stream);
                    self.mystream = stream;

                    Janus.attachMediaStream($('#local-stream').get(0), stream);

                    $("#local-stream").get(0).muted = "muted";
                    
                    if(self.sfutest.webrtcStuff.pc.iceConnectionState !== "completed" &&
                        self.sfutest.webrtcStuff.pc.iceConnectionState !== "connected") {}
                  },
                  onremotestream: function(stream) {
                    // The publisher stream is sendonly, we don't expect anything here

                  },
                  oncleanup: function() {
                    Janus.log(" ::: Got a cleanup notification: we are unpublished now :::");
                    self.mystream = null;
                  },
                });
            },
            error: function(error) {
               Swal.fire({
                icon: 'warning',
                title: 'Algo de errado aconteceu!',
                text: 'Aconteceu algum problema durante sua aplicação, entre novamente em instantes.',
                showConfirmButton: true,
                confirmButtonText: "Ok, entendi!"
              }).then((value) => {
                window.location.href = "/painel/aluno";
              });
            },
            destroyed: function() {
              window.location.href = "/painel/aluno"
            }
          });
      }});
    

      {% if object.application_state == 'waiting' %}
        
        var start_time_delay = self.getApplicationDelay()

        if(start_time_delay >= 0) {
            this.beforeStartApplication();
        } else {
            Swal.fire({
                icon: 'info',
                title: 'Bem vindo ao ambiente de monitoramento!',
                text: 'A partir das {{ object.application.start }} você poderá começar sua prova clicando no botão "iniciar" logo abaixo',
                showConfirmButton: true,
                confirmButtonText: 'Entendi'
            })
        }
      {% endif %}
    }
  })
</script>


{% endcompress %}

{% endblock js-additional %}