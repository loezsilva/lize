{% extends 'redesign/base.html' %}
{% comment %} {% extends 'dashboard/base_fixed.html' %} {% endcomment %}
{% load static %}
{% load widget_tweaks %}
{% load remove_line_break %}

{% block css-additional %}
    <link href="{% static 'administration/lib/select2/css/select2.min.css' %}" rel="stylesheet" />
    <style>
        .errors span {
            cursor: pointer;
        }
        .modal-fullscreen{
            width:100vw;
            max-width: none;
            height: 100% !important;
            margin:0
        }
        .modal-fullscreen .modal-content{
            height: 100% !important;
            border:0;
            border-radius:0
        }
        .modal-fullscreen .modal-footer,.modal-fullscreen .modal-header{
            border-radius:0
        }
        .modal-fullscreen .modal-body{
            overflow-y: auto
        }
    </style>
{% endblock css-additional %}

{% block title %}
    Listagem de gabaritos - Lize
{% endblock title %}

{% comment %}
{% block breadcrumb-fixed %}
    <div class="d-sm-flex align-items-center justify-content-between mg-b-20 mg-lg-b-25 mg-xl-b-10">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb breadcrumb-style1 mg-b-10">
                <li class="breadcrumb-item"><a href="{% url 'omr:omr_upload_list' %}">GABARITOS</a></li>
                <li class="breadcrumb-item active" aria-current="page">CORREÇÃO</li>
                </ol>
            </nav> 
            <h4>Correção de gabaritos</h4>
        </div>
        <div class="d-none d-md-block">
            <a href="#" onclick="history.back(); return false;" class="btn btn-sm pd-x-15 btn-white btn-uppercase">
                <i data-feather="arrow-left" class="wd-10 mg-r-5"></i> Voltar
            </a>
        </div>
    </div>
{% endblock breadcrumb-fixed %}
{% endcomment %}

{% block content-fixed %}
<div class="ard cer dcv tw-mb-16">
    <div class="ls" style="margin-top: 1rem; margin-bottom: 1rem; justify-content: space-between;">
        <nav class="ls" aria-label="Breadcrumb">
        <ol role="list" class="ls yu abe" style="list-style: none; margin: 0; padding: 0;">
            <li>
            <div>
                <a href="{% url 'core:redirect_dashboard' %}" class="axk bks">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="nu rw uk" style="width: 1.25rem; height: 1.25rem; flex-shrink: 0;">
                    <path fill-rule="evenodd" d="M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 11h-1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-3a1 1 0 00-1-1H9a1 1 0 00-1 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-6H3a1 1 0 01-.707-1.707l7-7z" clip-rule="evenodd"></path>
                </svg>
                <span class="t" style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0;">Painel</span>
                </a>
            </div>
            </li>
            <li>
            <div class="ls yu">
                <svg class="nu rw uk axj" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true" style="width: 1.25rem; height: 1.25rem; flex-shrink: 0; color: rgb(209 213 219);">
                <path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z"></path>
                </svg>
                <a href="{% url 'omr:omr_upload_list' %}" class="js avv avz axm bku" style="margin-left: 1rem; font-size: 0.875rem; line-height: 1.25rem; font-weight: 500;">Gabaritos</a>
            </div>
            </li>
            <li>
            <div class="ls yu">
                <svg class="nu rw uk axj" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true" style="width: 1.25rem; height: 1.25rem; flex-shrink: 0; color: rgb(209 213 219);">
                <path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z"></path>
                </svg>
                <a href="data:text/plain," class="js avv avz axm bku" aria-current="page" style="margin-left: 1rem; font-size: 0.875rem; line-height: 1.25rem; font-weight: 500;">Correção</a>
            </div>
            </li>
        </ol>
        </nav>
        <div class="d-none d-md-block">
        <a href="#" onclick="history.back()" class="btn btn-sm pd-x-15 btn-white btn-uppercase">
            <i data-feather="arrow-left" class="wd-10 mg-r-5"></i> Voltar
        </a>
        </div>
    </div>
    <h4>Correção de gabaritos</h4>
<div class="row">

    <div class="col-12">
        <div class="card mb-2">
            <div class="card-header pd-t-20 d-sm-flex align-items-start justify-content-between pd-b-0">
                <div>
                    Uploads
                </div> 
                <div class="float-right text-right">
                <button data-toggle-off-canvas="#right-off-canvas"
                    class="btn btn-sm btn-info btn-icon rounded-pill off-canvas-menu  mb-2">
                    <i class="fas fa-search"></i> Filtrar listagem

                    {% if count_filters > 0 %}
                    <span class="badge badge-danger">{{count_filters}} Aplicado(s)</span>
                    {% endif %}
                </button>
                {% if count_filters > 0 %}
                <a href="{% url 'omr:omr_upload_list' %}?year={{year|force_escape}}" class="btn btn-sm btn-info btn-icon rounded-pill mb-2">
                    <i class="fas fa-eraser"></i> Apagar filtro(s)
                </a>
                {% endif %}
                </div>
            </div>           
            
        </div>
        <div class="card my-4" v-for="upload in uploads.filter(u => (!seen && !u.corrected) || (seen ? !u.seen:false))" :key="upload.id">
            <div class="card-header">
                <div class="d-flex align-items-center justify-content-between">
                    <a href="javascript:;" @click="copyToClipboard(generateUrl(getUrl(omrUploadCorrectionlUrl, upload.id)))" onclick="return false">
                        <span>
                            ${ upload.createdDate } <i class="far fa-copy"></i><br/> 
                            <span class="text-muted">Por: ${ upload.user } </span><br />
                            <tooltip :configs="{'objects': upload.classes, showNumber: 1, 'attribute': 'name'}"></tooltip>
                        </span>
                    </a>
                    <div class="d-flex justify-content-center align-items-center errors">
                        <template v-if="upload.studentPageErrorCount">
                            <span class="mx-1 text-danger tooltips" :data-tippy-content="'Encontramos um erro(s) de leitura em '+ upload.studentPageErrorCount + ' cartão(ões) de resposta'">
                                <a :href="getUrl(omrUploadDetailUrl, upload.id)" class="text-danger">
                                ${upload.studentPageErrorCount} 
                                <i class="fas fa-exclamation-triangle text-danger"></i>
                                </a>
                            </span>
                        </template>
                        <template v-if="upload.studentPageErrorCountLoading">
                            <span class="mr-2">Carregando</span>
                            <div class="spinner-border text-primary" role="status" style="width: 20px; height: 20px;">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </template>
                        <template v-if="!upload.studentPageErrorCountLoading">
                            <button class="btn btn-outline-success ml-2" @click="markCorrected(upload)">Marcar como corrigido <i class="fas fa-check-double"></i></button>
                            <button class="btn ml-2" :class="upload.seen ? 'btn-outline-danger':'btn-outline-primary'" @click="markCorrected(upload, true)">${upload.seen ? 'Desmarcar visto':'Dar Visto'} <i class="fas" :class="upload.seen ? 'fa-times':'fa-check'"></i></button>
                        </template>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>
                                Aluno
                            </th>
                            <th>
                                Respostas / Total Questões
                            </th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr :class="{ 'bg-warning-light': student.total_answers_questions < student.total_questions && !student.checked, 'bg-success-light': student.total_answers_questions >= student.total_questions || student.checked }" v-for="(student, index) in upload.students">
                            <td>
                                <a href="javascript:;" :data-applicationstudent="student.application_student.id" @click="openStudentModal(student.application_student), selectedStudent = student, selectedUpload = upload, selectedIndex = index, maxIndex = upload.students.length">${student.name}</a>
                            </td>
                            <td>${student.total_answers_questions < student.total_questions ? student.total_answers_questions : student.total_questions} / ${student.total_questions}</td>
                            <td>
                                <button type="button" v-if="student.total_answers_questions < student.total_questions" data-check @click="uploadCheck(student)" class="btn btn-xs ml-2" :class="{ 'btn-outline-danger': student.checked, 'btn-success': !student.checked && student.total_answers_questions < student.total_questions }">
                                    <i class="fas fa-check" v-if="student.total_answers_questions < student.total_questions && !student.checked"></i>
                                    <i class="fas fa-times" v-else></i>
                                </button>
                            </td>
                        </tr>
                        <tr v-if="!upload.students.length" >
                            <td colspan="3">Nenhum erro encontrado</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <h4 v-if="count < uploads.length" class="text-center my-4">Carregando uploads... aguarde 
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </h4>
        {% include 'includes/pagination.html' with objects=object_list %}
    </div>
</div>

<div class="modal pr-0" tabindex="-1" role="dialog" id="detailModal">
    <div class="modal-dialog modal-fullscreen" role="document">
        <div class="modal-content">
            <div class="modal-header bg-white py-1">
                <h5 class="modal-title">
                    <div class="d-flex">
                        <a href="javascript:;" onclick="return false" @click="copyToClipboard(generateUrl(getUrl(omrUploadCorrectionlUrl, selectedStudent.upload_id)+'#'+selectedStudent.application_student.id))"> 
                            <i class="fas fa-user mr-2"></i>
                            ${applicationStudent.fullname} <i class="far fa-copy mx-2"></i>
                        </a>
                        <span v-if="applicationStudent.is_omr" class="text-muted">
                            (aplicação presencial)
                        </span>
                        <button type="button" v-if="selectedStudent && (selectedStudent.total_answers_questions < selectedStudent.total_questions || !selectedStudent.checked)" data-check @click="uploadCheck(selectedStudent)" class="btn btn-xs ml-2" :class="{ 'btn-outline-danger': selectedStudent.checked, 'btn-success': !selectedStudent.checked && selectedStudent.total_answers_questions < selectedStudent.total_questions }">
                            <i class="fas fa-check" v-if="selectedStudent.total_answers_questions < selectedStudent.total_questions && !selectedStudent.checked"></i>
                            <i class="fas fa-times" v-else></i>
                        </button>
                    </div>
                    <span class="text-muted tx-12">${applicationStudent.exam_name}</span>
                    <span class="text-muted" v-if="applicationStudent.start_time"> de ${formatDate(applicationStudent.start_time)} 
                        <template v-if="applicationStudent.end_time">às ${formatDate(applicationStudent.end_time)}</template>
                    </span>
                    <template v-if="applicationStudent.empty_questions > 0"><br/>
                        <span class="text-danger" v-if="applicationStudent.empty_questions == 1"> (finalizou a prova confirmando que havia 1 questão em branco)</span>
                        <span class="text-danger" v-else> (finalizou a prova confirmando que havia ${applicationStudent.empty_questions} questões em branco)</span>
                    </template>
                    <span class="badge badge-warning" v-if="applicationStudent.randomization_version">ORDEM RANDOMIZADA</span>
                </h5>
                <div>
                    <button type="button" @click="changeViewType(), !correctionFast ? getEnunciation(selectedQuestion) : ''" class="btn btn-xs btn-secondary">
                        <template v-if="correctionFast">
                            <i class="fas fa-tasks"></i> Correção completa
                        </template>
                        <template v-else>
                            <i class="fas fa-table"></i> Correção rápida
                        </template>
                    </button>
                    <button class="btn btn-primary btn-sm m-1" @click="changeStudent('previous')" v-if="selectedIndex > 0 && selectedIndex < maxIndex"><i class="fas fa-arrow-left"></i> Aluno anterior</button>
                    <button class="btn btn-primary btn-sm m-1" @click="changeStudent('next')" v-if="selectedIndex < maxIndex && maxIndex > 0">Próximo aluno <i class="fas fa-arrow-right"></i></button>
                    <button @click="openedChat=false;" type="button" class="close" data-dismiss="modal" aria-label="Close"><i class="fas fa-times-circle"></i></button>
                </div>
            </div>
            <div class="modal-body px-0 py-0" style="max-height: 100vh !important; overflow-y: hidden;">
                <div v-if="spinnerVerification" class="text-center mt-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <div>Carregando...</div>
                </div>
                <div class="row m-0">
                    <div :class="hasFiles() ? 'col-6':'col-12'" class="py-2" style="overflow-y: scroll; max-height: 100vh; padding-bottom: 100px !important;">
                        <template  v-if="correctionFast">
                            <div class="d-flex justify-content-between align-items-end">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Questão</th>
                                            <th>Resposta do aluno</th>
                                            <th ></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-if="!question.text_correction" v-for="(question, index) in applicationStudent.questions">
                                            <td>Questão ${index+1}<br>
                                                <span class="font-weight-bold">Valor:</span>
                                                <span class="badge badge-info">${question.question_weight}</span> 
                                            </td>
                                            <td>
                                                <template v-if="question.category == 'Arquivo anexado'">
                                                    {% if object.group_attachments %}
                                                        <div class="row row-xs" v-if="getAttachmentsExamTeacherSubject(question.exam_teacher_subject)">
                                                            <div class="col-sm-12 col-lg-6 col-xl-6 p-1" v-for="(attachment, index) in getAttachmentsExamTeacherSubject(question.exam_teacher_subject).attachments">
                                                                <div class="card">
                                                                    <div class="card-body py-2 d-flex justify-content-between align-items-center">
                                                                        <div class="d-flex align-items-center">
                                                                            <i class="fas fa-file fa-2x text-primary"></i>
                                                                            <h6 class="ml-1 mb-0"><a :href="attachment.file" target="_blank" class="link-02">Anexo ${index + 1}</a></h6>
                                                                        </div>
                                                                        <div>
                                                                            <template v-if="checkAnswerType(attachment.file)">
                                                                                <a href="javascript:void(0)" class="btn btn-xs btn-primary" data-animation="effect-scale" @click="showAnnotorious(false, false, attachment.file)"><i class="fas fa-image"></i></a>
                                                                            </template>
                                                                            <template v-else>
                                                                                <a :href="attachment.file" target="_blank" class="btn btn-xs btn-primary"><i class="fas fa-download"></i></a>
                                                                            </template>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <span class="text-danger" v-if="question && !getAttachmentsExamTeacherSubject(question.exam_teacher_subject).attachments.length">O aluno não enviou arquivo</span>
                                                        </div>
                                                    {% else %}
                                                        <template v-if="question.corrected_but_no_answer">
                                                            <span class="text-danger">A questão foi corrigida, mas a resposta do aluno não foi detectada automaticamente. Verifique na imagem do cartão ao lado.</span>
                                                        </template>
                                                        <template v-else>
                                                            <template v-if="!(question.file_answer && question.file_answer_url)">
                                                                <br>
                                                                <span class="text-danger">Sem resposta enviada.</span>
                                                            </template>
                                                        </template>
                                                    {% endif %}
                                                </template>
                                                <template v-if="question.category == 'Discursiva'">
                                                    <p v-if="question.textual_answer">
                                                        ${question.textual_answer_content}</p>
                                                    <span class="text-danger" v-else>Sem resposta</span>
                                                </template>
                                            </td>
                                            <td>
                                                <template v-if="question.annuled">
                                                    <div class="d-flex justify-content-end">
                                                        <div class="btn-toolbar" role="toolbar">
                                                            <div class="btn-group mr-2" role="group">
                                                                <button type="button" class="btn btn-secondary" class="btn btn-secondary text-uppercase" disabled>
                                                                    Questão anulada <i class="fas fa-times-circle"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </template>
                                                <template v-else>
                                                    <div class="d-flex justify-content-end" v-if="question.category == 'Objetiva'">
                                                        <div class="btn-toolbar" role="toolbar">
                                                            <div class="btn-group mr-2" role="group">
                                                                <button 
                                                                    type="button" 
                                                                    v-for="(_alternative, indexAlternative) in question.alternatives" 
                                                                    :class="{
                                                                        'btn-success active': question.answer == _alternative.id && _alternative.is_correct,
                                                                        'btn-danger active': question.answer == _alternative.id && !_alternative.is_correct
                                                                    }" 
                                                                    class="btn btn-secondary text-uppercase"
                                                                    @click="updateChoiceAnswer(_alternative.id, question)"
                                                                    :disabled="loadingSaveQuestion.includes(question.id || question.pk)"
                                                                >
                                                                    ${generateAlternativeOrder(indexAlternative)}
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex justify-content-end" v-else>
                                                        <div class="">
                                                            <div class="btn-group">
                                                                <button class="btn btn-link dropdown-toggle" type="button" id="dropdownMenuClickable" data-toggle="dropdown" data-bs-auto-close="inside" aria-expanded="false">
                                                                    + Comentário
                                                                </button>
                                                                <div class="dropdown-menu"  aria-labelledby="dropdownMenuClickable">
                                                                    <form class="px-4 py-3">
                                                                        <div class="d-flex justify-content-end">
                                                                            <div class="form-group">
                                                                                <span class="badge badge-info">Questão ${index+1}</span><br>
                                                                                <label style="text-align: center">Comentário do professor</label>
                                                                                <textarea class="form-control" id="feedback-textarea" @blur="sendTeacherFeedback(question)" rows="3" cols="100" v-model="question.teacher_feedback"></textarea>
                                                                            </div>
                                                                        </div>
                                                                    </form>
                                                                    <div class="dropdown-divider"></div>
                                                                    <a class="dropdown-item">
                                                                        <span class="text-muted">O texto será salvo automaticamente ao sair do<br> campo de comentário.</span></a>
                                                                </div>
                                                                <ul class="dropdown-menu">
                                                                <li>
                                                                    <div class="d-flex justify-content-end">
                                                                        <div class="form-group">
                                                                            <label for="feedback-textarea">Comentário do professor</label>
                                                                            <textarea class="form-control" id="feedback-textarea" @blur="sendTeacherFeedback(question)" rows="10" v-model="question.teacher_feedback"></textarea>
                                                                            <span class="text-muted">O texto será salvo automaticamente ao sair do campo de comentário.</span>
                                                                        </div>
                                                                    </div>
                                                                </li>
                                                                </ul>
                                                            </div>
                                                            <button type="button" class="btn btn-xs btn-danger" title="Atribuir nota zero" @click="selectedQuestion = question, setQuestionList(question, 0, hasCorrection=true)">
                                                                <i class="fas fa-angle-double-down"></i> 0%
                                                            </button>
                                                            <button type="button" class="btn btn-xs btn-warning" title="Atribuir 25% da nota" @click="selectedQuestion = question, setQuestionList(question, (question.question_weight * 0.25).toFixed(4), hasCorrection=true)">
                                                                <i class="fas fa-angle-up"></i> 25%
                                                            </button>
                                                            <button type="button" class="btn btn-xs btn-warning" title="Atribuir metade da nota" @click="selectedQuestion = question, setQuestionList(question, (question.question_weight * 0.5).toFixed(4), hasCorrection=true)">
                                                                <i class="fas fa-angle-up"></i> 50%
                                                            </button>
                                                            <button type="button" class="btn btn-xs btn-warning" title="Atribuir 75% da nota" @click="selectedQuestion = question, setQuestionList(question, (question.question_weight * 0.75).toFixed(4), hasCorrection=true)">
                                                                <i class="fas fa-angle-up"></i> 75%
                                                            </button>
                                                            <button type="button" class="btn btn-xs btn-success" title="Atribuir nota máxima" @click="selectedQuestion = question, setQuestionList(question, question.question_weight, hasCorrection=true)">
                                                                <i class="fas fa-angle-double-up"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-xs btn-secondary" title="Remover nota" v-if="(question.textual_answer || question.file_answer) && question.teacher_grade != null" @click="selectedQuestion = question, setQuestionList(question)">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                        <div class="ml-2">
                                                            <input :class="question.formValid ? question.formValid:''" :id="question.pk" data-type="question.pk" style="width: 120px;" type="number" :tabindex="index+1" class="form-control form-control-sm" v-model="question.teacher_grade" @keyup="question.teacher_grade = $event.target.value, $forceUpdate()" min="0" :max="question.question_weight" @input="question.formValid = ''" @blur="sendTeacherFeedback(question, next = false, hasCorrection=true)" step="0.01" placeholder="0.00">                        
                                                            <div v-if="question.formValid == 'is-invalid'" class="invalid-feedback">Valor maior que a nota</div>
                                                        </div>
                                                    </div>
                                                </template>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </template>
                        <template v-else>
                            <template v-if="applicationStudent.questions.length">
                                <table class="table table-responsive table-bordered" id="student-responses">
                                    <thead>
                                        <tr>
                                            <th>
                                                <a 
                                                    href="#" 
                                                    class="ml-2 float-right" 
                                                    :class="[ordering.category == 'order' ? 'text-primary' : 'text-secondary']" 
                                                    @click.prevent.default="orderQuestions('order')"
                                                >
                                                    <i class="fas fa-sort fa-rotate-90"></i>
                                                </a>
                                            </th>
                                            <th v-for="question in applicationStudent.questions" class="text-center" :class="{'bg-primary-light': question.pk == selectedQuestion.pk}">${question.order}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Resp.</td>
                                            <td 
                                                v-for="answer in applicationStudent.questions" 
                                                data-toggle="popover" 
                                                data-content="<b>Tempo:</b> 12<br><b>Num. repostas: 12</b>" 
                                                data-placement="right"
                                                class="text-center text-secondary"
                                                data-html="true"
                                                :class="getAnswerClass(answer)"
                                                @click="getEnunciation(answer)"
                                            >
                                                <template v-if="answer.annuled">
                                                    <i class="far fa-times-circle"></i>
                                                </template>
                                                <template v-else>
                                                    <template v-if="answer.corrected_but_no_answer">
                                                        <i class="fas fa-user-edit"></i>
                                                    </template>
                                                    <template v-else>
                                                        <i class="fas fa-pen-nib" v-if="answer.category == 'Discursiva' && answer.textual_answer"></i>
                                                        {% if object.group_attachments %}
                                                            <i class="fa fa-paperclip" v-if="answer.category == 'Arquivo anexado'"></i>
                                                        {% else %}
                                                            <i class="fa fa-paperclip" v-if="answer.category == 'Arquivo anexado' && answer.file_answer"></i>
                                                        {% endif %}
                                                    </template>
                                                </template>
                                            </td>
                                        </tr>
                                        <template v-if="!applicationStudent.is_omr">
                                            <tr>
                                                <td>
                                                    <a 
                                                        href="#" 
                                                        class="ml-2 float-right" 
                                                        :class="[ordering.category == 'duration' ? 'text-primary' : 'text-secondary']" 
                                                        @click.prevent.default="orderQuestions('duration')"
                                                    >
                                                        <i class="fas fa-sort fa-rotate-90"></i>
                                                    </a>
                                                    Tempo
                                                </td>
                                                <td v-for="answer in applicationStudent.questions" class="text-center">
                                                    ${answer.duration ? answer.duration.substring(3) : ''}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <a 
                                                        href="#" 
                                                        class="ml-2 float-right" 
                                                        :class="[ordering.category == 'total_answers' ? 'text-primary' : 'text-secondary']" 
                                                        @click.prevent.default="orderQuestions('total_answers')"
                                                    >
                                                        <i class="fas fa-sort fa-rotate-90"></i>
                                                    </a>
                                                    Alterações
                                                </td>
                                                <td v-for="answer in applicationStudent.questions" class="text-center">
                                                    ${answer.total_answers || '-'}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <a 
                                                        href="#" 
                                                        class="ml-2 float-right" 
                                                        :class="[ordering.category == 'last_modified' ? 'text-primary' : 'text-secondary']" 
                                                        @click.prevent.default="orderQuestions('last_modified')"
                                                    >
                                                        <i class="fas fa-sort fa-rotate-90"></i>
                                                    </a>
                                                    Última modificação
                                                </td>
                                                <td v-for="answer in applicationStudent.questions" class="text-center">
                                                    <template v-if="answer.last_modified">
                                                        ${momentRef(answer.last_modified).format('HH:mm')}
                                                    </template>
                                                    <template v-else>
                                                        -
                                                    </template>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                                <div class="row" v-show="selectedQuestion">
                                    <div class="col-12">
                                        <div id="question-details" class="mb-3 p-2" v-show="selectedQuestion.enunciation || (applicationStudent.is_omr && applicationStudent.is_abstract)">
                                            <template v-if="applicationStudent.is_abstract">
                                                Gabarito Avulso: <strong>${applicationStudent.exam_name}</strong> - Questão: <strong>${selectedQuestion.order}</strong>
                                            </template>
                                            <template v-else>
                                                <h6 class="text-center">
                                                    <a data-toggle="collapse" href="#collapseEnunciation" role="button" aria-expanded="false" aria-controls="collapseEnunciation">Ver detalhes da questão <i class="fas fa-chevron-down"></i></a>
                                                </h6>
                                                <div class="collapse" id="collapseEnunciation">
                                                    <div v-html="selectedQuestion.enunciation" class="mb-2"></div>
                                                </div>
                                            </template>
                                            <div class="text-center mt-3" v-if="selectedQuestion.answer_created_by_id && selectedQuestion.answer_created_by_id !== applicationStudent.user_pk">
                                                <span style="white-space: normal; font-size: 13px;" class="badge badge-warning mb-3">
                                                    Resposta alterada manualmente por <b>${selectedQuestion.answer_created_by_name}</b> 
                                                    <br/>em
                                                    <b>${momentRef(selectedQuestion.answer_created_at).format('LLL')}</b>
                                                </span>
                                            </div>
                                            <template v-if="selectedQuestion.category == 'Objetiva'">
                                                <table class="w-100 mt-2">
                                                    <tr v-for="alternative in selectedQuestion.alternatives">
                                                        <td class="form-check" v-if="alternative" :class="getOptionClass(alternative, selectedQuestion.answer)">
                                                            <div class="custom-control custom-radio my-2">
                                                                <input name="alternativa" v-model="alternativeUpdate" class="custom-control-input cp" type="radio" :checked="alternative.id == selectedQuestion.answer" :value="alternative.id" :id="alternative.id">
                                                                <label class="custom-control-label remove-p-margin cp" :for="alternative.id" v-html="alternative.text"></label>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </table>
                                                <button class="btn btn-primary btn-block mt-3" @click="updateChoiceAnswer(alternativeUpdate, selectedQuestion, true)" :disabled="alternativeUpdate == selectedQuestion.answer">
                                                    Salvar resposta
                                                </button>
                                            </template>
                                        </div>
                                        <template v-if="selectedQuestion.category == 'Arquivo anexado'">
                                            {% if object.group_attachments %}
                                                <div class="row row-xs" v-if="getAttachmentsExamTeacherSubject(selectedQuestion.exam_teacher_subject)">
                                                    <div class="col-sm-12 col-lg-6 col-xl-6 p-1" v-for="(attachment, index) in getAttachmentsExamTeacherSubject(selectedQuestion.exam_teacher_subject).attachments">
                                                        <div class="card">
                                                            <div class="card-body py-2 d-flex justify-content-between align-items-center">
                                                                <div class="d-flex align-items-center">
                                                                    <i class="fas fa-file fa-2x text-primary"></i>
                                                                    <h6 class="ml-1 mb-0"><a :href="attachment.file" target="_blank" class="link-02">Anexo ${index + 1}</a></h6>
                                                                </div>
                                                                <div>
                                                                    <template v-if="checkAnswerType(attachment.file)">
                                                                        <a href="javascript:void(0)" class="btn btn-xs btn-primary" data-animation="effect-scale" @click="showAnnotorious(false, false, attachment.file)"><i class="fas fa-image"></i></a>
                                                                    </template>
                                                                    <template v-else>
                                                                        <a :href="attachment.file" target="_blank" class="btn btn-xs btn-primary"><i class="fas fa-download"></i></a>
                                                                    </template>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <span class="text-danger" v-if="selectedQuestion && !getAttachmentsExamTeacherSubject(selectedQuestion.exam_teacher_subject).attachments.length">O aluno não enviou arquivo</span>
                                                </div>
                                            {% else %}
                                                <template v-if="selectedQuestion.corrected_but_no_answer">
                                                    <span class="text-danger">A questão foi corrigida, mas a resposta do aluno não foi detectada automaticamente. Verifique na imagem do cartão ao lado.</span>
                                                </template>
                                                <template v-else>
                                                    <div class="d-flex justify-content-center">
                                                        <template v-if="selectedQuestion.file_answer && selectedQuestion.file_answer_url">
                                                            <img @click="checkAnswerType(selectedQuestion.file_answer_url) ? showAnnotorious():''" :src="checkAnswerType(selectedQuestion.file_answer_url) ? selectedQuestion.file_answer_url:''" class="img-fluid cp" style="max-height: 300px;">
                                                        </template>
                                                        <template v-else>
                                                            <span class="text-danger">Sem resposta lida ou enviada.</span>
                                                        </template>
                                                    </div>
                                                </template>
                                            {% endif %}
                                        </template>
                    
                                        <template v-if="selectedQuestion.category == 'Discursiva'">
                                            <span class="font-weight-bold">Resposta do aluno:</span>
                                            <p v-if="selectedQuestion.textual_answer">
                                                ${selectedQuestion.textual_answer_content}</p>
                                            <span class="text-danger" v-else>Sem resposta</span>
                                        </template>
                    
                                        <template v-if="selectedQuestion.category != 'Objetiva'">
                                            <hr>
                                            <div class="row">
                                                <div class="col-12">
                                                    <div class="d-flex justify-content-between">
                                                        <div>
                                                            <span class="font-weight-bold">Valor da questão:</span>
                                                            <span class="badge badge-info">${selectedQuestion.question_weight}</span>
                                                        </div>
                                                        <div>
                                                            <span class="text-center">
                                                                <a data-toggle="collapse" href="#collapseTeacherComment" role="button" aria-expanded="false" aria-controls="collapseTeacherComment">Adicionar comentário <i class="fas fa-chevron-down"></i></a>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div v-if="!selectedQuestion.text_correction" class="collapse form-group col-12" id="collapseTeacherComment">
                                                    <label for="feedback-textarea">Comentário do professor</label>
                                                    <textarea class="form-control" id="feedback-textarea" rows="3" v-model="selectedQuestion.teacher_feedback"></textarea>
                                                </div>
                                                <hr>
                                                <div v-if="selectedQuestion.text_correction" class="form-check col-12 mb-2">
                                                    <table class="table table-striped">
                                                        <thead id="header" class="thead-dark">
                                                        <tr>
                                                            <th scope="col">Competências</th>
                                                            <th scope="col">Pontos</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody v-for="criterion in selectedQuestion.generate_correction_criterion">
                                                            <tr>
                                                                <td>
                                                                    ${criterion.name}
                                                                </td>
                                                                <td>
                                                                    <div class="btn-group btn-group-toggle mt-1" data-toggle="buttons">
                                                                        <label :class="criterion.checkedLabel == point ? 'active':''" v-for="point in criterion.value" @click="selectedCorrection(criterion.question, criterion.order, point, criterion.id)" class="btn btn-outline-primary btn-xs">
                                                                            <input type="radio" name="line_competence_enem" autocomplete="off">
                                                                            ${point.toString().replace('.',',')}
                                                                        </label>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                    <textarea v-if="!selectedQuestion.text_correction" class="form-control" id="feedback-textarea" rows="3" v-model="selectedQuestion.teacher_feedback"></textarea>
                                                </div>
                                                <div class="form-group col-12">
                                                    <label for="grade">Nota</label>
                                                    <input v-if="selectedQuestion.text_correction" type="number" class="form-control" step='0.01' value='0.00' placeholder='0.00' v-model="totalPoints" :disabled="selectedQuestion.text_correction">
                                                    <input v-else type="number" class="form-control" v-model="selectedQuestion.teacher_grade" @keyup="selectedQuestion.teacher_grade = $event.target.value, $forceUpdate()" id="grade" min="0" :max="selectedQuestion.question_weight" step="0.01" placeholder="0.00">
                                                    <small class="text-danger" v-if="!(parseFloat(selectedQuestion.teacher_grade) >= 0 && parseFloat(selectedQuestion.teacher_grade) <= parseFloat(selectedQuestion.question_weight))">
                                                        O valor da nota deve ser entre 0 e o valor máximo da questão.</small>
                                                </div>
                                                <div class="col-12">
                                                    <div class="d-flex justify-content-between">
                                                        <div v-if="!selectedQuestion.text_correction">
                                                            <button type="button" class="btn btn-xs btn-danger" title="Atribuir nota zero" @click="setGrade(0)">
                                                                0% <i class="fas fa-angle-double-down"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-xs btn-warning" @click="setGrade(parseFloat(selectedQuestion.question_weight * 0.25).toFixed(4))">
                                                                25% <i class="fas fa-angle-up"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-xs btn-warning" @click="setGrade(parseFloat(selectedQuestion.question_weight * 0.5).toFixed(4))">
                                                                50% <i class="fas fa-angle-up"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-xs btn-warning" @click="setGrade(parseFloat(selectedQuestion.question_weight * 0.75).toFixed(4))">
                                                                75% <i class="fas fa-angle-up"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-xs btn-success" title="Atribuir nota máxima" @click="setGrade(selectedQuestion.question_weight)">
                                                                100% <i class="fas fa-angle-double-up"></i>
                                                            </button>
                                                        </div>
                                                        <div class="d-flex justify-content-end">
                                                            <button type="button" class="btn btn-xs btn-secondary" v-if="(selectedQuestion.textual_answer || selectedQuestion.file_answer) && selectedQuestion.teacher_grade != null" title="Deletar nota" @click="removeGrade()">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                            <button type="button" @click="sendTeacherFeedback(selectedQuestion)" class="btn btn-xs btn-primary mx-1" title="Salvar nota" :disabled="!(parseFloat(selectedQuestion.teacher_grade) >= 0 && parseFloat(selectedQuestion.teacher_grade) <= parseFloat(selectedQuestion.question_weight))">
                                                                <i class="fas fa-save"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-xs btn-primary" title="Salvar nota e ir para a próxima questão" :disabled="!(parseFloat(selectedQuestion.teacher_grade) >= 0 && parseFloat(selectedQuestion.teacher_grade) <= parseFloat(selectedQuestion.question_weight))" @click="sendTeacherFeedback(selectedQuestion, true)" v-if="applicationStudent.questions.findIndex(question => question.pk == selectedQuestion.pk) != applicationStudent.questions.length - 1"> <i class="fas fa-arrow-right"></i></button>
                                                        </div>
                                                    </div>
                                                    <div v-if="spinnerFeedbackSaved">
                                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                            <span class="sr-only">Loading...</span>
                                                        </div>
                                                        <span class="text-info">Salvando nota...</span>
                                                    </div>
                                                    <span class="text-info" v-if="!spinnerFeedbackSaved && feedbackSaved && !feedbackError">Correção salva!</span>
                                                    <span class="text-danger" v-if="feedbackError">Erro no envio, tente novamente</span>
                                                </div>
                                            </div>
                                        </template>
                
                                        <template v-if="selectedQuestion.enunciation || applicationStudent.is_abstract">
                                            <p v-if="selectedQuestion.teacher_feedback">
                                                <span class="font-weight-bold">Comentário do professor:</span>
                                                <span>${selectedQuestion.teacher_feedback}</span>
                                            </p>
                                            <p>
                                                <span class="font-weight-bold">Nota do aluno na questão:</span>
                                                <span class="badge badge-info">${selectedQuestion.teacher_grade || 'Não corrigida'}</span>
                                            </p>
                                            <p>
                                                <span class="font-weight-bold">Valor da questão:</span>
                                                <span class="badge badge-info">${selectedQuestion.question_weight}</span>
                                            </p>
                
                                            <div v-if="selectedQuestion.commented_awnser">
                                                <hr>
                                                <h6>Resposta comentada</h6>
                                                <div v-html="selectedQuestion.commented_awnser"></div>
                                            </div>
                            
                                            <div v-if="selectedQuestion.feedback">
                                                <hr>
                                                <h6>Feedback do professor</h6>
                                                <div v-html="selectedQuestion.feedback"></div>
                                            </div>                        
                                        </template>
                                        
                                        <template v-if="selectedQuestion.similar_answers && selectedQuestion.similar_answers.length">
                                            <span class="font-weight-bold">Respostas similares</span>
                                            <span class="badge badge-danger">${selectedQuestion.similar_answers.length} encontradas</span>
                                            <div id="accordion">
                                                <div class="card" v-for="answer in selectedQuestion.similar_answers">
                                                    <div class="card-header p-2">
                                                    <a :href="'#collapse-'+answer.student_application.pk" data-toggle="collapse">
                                                        ${answer.student_application.student}
                                                    </a>
                                                    <span class="badge badge-primary float-right">
                                                        ${(parseFloat(answer.similarity) * 100).toFixed(2)} %
                                                    </span>
                                                    </div>
                                                    <div class="collapse card-body p-2" :id="'collapse-'+answer.student_application.pk" data-parent="#accordion" style="background: #f5f6fa;">
                                                        <p class="mb-0">${answer.content}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </template>
                    </div>
                    <div class="col-6 px-0 bg-light" style="overflow-y: scroll; max-height: 100vh;" v-if="applicationStudent.questions.length && hasFiles()">
                        <div class="text-center px-4 py-2" style="border-left: 3px solid rgb(153, 151, 151);">
                            <button type="button" @click="selectImage(url, ['Objetiva'])" class="btn btn-xs m-1" :class="shownImage == url ? 'btn-primary':'btn-outline-primary'" v-for="(url, index) in applicationStudent.omr_scan_url.objectives_urls.filter(u => u.length)">
                                Folha objetiva <i class="fa fa-list-ul"></i>
                            </button>
                            <button type="button" @click="selectImage(url, ['Discursiva', 'Arquivo anexado'])" class="btn btn-xs m-1" :class="shownImage == url ? 'btn-primary':'btn-outline-primary'" v-for="(url, index) in applicationStudent.omr_scan_url.discursive_urls.filter(u => u.length)">
                                ${index + 1}ª Folha discursiva <i class="fa fa-signature"></i>
                            </button>
                            <template v-if="imgLoading">
                                <h6 class="mt-3">Carregando, aguarde...</h6>
                                <div class="spinner-border text-primary" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                            </template>
                            <img :src="shownImage" id="previewImage" onLoad="app.imgLoading = false" v-show="!imgLoading" class="img-fluid my-3 shadow">
                        </div>
                    </div>
                </div>
                <template v-if="errors.forbidden">
                    <div class="row">
                        <div class="col-12 text-center">
                            <h5 class="text-muted py-4">
                                Você não tem as permissões necessárias para ver as respostas do aluno selecionado.
                                <br>
                                <span class="py-2">Entre em contato com a sua coordenação para maiores informações!</span>
                            </h5>
                            <img src="{% static 'administration/assets/img/img18.png' %}" height="400" alt="Não há questões">
                        </div>
                    </div>
                </template>
                <template v-if="errors.notQuestions">
                    <div class="row">
                        <div class="col-12 text-center">
                            <h5 class="text-muted py-4">
                                Não encontramos questões elaboradas por você.
                                <br>
                                <span class="py-2">Entre em contato com a sua coordenação para maiores informações!</span>
                            </h5>
                            <img src="{% static 'administration/assets/img/img21.png' %}" height="400" alt="Não há questões">
                        </div>
                    </div>
                </template>
                <img id="image" :src="selectedQuestion.file_answer_url" class="d-none">
            </div>
        </div>
    </div>
</div>
</div>

{% endblock content-fixed %}

{% block off-canvas %}
<div id="right-off-canvas" class="off-canvas off-canvas-right wd-400 bg-white" style="overflow-y: auto; overflow-x: hidden;">
    <form action="" method="GET">
        <div class="row p-3">
        <div class="col-12">
            <h5>Filtrar gabaritos</h5>
            <p>Adiciona abaixo os filtros que você deseja aplicar na listagem abaixo</p>
            <hr/>
        </div>

            <div class="col-12">
                <div class="form-group mb-3">
                    <label for="exam_id" class="mb-1">Nome da prova</label>
                    <input name="q_exam" id="exam_id" value="{{q_exam}}" class="form-control">
                </div>
            </div>
            <div class="col-12">
                <div class="form-group mb-3">
                <label for="coordination_id" class="mb-1">Coordenações</label>
                <select name="q_coordination" id="coordination_id" class="form-control" multiple="multiple">
                    {% for coordination in coordinations %}
                    <option value="{{coordination.pk}}" {% if coordination.pk|stringformat:'s' in q_coordination %} selected="selected" {% endif %}>
                        {{coordination}}
                    </option>
                    {% endfor %}
                </select>
                </div>
            </div>
            <div class="col-12">
                <div class="custom-control custom-switch mt-4">
                    <input type="checkbox" id="seen_id" name="q_seen" v-model="seen" class="custom-control-input">
                    <label class="custom-control-label" for="seen_id">
                    <h6 class="mb-0">Remover os marcados como visto</h6>
                    </label>
                    <small class="form-text text-muted mt-0">
                    Selecione essa opção para ver apenas ou uploads que ainda<br/> não foram marcados como visto.
                    </small>
                </div>
            </div>

            <div class="col-12 mt-5">
                <button type="submit" class="btn btn-primary btn-block">
                <i class="fas fa-search"></i>
                Aplicar filtro
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block js-additional %}
  <script src="{% static 'administration/lib/bootstrap-tagsinput/bootstrap-tagsinput.min.js' %}"></script>
  <script src="{% static 'administration/lib/select2/js/select2.min.js' %}"></script>
  <script src="{% static 'js/tippy/popper.min.js' %}"></script>
  <script src="{% static 'js/tippy/tippy.min.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>

  <script>
      var tooltip = Vue.component('tooltip', {
        delimiters: ['#{', '}'],
        props: ['configs'],
        // Parametros para o configs
        // classes > Classes personalizadas
        // objects > Array contendo os objetos
        // attribute > Nome do atributo que será mostrado dentro do span
        // showNumber > Número da quantidade de objetos que serão mostrados
        template: `
          <div>
            <span style="cursor: pointer;" :class="configs.classes ? configs.classes : 'mx-1 badge badge-primary'" :key="index" class="tooltips" :data-tippy-content="configs.attribute ? object[configs.attribute] : object" v-for="(object, index) in configs.objects.slice(0, configs.showNumber)">
              <span v-if="configs.attribute"> #{object[configs.attribute]} </span>
              <span v-else>#{object}</span>
            </span>
            <span style="cursor: pointer;" v-if="configs.objects.length > configs.showNumber && configs.objects.slice(configs.showNumber, configs.objects.length - 1).length" :class="configs.classes ? configs.classes : 'mx-1 badge badge-primary'" class="tooltips" :data-tippy-content="configs.objects.slice(configs.showNumber, configs.objects.length - 1).map(object => object[configs.attribute]).join(', ')">
              ...mais #{configs.objects.slice(configs.showNumber, configs.objects.length - 1).length }
            </span>
          </div>
        `,
      })
      var app = new Vue({
        delimiters: ['${', '}'],
        components: {
            'tooltip': tooltip,
        },
        el: '#app',
        data: {
            shownImage: '',
            shownCategory: 'Objetiva',
            type: [],
            omrUploadDetailUrl: "{% url 'omr:omr_upload_detail' '00000000-0000-0000-0000-000000000000' %}",
            omrUploadCorrectionlUrl: "{% url 'omr:omr_correction_detail' '00000000-0000-0000-0000-000000000000' %}",
            omrUploadMarkCorrectedlUrl: "{% url 'omr:omr_upload_corrected' '00000000-0000-0000-0000-000000000000' %}",
            omrUploadStudentErrorsCount: "{% url 'omr:omr_upload_student_page_error_count' '00000000-0000-0000-0000-000000000000' %}",
            omrUploadStudentErrorsCountStudents: "{% url 'omr:omr_errors_and_students' pk='00000000-0000-0000-0000-000000000000' %}",
            uploads: [
                {% for upload in object_list %}
                    {
                        id: "{{ upload.pk }}",
                        createdDate: "{{ upload.created_at }}",
                        user: "{{ upload.user }}",
                        filename: "{{ upload.filename|default_if_none:'' }}",
                        status: {{ upload.status }},
                        statusDescription: "{{ upload.get_status_display }}",
                        errorsCounter: {{ upload.total_errors_count }},
                        totalPages: {{ upload.total_pages}} + {{ upload.total_errors_count }},
                        classes: [
                            {% for class in upload.get_classes %}
                                {'name': '{{class}}'},
                            {% endfor %}
                        ],
                        studentPageErrorCountLoading: true,
                        studentPageErrorCount: null,
                        students: [],
                        corrected: {{upload.corrected|safe|lower}},
                        seen: {{upload.seen|safe|lower}},
                    },
                {% endfor %}
            ],
            selectedUpload: null,
            selectedStudent: null,
            selectedIndex: 0,
            maxIndex: 0,
            count: 0,
            seen: {{q_seen|default:False|lower}},
            imgLoading: true,
            correctionFast: false,
            {% include 'dashboard/exams/includes/exam-detail-data.js' %}
        },
        methods: {
            {% include 'dashboard/exams/includes/exam-detail-functions.js' %},
            getUrl(url, uploadID) {
                return url.replace('00000000-0000-0000-0000-000000000000', uploadID)
            },
            generateUrl(path) {
                let url = new URL(window.location.href)
                return url.protocol +'//'+ url.host + path
            },
            decimalPlaces(event, limit=4) {
                var value = event.target.value;
                var decimal = value.split(".")[1] || value.split(",")[1] || ""
                if (decimal.length >= limit) {
                    let newValue = parseFloat(value).toFixed(4)
                    this.selectedQuestion.teacher_grade = newValue
                    $("#grade").val(newValue)
                }
            },
            async getData() {
                for (let upload of this.uploads) {
                    await axios(this.getUrl(this.omrUploadStudentErrorsCountStudents, upload.id)).then((response) => {
                        upload.studentPageErrorCountLoading = false
                        upload.studentPageErrorCount = response.data.length
                        upload.students = response.data
                    }).finally(() => this.count++)
                } 
            },
            getFile(category, changeFile) {
                if(this.applicationStudent.omr_scan_url && (this.applicationStudent.omr_scan_url.objectives_urls || this.applicationStudent.omr_scan_url.discursive_urls)) {
                    let objectives_urls = this.applicationStudent.omr_scan_url.objectives_urls.filter(u => u.length)
                    let discursive_urls = this.applicationStudent.omr_scan_url.discursive_urls.filter(u => u.length)
                    
                    if(changeFile) {
                        if(category == 'Objetiva' && objectives_urls.length) {
                            this.shownImage = objectives_urls[0]
                        } else if(discursive_urls.length) {
                            this.shownImage = discursive_urls[0]
                        }
                        this.imgLoading = true
                    }
                }
            },
            uploadCheck(student) {
                $('[data-check]').attr('disabled', true)
                url = "{% url 'omr:omr_students_upload_check' pk='00000000-0000-0000-0000-000000000000'  %}"
                axios.put(url.replace("00000000-0000-0000-0000-000000000000", student.id), { checked: true }).then((response) => {
                    student.checked = response.data
                }).finally(
                    $('[data-check]').attr('disabled', false)
                )
            },
            changeStudent(option) {
                currentIndex = option == 'previous' ? this.selectedIndex-- : this.selectedIndex++
                if(option == 'previous') {
                    this.selectedStudent = this.selectedUpload.students[currentIndex > 0 ? currentIndex - 1 : 0]
                    this.openStudentModal(this.selectedStudent.application_student)
                } else {
                    this.selectedStudent = this.selectedUpload.students[currentIndex < (this.selectedUpload.students.length -1) ? currentIndex + 1: (this.selectedUpload.students.length - 1)]
                    this.openStudentModal(this.selectedStudent.application_student)
                }
            },
            selectImage(url, type) {
                this.imgLoading = true
                this.shownImage = url
                this.type = type
            },
            copyToClipboard(text) {
                navigator.clipboard.writeText(text)
                this.alertTop('Link do aluno copiado!')
            },
            alertTop(text, icon = 'success') {
                Swal.fire({
                    position: 'top-end',
                    text: text,
                    icon: icon,
                    showConfirmButton: false,
                    timer: 1500,
                    toast: true,
                    timerProgressBar: true,
                })
            },
            markCorrected(upload, seen) {
                Swal.fire({
                    title: 'Confirmação',
                    text: seen ? "Você confirma esta ação?":"O Upload irá sumir dessa listagem, você confirma?",
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonText: 'Sim, confirmo',
                    cancelButtonText: 'Cancelar',
                }).then(result => {
                    if (result.isConfirmed) {
                        if(seen) {
                            object = {
                                seen: !upload.seen
                            }
                        } else {
                            object = {
                                corrected: true
                            }
                        }
                        axios.patch(this.getUrl(this.omrUploadMarkCorrectedlUrl, upload.id), object).then((response) => {
                            if(seen) {
                                this.alertTop(`${response.data.seen ? 'Marcado como visto':'Visto desmarcado'}`)
                                upload.seen = response.data.seen
                            } else {
                                this.alertTop(`O upload foi marcado como corrigido`)
                                upload.corrected = response.data.corrected
                            }
                            this.$forceUpdate()
                        }).catch((e) => {
                            this.alertTop('Ocorreu um erro ao tentar alterar o status do upload', 'error')
                        })
                    }
                })
            },
            hasFiles() {
                if((this.applicationStudent && this.applicationStudent.omr_scan_url) && (this.applicationStudent.omr_scan_url.objectives_urls.length || this.applicationStudent.omr_scan_url.discursive_urls.length)) {
                    return true;
                }
                return false;
            },
            momentRef(args) {
              return moment(args)
            },
        },
        watch: {
            selectedQuestion: function(val) {
                let changeFile = !this.type.includes(val.category)
                if(val && val.category) {
                    this.shownCategory = val.category
                    this.getFile(val.category, changeFile)
                }
            }
        },
        mounted() {
            if(window.location.hash) {
                var hash = window.location.hash.substring(1);
                axios(this.getUrl(this.omrUploadStudentErrorsCountStudents, this.uploads.at(0).id)).then((response) => {
                    this.uploads.at(0).studentPageErrorCountLoading = false
                    this.uploads.at(0).studentPageErrorCount = response.data.length
                    this.uploads.at(0).students = response.data
                }).finally(() => {
                    this.count++
                    $(`[data-applicationstudent="${hash}"]`)[0].click()
                })
            } else {
                this.getData()
            }

            //const magnifier = new Magnifier(document.getElementById('lupa'), {
            //    magnifierSize: [150, 150],
            //    magnifierBorderSize: 2,
            //    zoomFactor: 2,
            //    cursorOffset: { x: 50, y: 50 },
            //    magnifierGlass: true,
            //    draggableViewport: false,
            //    viewportOverflow: false,
            //    viewportBorderSize: 0,
            //    container: '#lupa',
            //});

            tippy('.tooltips', {
                placement: 'bottom',
                followCursor: true,
                followCursor: 'horizontal',
                allowHTML: true,
                theme: 'custom',
            })
            
            $('.off-canvas-menu').on('click', function (e) {
                e.preventDefault();
                var target = $(this).attr('data-toggle-off-canvas');
                $(target).addClass('show');
            });

            $('.off-canvas .close').on('click', function (e) {
                e.preventDefault();
                $(this).closest('.off-canvas').removeClass('show');
            })

            $(document).on('click touchstart', function (e) {
                if($(e.target).hasClass('select2-results__option') || $(e.target).hasClass('select2-results__custom_option')) {
                    return
                  }
            e.stopPropagation();

            if (!$(e.target).closest('.off-canvas-menu').length) {
                var offCanvas = $(e.target).closest('.off-canvas').length;
                if (!offCanvas) {
                $('.off-canvas.show').removeClass('show');
                }
            }
            });
                $('#coordination_id').select2({
                    placeholder: "Selecione uma opção",
                    closeOnSelect: false
                });
            },
        }) 
    </script>
{% endblock %}      