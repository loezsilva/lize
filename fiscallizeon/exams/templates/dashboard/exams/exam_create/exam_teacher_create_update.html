{% extends 'redesign/base.html' %}
{% comment %} {% extends 'dashboard/base_fixed.html' %} {% endcomment %}

{% block title %}
    
    {% if object %}
        Editar lista de exercício - Professor - Lize
    {% else %}
        Criar lista de exercício - Professor - Lize
    {% endif %}
        
{% endblock title %}

{% load static %}
{% load widget_tweaks %}
{% load insert_field %}
{% load insert_decimal %}
{% load insert_key %}
{% load insert_last_status %}
{% load insert_status_list %}


{% block css-additional %}
<link href="{% static 'administration/lib/select2/css/select2.min.css' %}" rel="stylesheet" />
<link rel="stylesheet" href="{% static 'administration/lib/quill/quill.snow.css' %}">
<link href="{% static 'administration/lib/bootstrap-tagsinput/bootstrap-tagsinput.css' %}" rel="stylesheet">
<style>
    hr.style-eight {
        overflow: visible;
        /* For IE */
        padding: 0;
        border: none;
        border-top: 1px solid #ccc;
        color: #ccc;
        text-align: center;
    }

    hr.style-eight:after {
        content: "ou";
        display: inline-block;
        position: relative;
        top: -0.8em;
        font-size: 1em;
        padding: 0 0.25em;
        background: white;
    }
</style>
{% endblock css-additional %}

{% comment %}
{% block breadcrumb-fixed %}
<div class="d-sm-flex align-items-center justify-content-between mg-b-20 mg-lg-b-25 mg-xl-b-10">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb breadcrumb-style1 mg-b-10">
                <li class="breadcrumb-item"><a href="{% url 'applications:applications_list' %}">PROVA</a></li>
                <li class="breadcrumb-item active" aria-current="page">
                    {% if object %}
                        ATUALIZAR
                    {% else %}
                        CRIAR
                    {% endif %}
                </li>
            </ol>
        </nav>
        <h4>Gerenciar caderno</h4>
    </div>
    <div class="d-none d-md-block">
        <a href="#" onclick="history.back()" class="btn btn-sm pd-x-15 btn-white btn-uppercase">
            <i data-feather="arrow-left" class="wd-10 mg-r-5"></i> Voltar
        </a>
    </div>
</div>
{% endblock breadcrumb-fixed %}
{% endcomment %}

{% block content-fixed %}
    <div class="ard cer dcv tw-mb-16">
      <div class="ls" style="margin-top: 1rem; margin-bottom: 1rem; justify-content: space-between;">
        <nav class="ls" aria-label="Breadcrumb">
          <ol role="list" class="ls yu abe" style="list-style: none; margin: 0; padding: 0;">
            <li>
              <div>
                <a href="{% url 'core:redirect_dashboard' %}" class="axk bks">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="nu rw uk" style="width: 1.25rem; height: 1.25rem; flex-shrink: 0;">
                    <path fill-rule="evenodd" d="M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 11h-1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-3a1 1 0 00-1-1H9a1 1 0 00-1 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-6H3a1 1 0 01-.707-1.707l7-7z" clip-rule="evenodd"></path>
                  </svg>
                  <span class="t" style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0;">Painel</span>
                </a>
              </div>
            </li>
            <li>
              <div class="ls yu">
                <svg class="nu rw uk axj" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true" style="width: 1.25rem; height: 1.25rem; flex-shrink: 0; color: rgb(209 213 219);">
                  <path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z"></path>
                </svg>
                <a href="{% url 'exams:exams_list' %}" class="js avv avz axm bku" style="margin-left: 1rem; font-size: 0.875rem; line-height: 1.25rem; font-weight: 500;">Cadernos</a>
              </div>
            </li>
            <li>
              <div class="ls yu">
                <svg class="nu rw uk axj" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true" style="width: 1.25rem; height: 1.25rem; flex-shrink: 0; color: rgb(209 213 219);">
                  <path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z"></path>
                </svg>
                <a href="data:text/plain," class="js avv avz axm bku" aria-current="page" style="margin-left: 1rem; font-size: 0.875rem; line-height: 1.25rem; font-weight: 500;">Gerenciar</a>
              </div>
            </li>
          </ol>
        </nav>
        <div class="d-none d-md-block">
          <a href="#" onclick="history.back()" class="btn btn-sm pd-x-15 btn-white btn-uppercase">
            <i data-feather="arrow-left" class="wd-10 mg-r-5"></i> Voltar
          </a>
        </div>
      </div>
    <form id="form-exam" method="GET" onsubmit="return false;">
        <div class="row">
            <div class="col-8">
                <div class="card mg-b-10">
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="myTab" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" data-toggle="tab" href="#questions-elaboration" role="tab">
                                    Caderno
                                </a>
                            </li>
                        </ul>
                        <div class="tab-content bd bd-gray-300 bd-t-0" id="myTabContent">
                            <div class="tab-pane fade show active" id="questions-elaboration" role="tabpanel" aria-labelledby="home-tab">
                                <div class="col-12 pt-3">
                                    <div class="form-group">
                                        <label for="name">Nome do caderno</label>
                                        <input type="text" v-model="exam.name" class="form-control" id="name" name="name" placeholder="Nome do caderno" required>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-group mt-4">
                                        <label for="">Onde serão mostrados os textos base?</label>
                                        <div class="d-flex">
                                        
                                        <div class="btn-group btn-group-toggle" data-toggle="buttons">
                                            <label @click="exam.base_text_location = 0" class="btn btn-outline-primary btn-lg" v-bind:class="exam.base_text_location == 0 ? 'active':''" for="id_per_question">
                                                <input type="radio" name="base_text_location" id="id_per_question" value="0" autocomplete="off" checked>
                                                <i class="fas fa-file-alt"></i>
                                                <span>
                                                    Por questão
                                                </span>
                                            </label>
                                                <label @click="exam.base_text_location = 1" class="btn btn-outline-primary btn-lg" v-bind:class="exam.base_text_location == 1 ? 'active':''" for="id_exam_top">
                                                <input type="radio" name="base_text_location" id="id_exam_top" value="1" autocomplete="off" checked>
                                                <i class="fas fa-file-import"></i>
                                                <span>
                                                    Por disciplina
                                                </span>
                                            </label>
                                            <label @click="exam.base_text_location = 2" class="btn btn-outline-primary btn-lg" v-bind:class="exam.base_text_location == 2 ? 'active':''" for="id_subject_top">
                                                <input type="radio" name="base_text_location" id="id_subject_top" value="2" autocomplete="off">
                                                <i class="fas fa-file-upload"></i>
                                                <span>
                                                    Início do caderno
                                                </span>
                                            </label>
                                            <label @click="exam.base_text_location = 3" class="btn btn-outline-primary btn-lg" v-bind:class="exam.base_text_location == 3 ? 'active':''" for="id_subject_bottom">
                                                <input type="radio" name="base_text_location" id="id_subject_bottom" value="3" autocomplete="off">
                                                <i class="fas fa-file-download"></i>
                                                <span>
                                                    Final do caderno
                                                </span>
                                            </label>
                                        </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-row">
                                        <div class="col-md-4">
                                            <div class="custom-control custom-switch ">
                                                <input type="checkbox" id="id_random_alternatives" class="custom-control-input" v-model="exam.random_alternatives">
                                                <label class="custom-control-label" for="id_random_alternatives">
                                                    <i class="fas fa-random"></i> Randomizar alternativas?
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="custom-control custom-switch">
                                                <input type="checkbox" id="id_random_questions" class="custom-control-input" v-model="exam.random_questions">
                                                <label class="custom-control-label" for="id_random_questions">
                                                    <i class="fas fa-random"></i> Randomizar questões?
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="custom-control custom-switch">
                                                <input type="checkbox" id="id_group_by_topic" class="custom-control-input" v-model="exam.group_by_topic">
                                                <label class="custom-control-label" for="id_group_by_topic">
                                                    <i class="fas fa-list"></i> Randomizar disciplinas?
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-12 mt-3">
                                            <div class="custom-control custom-switch ">
                                            <input type="checkbox" id="is_english_spanish" class="custom-control-input" v-model="exam.is_english_spanish">
                                            <label class="custom-control-label" for="is_english_spanish">
                                                Caderno com língua estrangeira
                                            </label>
                                            <small class="form-text text-muted mt-0" style="line-height: initial;">
                                                Marque esta opção se este caderno inicia com 5 questões de ingês e 5 de espanhol
                                            </small>
                                            </div>
                                        </div>
                                        <div class="col-md-12 mt-3 mb-0 alert alert-warning" v-if="exam.is_english_spanish">
                                            <span class="tx-18">Você deve selecionar 5 questões de <strong>inglês</strong> e 5 de <strong>espanhol</strong></span>
                                        </div>
                                    </div>
                                </div>
                                <draggable :list="exam.teacher_subjects" @change="changeObjectsOrder(exam.teacher_subjects)"class="list-group" ghost-class="ghost" @start="dragging = true" @end="dragging = false">    
                                    <div class="col-12 my-4" v-for="(teacherSubject, teacherSubjectIndex) in exam.teacher_subjects">
                                        <div class="card">
                                            <div class="card-header py-2" style="cursor: move;">
                                                <div class="d-flex justify-content-between align-items-center" v-if="teacherSubject">
                                                    <h6 data-toggle="collapse" style="cursor: pointer;" :href="'#teacherSubject'+teacherSubjectIndex" class="tooltips" data-tippy-content="Clique para minimizar ou maximizar">
                                                        ${teacherSubject.subject_name ? teacherSubject.subject_name : teacherSubject.teacher_subject.subject.name} <br>
                                                        <span class="text-muted">${teacherSubject.grade_name ? teacherSubject.grade_name : teacherSubject.grade.full_name}</span>
                                                        <br>
                                                        <span class="text-muted">${teacherSubject.subject_knowledge_area ? teacherSubject.subject_knowledge_area : teacherSubject.teacher_subject.subject.knowledge_area_name }</span>
                                                    </h6>
                                                    <div>
                                                        <button type="button" class="btn btn-danger btn-sm tooltips" data-tippy-content="Clique para remover esta disciplina e todas as questões seleciondas" @click="removeSubject(teacherSubject, teacherSubjectIndex)"><i class="fas fa-times"></i></button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div class="collapse show" :id="'teacherSubject'+teacherSubjectIndex">
                                                    <div class="row d-flex align-items-center justify-content-between mb-0" v-if="teacherSubject.questions && teacherSubject.questions.length">
                                                        <div class="col-12 col-lg-4">
                                                            <h6>
                                                                Nota da disciplina: <br> ${sumWeight(teacherSubject.questions).toFixed(4)}
                                                            </h6>
                                                        </div>
                                                        <div class="col-12 col-lg-4">
                                                            <div class="form-group">
                                                                <div class="input-group mg-b-10" @click="selectedTeacherSubject = teacherSubject">
                                                                    <input class="form-control form-control-sm" type="number" placeholder="Distribuir pesos" v-model="teacherSubject.weights">
                                                                    <div class="input-group-append tooltips" data-tippy-content="Utilize para distribuir pesos igualmente entre as questões selecionadas">
                                                                        <button type="button" class="btn btn-success btn-sm" @click="distributeWeights(teacherSubject)"><i class="fas fa-sync"></i></button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <template v-if="teacherSubject.questions && teacherSubject.questions.length">
                                                        <draggable :list="teacherSubject.questions" @change="changeObjectsOrder('', teacherSubject.questions)"class="list-group" ghost-class="ghost" @start="dragging = true" @end="dragging = false">
                                                            <div class="list-group-item" v-for="(examQuestion, examQuestionIndex) in teacherSubject.questions" :key="examQuestion.id" style="cursor: move;">
                                                                <span class="float-right text-right">
                                                                    <button type="button" @click="openModal('/questoes/'+examQuestion.question.pk+'/editar/?is_popup=1'), selectedTeacherSubject = teacherSubject" class="btn btn-xs btn-link m-0 p-0"> <span class="fas fa-edit" aria-hidden="true"></span> 
                                                                    </button>
                                                                    
                                                                    <button type="button" class="btn btn-xs btn-link text-danger m-0 p-0" @click="removeExamQuestion(examQuestion, examQuestionIndex), selectedTeacherSubject = teacherSubject">
                                                                        <span class="fas fa-trash" aria-hidden="true"></span>
                                                                    </button>
                                                                    <input v-model="examQuestion.weight" @change="distributeWeights(teacherSubject, examQuestion)" :id="'weight_'+examQuestion.id" placeholder="Nota" type="number" step="any" class="form-control weight-input" style="width: 70px;" required>
                                                                </span>
                                                                <div>
                                                                    <div class="w-100">
                                                                        
                                                                        <span class="badge badge-dark">
                                                                            ${examQuestionIndex + 1}
                                                                        </span>
                                                                        <span v-if="examQuestion.question.adapted" class="badge badge-dark">
                                                                            Questão adaptada
                                                                        </span>                            
                                                                        <h6 class="mb-1">
                                                                            ${examQuestion.question.enunciation}
                                                                        </h6>                                               
                                                                    </div>
                                                                    <p class="mb-1">
                                                                        <span class="badge badge-secondary" v-if="examQuestion.question.topic_name">
                                                                            ${examQuestion.question.topic_name}
                                                                        </span>
                                                                        
                                                                        <span class="badge badge-secondary">Utilizada
                                                                            ${examQuestion.question.used_times} Vez(es)
                                                                        </span>
                                                                        <span class="badge badge-secondary">${examQuestion.question.get_level_display}</span>
                                                                    </p>
                                                                    <!-- <p class="mb-1">
                                                                        <span class="badge badge-secondary">Texto(s) Utilizado(s):</span>
                                                                    </p> -->
                                                                </div>
                                                            </div>
                                                        </draggable>
                                                    </template>
                                                    <template v-else-if="!teacherSubject.questions">
                                                        <div class="alert alert-warning">
                                                            <h6>
                                                                Você só poderá adicionar questões após salvar o caderno.
                                                            </h6>
                                                        </div>
                                                    </template>
                                                </div>
                                                <template v-if="teacherSubject.questions && !teacherSubject.questions.length">
                                                    <h5 class="text-muted">Você ainda não adicionou nenhuma questão para esta disciplina</h5>
                                                </template>
                                                <hr>
                                                <button type="button" class="btn btn-outline-primary btn-sm col-12" :class="selectedTeacherSubject.id == teacherSubject.id ? 'active' : ''" @click="openOffCanvas(), selectedTeacherSubject = teacherSubject" v-if="teacherSubject.id"> Adicionar Questão <i class="fas fa-plus"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </draggable>

                                <div class=" d-flex flex-row align-items-baseline align-self-center justify-content-end p-3">
                                    <div class="btn-group" role="group" aria-label="Basic example">
                                        {% if object %}
                                            <button type="submit" class="btn btn-outline-success mt-2">
                                                <i class="fas fa-save"></i> Salvar Parcialmente
                                            </button>
                                            <button type="submit" class="btn btn-primary mt-2" @click="createApplication = true">
                                                <i class="fas fa-save"></i> Salvar e criar aplicação
                                            </button>
                                        {% else %}
                                            <button type="submit" class="btn btn-primary mt-2" v-if="exam.teacher_subjects.length">
                                                <i class="fas fa-save"></i> Criar Caderno e adicionar questões
                                            </button>
                                        {% endif %}
                                        
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="questions-base-texts">
                                <template v-if="baseTexts.length > 0">
                                    <div class="col-md-12 p-0" id="question-container">
                                        
                                        <h6 class="text-muted mt-3">
                                            Lista com todos os textos associados a esta prova
                                        </h6>

                                        <div class="mt-4" v-for="(baseText, index) in baseTexts" :key="baseText.id">
                                            <span class="float-right text-right">
                                                <button type="button" class="btn btn-xs btn-link m-0 p-0" @click="selectBaseText(baseText)" data-toggle="modal" data-target="#modalBaseTextDetail"> <span class="fas fa-eye" aria-hidden="true"></span></button>
                                            </span>
                                            <div>
                                                <div class="w-100">

                                                    <span class="badge badge-dark" :id="'baseText_'+baseText.id">
                                                        TEXTO BASE <span class="ml-1">${index + 1}</span>
                                                    </span>
                                                    <h6 class="my-1">${baseText.short_text}</h6>
                                                
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                                <template v-else>
                                    <div class="col-12 p-2">
                                        <h6>
                                            Essa prova ainda não tem texto base associado. 
                                        </h6>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div style="position: -webkit-sticky; position: sticky; top: 100px;">
                    <div class="card">
                        <div class="card-header pd-t-20 pd-b-0 bd-b-0">
                            <h6 class="mg-b-5">Suas Disciplinas</h6>
                            <p class="tx-12 tx-color-03 mg-b-0">Seleciona as disciplinas que você deseja adicionar a esse caderno.</p>
                        </div>
                        <div class="card-body p-0 mt-4">
                            <div class="ro">
                                <div class="col-12">
                                    <div class="form-group mb-3">
                                        <label for="id_grade_input">Séries</label>
                                        <select name="grade_input" id="id_grade_input" class="form-control">
                                            <option value=""></option>
                                            <option :value="grade.id" v-for="grade in grades">${grade.name}</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="id_subjects_input">Disciplinas</label>
                                        <select name="subject_input" id="id_subjects_input" multiple class="form-control">
                                            <option value=""></option>
                                            <template v-if="selectedGrade">
                                                <option :value="subject.id" v-for="subject in selectedGrade.subjects">${subject.name} - ${selectedGrade.name}</option>
                                            </template>
                                        </select>
                                    </div>
                                    <div class="form-group my-3">
                                        <button type="button" class="btn btn-success btn-block" @click="selectSubject()" :disabled="!selectedGrade.id || !selectedSubjects.length">Selecionar Disciplina(s) <i class="fas fa-plus"></i></button>
                                    </div>
                                    {% if not object %}
                                        <template v-if="exam.teacher_subjects.length">
                                            <hr class="style-eight">
                                            <div class="form-group my-3">
                                                <button type="submit" class="btn btn-primary btn-block mt-2"><i class="fas fa-save"></i> Criar Caderno e adicionar questões</button>
                                            </div>
                                        </template>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock content-fixed %}

{% block off-canvas %}
    <div class="off-canvas off-canvas-right wd-400 bg-white" style="overflow-y: auto; overflow-x: hidden;">
        <div class="card mg-b-10">
            <div class="card-body">
                <h5>Adicione as questões na prova</h5>
                <div class="form-group mb-2">
                    Procure a questão abaixo
                    <select name="search-question" id="search-question" class="form-control question">
                    </select>
                    <p class="text-muted" style="font-size: 13px; line-height: 13px;">
                        O texto pesquisado acima será procurado apenas no enunciado de cada questão em seu banco de questões. Para uma busca mais detalhada utilze o botão abaixo.
                    </p>
                </div>
                <hr class="style-eight">
                <div class="btn-group btn-group-justified" role="group" aria-label="Basic example">
                    <button type="button" @click='openModal("{% url "questions:questions_list" %}?is_popup=1")' class="btn btn-primary mt-2">
                        <i class="fas fa-search"></i> Busca detalhada de questão
                    </button>
                    {% if user.client_has_public_questions %}
                        <button type="button" @click='openModal("{% url "questions:public_questions_list" %}?is_popup=1")' class="btn btn-outline-primary mt-2 ">
                            <i class="fas fa-globe-americas"></i> Buscar questão Lize
                        </button>
                    {% endif %}
                </div>

                <hr class="style-eight">
                <button type="button" class="btn btn-primary btn-block" @click='openModal(`{% url "questions:questions_create" %}?is_popup=1&exam_teacher=${selectedTeacherSubject.id}`)'>
                    <i class="fas fa-plus"></i>
                    Criar e adicionar nova questão
                </button>
                <hr class="style-eight">
                <a :href="questionsBankUrl(selectedTeacherSubject.id)" class="btn btn-primary btn-block ">
                    <i class="fas fa-book"></i>
                    Buscar no banco de questões
                </a>
                {% if user.client_has_superpro_integration or user.superprofintegration_set.exists or user.inspector.enable_integration_superpro_via_file %}
                    <hr class="style-eight" />
                    <button
                        type="button"
                        class="btn btn-primary btn-block"
                        @click="handleSuperProfImportViaFile()"
                    >
                        <i class="fas fa-file-import"></i>
                        Importar do Super Professor via arquivo
                    </button>
                {% endif %}
                <hr class="style-eight">
                <button type="button" class="btn btn-primary btn-block" data-toggle="modal" data-target="#importQuestionsModal">
                    <i class="fas fa-upload"></i> 
                    Importar de modelo docx
                </button>
                <hr>

                <div class="btn-group btn-group-justified d-flex" role="group" aria-label="Basic example">
                    <button type="submit" class="btn btn-outline-success mt-2">
                        <i class="fas fa-save"></i> Salvar parcialmente
                    </button>
                    <button type="button" @click="$('.off-canvas-right').removeClass('show'), selectedTeacherSubject = ''" class="btn btn-secondary mt-2">
                        <i class="fas fa-save"></i> Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra-modal %}
<div aria-hidden="true" class="modal fade" id="importQuestionsModal" role="dialog" tabindex="-1">
    <div class="modal-dialog modal-md" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Importar questões do Word (.docx)</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="max-height: fit-content; height: fit-content;">
                <h6>Você pode importar questões para a prova a partir de um documento Word.</h6>
                <p>
                    Informações importantes:
                    <ul>
                        <li>O documento deve seguir o modelo de importação que <a class="font-weight-bold" href="{% static 'modelo_importacao_fiscallize.docx' %}">pode ser baixado aqui</a>.</li>
                        <li>Confira atentamente as instruções contidas no modelo disponibilizado acima.</li>
                        <li>As questões importadas aparecerão nesta página e ficarão disponíveis no seu banco de questões.</li>
                    </ul>
                </p>
                <hr>
                <form method="POST">
                    {% csrf_token %}
                    <div class="form-row">                         
                        <div class="col-12">
                            <div class="form-group mb-2">
                                <label for="" class="mb-0 mt-1">Escolher arquivo com as questões</label>
                                <input type="file" name="questions_doc" class="form-control-file" accept=".docx" required="required">
                                <p class="text-muted"><b>Tipos permitidos:</b> .docx</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer pb-0">
                        {% csrf_token %}
                        <div class="form-buttons-w text-right">
                            <button class="btn btn-secondary" data-dismiss="modal" type="button">
                                <i class="os-icon os-icon-cancel-circle"></i>
                                <span>Cancelar</span>
                            </button>
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-upload"></i>
                                <span>Importar questões</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div id="modalSuperProfImportViaFile" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered wd-sm-400" role="document">
        <div class="modal-content">
            <div class="modal-body pd-20 pd-sm-40 h-100">
            <a href="" role="button" class="close pos-absolute t-15 r-15" data-dismiss="modal" aria-label="Fechar">
                <span aria-hidden="true">&times;</span>
            </a>
            <div>
                <div class="d-sm-flex align-items-center justify-content-between">
                <div>
                    <h4 class="mg-b-5">Importar caderno</h4>
                    <p class="mg-b-0 tx-color-03">Adicione o arquivo de um caderno criado anteriormente na plataforma do Super Professor</p>
                </div>
                </div>
                <div>
                <div class="mt-3">
                    <form @submit.prevent="submitFormIntegrationSuperProViaFile" method="post">
                    <template v-if="formIntegrationSuperProViaFile.status !== 'submitting'">
                        <div class="form-group">
                        <input type="file" id="superProViaFileInputFile" @change="onChangeFormIntegrationSuperProViaFileFile" required />
                        </div>
                        <button
                        type="submit"
                        class="btn btn-primary btn-block"
                        :disabled="formIntegrationSuperProViaFile.status === 'submitting'"
                        >
                        ${ formIntegrationSuperProViaFile.status === 'submitting' ? 'Enviando...' : 'Enviar arquivo' }
                        </button>
                    </template>
                    <template v-else-if="formIntegrationSuperProViaFile.status === 'submitting'">
                        <div class="mg-t-40">
                        <div class="alert alert-outline alert-warning d-flex align-items-center" role="alert">
                            <i class="fas fa-exclamation-triangle mg-r-10"></i> Esse processo pode demorar um pouco, aguarde enquanto convertemos o caderno do Super Professor para o nosso sistema.
                        </div>
                        <div class="text-center">
                            <p class="tx-13 tx-lg-12 tx-xl-13 tx-color-03 mg-b-2">
                            Importando o caderno:
                            </p>
                        </div>
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Carregando...</span>
                            </div>
                        </div>
                        </div>
                    </template>
                    <template v-if="formIntegrationSuperProViaFile.status === 'error-uploading'">
                        <p class="tx-danger tx-12 mt-2">Ocorreu um erro ao tentar enviar o arquivo para nossos servidores. Por favor, tente novamente em alguns instantes.</p>
                    </template>
                    <template v-if="formIntegrationSuperProViaFile.status === 'error-converting'">
                        <p class="tx-danger tx-12 mt-2">Ocorreu um erro ao tentar converter o arquivo. Por favor, tente novamente em alguns instantes.</p>
                    </template>
                    <template v-if="formIntegrationSuperProViaFile.status === 'error-importing'">
                        <p class="tx-danger tx-12 mt-2">Ocorreu um erro ao tentar importar o arquivo. Por favor, tente novamente em alguns instantes.</p>
                    </template>
                    </form>
                </div>
                </div>
            </div>
            </div>
        </div>
    </div>
</div>
{% endblock extra-modal %}

{% block js-additional %}
<script src="{% static 'administration/lib/typeahead.js/typeahead.bundle.min.js' %}"></script>
<script src="{% static 'administration/lib/bootstrap-tagsinput/bootstrap-tagsinput.min.js' %}"></script>
<script src="{% static 'administration/lib/select2/js/select2.min.js' %}"></script>
<script src="{% static 'administration/assets/vendor/jquery.mask.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.26.0/moment-with-locales.min.js"></script>
<script src="{% static 'js/tippy/popper.min.js' %}"></script>
<script src="{% static 'js/tippy/tippy.min.js' %}"></script>


<script type="text/javascript">
    moment.locale('pt-br');
    var app_question = new Vue({
        delimiters: ['${', '}'],
        el: '#app',
        data: {
            exam: {
                id: '',
                name: '',
                base_text_location: 0,
                is_english_spanish: false,
                random_alternatives: false,
                random_questions: false,
                group_by_topic: false,
                teacher_subjects: [],
            },
            grades: [
                {% for grade in grades %}
                    {
                        id: '{{ grade.id }}',
                        name: '{{ grade.name }}',
                        subjects: [
                            {% for subject in grade.subjects %}
                                {
                                    id: '{{ subject.id }}',
                                    name: '{{ subject.name }}',
                                    knowledge_area: '{{ subject.knowledge_area }}',
                                },
                            {% endfor %}
                        ]
                    },
                {% endfor %}
            ],
            selectedQuestion: '',
            selectedTeacherSubject: '',
            selectedSubjects: '',
            selectedGrade: '',
            selectedSubject: '',
            baseTexts: [],
            dragging: false,
            isEnglishSpanish: false,
            createApplication: false,
            recalculateWeights: false,
            swaping: false,
            superProModal: 'initial-loading',
            formIntegrationSuperProViaFile: {
                status: 'idle',
                file: '',
            },
            formIntegrationSuperPro: {
                status: 'idle',
                email: '',
                password: '',
                code: '',
            },
            superProData: {
                user: null,
                alreadyIntegratedWithSuperpro: false,
                status: 'idle',
                exams: [],
                selectedExam: {
                    status: 'idle',
                    data: null,
                    dataConvert: null,
                },
            },
        },
        watch: {
            'selectedTeacherSubject.weights': function(newValue) {
                if(newValue && newValue < 0) {
                    this.selectedTeacherSubject.weights = 1
                }
            }
        },
        methods: {
            async handleSuperProfImportViaFile() {
                $('#modalSuperProfImportViaFile').modal('show');
            },
            onChangeFormIntegrationSuperProViaFileFile(event) {
                this.formIntegrationSuperProViaFile.file = event.target.files[0];
            },
            async getExamsSuperPro() {
                return await this.clientSuperPro(
                    'GET',
                    'provas',
                    { 'Authorization': `Bearer ${this.superProData.user.accessToken}` }
                )
            },
            async submitFormIntegrationSuperPro() {
                this.formIntegrationSuperPro.status = 'submitting';
            
                let superProDataUser;
                if (this.superProData.alreadyIntegratedWithSuperpro) {
                    console.log('Already Sync') // TODO: REMOVE
                    superProDataUser = await this.handleLoginSuperPro();
                } else {
                    console.log('Sign Up') // TODO: REMOVE
                    await this.signUpSuperPro();
                
                    superProDataUser = await this.handleLoginSuperPro();
                }
                if (this.formIntegrationSuperPro.status !== 'error' && this.formIntegrationSuperPro.status !== 'invalid-credentials') {
                    await this.patchTeacherSuperProfData({ superpro_data: superProDataUser });
                    this.superProData.user = superProDataUser;
                
                    this.formIntegrationSuperPro.status = 'idle';
                
                    this.superProData.status = 'loading';
                    this.superProModal = 'exams';
                    const response = await this.getExamsSuperPro();
                    this.superProData.exams = response.responseList;
                    this.superProData.status = 'idle';
                }
            },
            async clientSuperPro(method, path, headers = {}, body) {
                const isFormData = headers['Content-Type'] === 'application/x-www-form-urlencoded'
                if (isFormData) {
                    body = Object.keys(body).map(key => encodeURIComponent(key) + '=' + encodeURIComponent(body[key])).join('&')
                } else {
                    body = JSON.stringify(body)
                }
                const defaultHeaders = {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                }
            
                const url = new URL(path, '{{ SUPER_PROFESSOR_URL }}').toString();
                const response = await fetch(url, {
                    method,
                    body,
                    headers: {...defaultHeaders, ...headers},
                    mode: 'cors',
                    // credentials: 'same-origin',
                    redirect: 'follow',
                    referrerPolicy: 'no-referrer',
                })
                if (!response.ok) {
                    throw response;
                }
                const data = await response.json();
                return data;
            },
            async signUpSuperPro() {
                return await this.clientSuperPro(
                    'POST',
                    'signup',
                    {},
                    {
                        email: this.formIntegrationSuperPro.email,
                        nome: 'empty',
                        cpf_cnpj: 'empty',
                        senha: 'empty',
                        data_nascimento: '1900-01-01',
                        genero: 'OUTRO',
                        client_id: {{ SUPER_PROFESSOR_CLIENT_ID|default:'null' }},
                    }
                )
            },
            async submitFormIntegrationSuperProViaFile() {
                let examTeacherSubjectFile;
                let questions;
                
                this.formIntegrationSuperProViaFile.status = 'submitting';

                try {
                    examTeacherSubjectFile = await this.uploadExamTeacherSubjectFile(
                        this.formIntegrationSuperProViaFile.file,
                        this.selectedTeacherSubject.id,
                    );
                } catch(error) {
                    console.error({ error });
                    this.formIntegrationSuperProViaFile.status = 'error-uploading';
                }
                try {
                    questions = await this.convertDocx2Html(examTeacherSubjectFile.file);
                } catch(error) {
                    console.error({ error });
                    this.formIntegrationSuperProViaFile.status = 'error-converting';
                }
                try {
                    await this.importAllQuestions(questions);
                    this.formIntegrationSuperProViaFile.status = 'success';
                } catch(error) {
                    console.error({ error });
                    this.formIntegrationSuperProViaFile.status = 'error-importing';
                }
            },
            async uploadExamTeacherSubjectFile(file, examTeacherSubject) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('exam_teacher_subject', examTeacherSubject);
                const response = await fetch('{% url "api:exam-teacher-subject-file-upload" %}', {
                    method: 'POST',
                    headers: {
                        // 'Content-Type': 'multipart/form-data'
                    },
                    body: formData,
                });
                if (!response.ok) {
                    throw response;
                }
                const data = await response.json();
                return data;
            },
            async convertDocx2Html(url) {
                const response = await fetch('{{ SUPER_PROFESSOR_URL_DOCX2HTML_SERVICE }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url }),
                });
                if (!response.ok) {
                    throw response;
                }
                const data = await response.json();
                return data;
            },
            lessThanADay(firstDate, secondDate) {
                const differenceInDays = secondDate.getTime() - firstDate.getTime()
                const difference = differenceInDays / (1000 * 3600 * 24);
                return difference < 1;
            },
            async handleSuperProfImport() {
                $('#modalSuperProfImport').modal('show');
                const data = await this.getTeacherSuperProfData();
                this.superProData.alreadyIntegratedWithSuperpro = data.already_integrated_with_superpro;
                if (data.superpro_data) {
                    this.superProData.user = data.superpro_data;
                    if (this.lessThanADay(new Date(), new Date(this.superProData.user.accessTokenExpiresAt))) {
                    console.log('accessToken expired')
                        if (this.lessThanADay(new Date(), new Date(this.superProData.user.refreshTokenExpiresAt))) {
                        this.superProModal = 'login';
                        } else {
                        console.log('renew accessToken')
                        }
                    } else {
                        this.superProData.status = 'loading';
                        this.superProModal = 'exams';
                        try {
                        const response = await this.getExamsSuperPro();
                        this.superProData.exams = response.responseList;
                        this.superProData.status = 'idle';
                        } catch (error) {
                        console.log({ error });
                        this.superProData.exams = [];
                        this.superProData.status = 'failed';
                
                        this.superProModal = 'login';
                        this.formIntegrationSuperPro.status = 'idle';
                        }
                    }
                } else {
                    this.superProModal = 'login';
                }
            },
            async importQuestion(question) {
                const url = "{% url 'api:superprof-import-questions-and-create-exam-question' %}";
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                        'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            question: question,
                            exam_teacher_subject_id: this.selectedTeacherSubject.id,
                        }),
                    });
                    if (!response.ok) {
                        throw response;
                    }
                    const data = await response.json();
                
                    this.selectedTeacherSubject.questions.push(data);
                    this.alertTop('A questão foi adicionada com sucesso');
                } catch (error) {
                    console.log({ error });
                    if (error.status == 302) {
                        this.alertTop('A questão já foi utilizada no caderno', 'info');
                    } else {
                        this.alertTop('Ocorreu um erro ao tentar adicionar a questão.', 'error');
                    }
                }
            },
            async importAllQuestions(fullQuestions) {
                for (const question of fullQuestions) {
                    await this.importQuestion(question);
                }
            },
            questionsBankUrl(examTeacherSubjectID) {
                {% if user.inspector.skip_introduction_questions_bank %}
                    return "{% url 'exams:exam_teacher_subject_add_questions' pk='00000000-0000-0000-0000-000000000000' %}?is_exercise_list=true".replace('00000000-0000-0000-0000-000000000000', examTeacherSubjectID)
                {% else %}
                    return "{% url 'exams:teacher-questions-bank-introduction' pk='00000000-0000-0000-0000-000000000000' %}?is_exercise_list=true".replace('00000000-0000-0000-0000-000000000000', examTeacherSubjectID)
                {% endif %}
            },
            openOffCanvas() {
                $('.off-canvas-right').addClass('show')
            },
            moment(date) {
                return moment(date)
            },
            selectSubject() {
                {% if object %}
                    Swal.fire({
                        title: 'Confirmação?',
                        text: "Você confirma que quer adicionar esta disciplina ao caderno?",
                        icon: 'info',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Confirmo!',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            url  = "{% url 'exams:api-exam-create-exam-teacher-subject' pk='00000000-0000-0000-0000-000000000000' %}?multiple_subjects=true"
                            teacher_subjects = []
                            this.selectedSubjects.forEach((subject) => {
                                teacher_subjects.push({
                                    subject: subject.id,
                                    subject_name: subject.name,
                                    subject_knowledge_area: subject.subject_knowledge_area,
                                    grade: subject.grade,
                                    grade_name: subject.grade_name,
                                    quantity: 0,
                                })
                            })
                            if(teacher_subjects.length) {
                                axios.post(url.replace('00000000-0000-0000-0000-000000000000', this.exam.id), teacher_subjects).then((response) => {
                                    response.data.forEach((teacher_subject) => {
                                        this.exam.teacher_subjects.push(teacher_subject)
                                    })
                                    this.alertTop('Disciplina(s) adicionada(s) com sucesso!')
                                }).catch((error) => {
                                    this.alertError('Ocorreu um erro ao adicionar a disciplina ao caderno.')
                                })
                            }
                        }
                    }).finally(() => {
                        $('#id_grade_input').val('').trigger('change')
                        this.resetInputs()
                    })
                {% else %}
                    this.selectedSubjects.forEach((subject) => {
                        this.exam.teacher_subjects.push({
                            subject: subject.id,
                            subject_name: subject.name,
                            subject_knowledge_area: subject.subject_knowledge_area,
                            grade: subject.grade,
                            grade_name: subject.grade_name,
                            quantity: 0,
                            order: this.exam.teacher_subjects.length
                        })
                    })
                    $('#id_grade_input').val('').trigger('change')
                    this.resetInputs()
                {% endif %}
            },
            resetInputs() {
                $('#id_subjects_input').val([]).trigger('change')
                this.selectedSubjects = []
            },
            saveExam() {
                let url = "{% url 'exams:api-exam-list' %}"
                let method = "POST"
                {% if object %}
                    url = "{% url 'exams:api-exam-detail' object.pk %}"
                    method = 'PUT'
                {% endif %}

                if(this.createApplication) {
                    url += '?create_application=true'
                }
                axios({
                    url,
                    method,
                    data: this.exam
                }).then((response) => {
                    if(response.status == 201){
                        url  = "{% url 'exams:exam_teacher_update' pk='00000000-0000-0000-0000-000000000000' %}"
                        window.location.href = url.replace('00000000-0000-0000-0000-000000000000', response.data.id)
                        return
                    } 
                    if(response.data.redirect_url) {
                        window.location.href = response.data.redirect_url
                        return
                    }
                    window.location.href = "{% url 'exams:exams_list' %}"
                }).catch((error) => {
                    $('button').prop('disabled', false)
                })
            },
            {% include "dashboard/exams/includes/exam-teacher-create-functions.js" %}
        },
        mounted: function() {
            {% include "dashboard/exams/includes/exam-teacher-create-mounted.js" %}
            {% if object %}
                axios.get("{% url 'exams:api-exam-detail' object.pk %}").then((response) => {
                    this.exam = response.data
                })
            {% endif %}
            $('#id_grade_input').on('select2:select select2:unselect', (e) => {
                $('#id_subjects_input').val([]).trigger('change');
                this.selectedGrade = ''
                new Promise((resolve, reject) => {
                    resolve(this.grades.find((grade) => grade.id == e.params.data.id))
                }).then(grade => this.selectedGrade = grade)
            })
            $('#id_subjects_input').on('select2:select select2:unselect', (e) => {
                let subjects = []
                $('#id_subjects_input').val().forEach((grade) => {
                    subject = this.selectedGrade.subjects.find((_subject) => _subject.id == grade)
                    subject['grade'] = this.selectedGrade.id
                    subject['grade_name'] = this.selectedGrade.name
                    subject['subject_knowledge_area'] = subject.knowledge_area
                    subjects.push(subject)
                })
                this.selectedSubjects = subjects
            })
            setTimeout(() => {
                tippy('.tooltips', {
                    placement: 'bottom',
                    allowHTML: true,
                    theme: 'custom',
                })
            }, 1000)
            $('form#form-exam').on('submit', function(e) {
                self.saveExam()
            })
        }
    })
</script>
{% endblock %}