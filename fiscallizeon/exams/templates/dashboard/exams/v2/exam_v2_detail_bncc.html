{% extends 'redesign/base.html' %}
{% comment %} {% extends 'dashboard/base_fixed.html' %} {% endcomment %}
{% load round_to %}
{% load math %}
{% load proportion %}
{% load static %}
{% load exams_tags %}
{% load remove_line_break %}
{% load questions_tags %}

{% block css-additional %}
  <link rel="stylesheet" href="{% static 'dashboard/lib/apexcharts/apexcharts.css' %}">  
  <link href="{% static 'administration/lib/select2/css/select2.min.css' %}" rel="stylesheet" />
  <link href="{% static 'administration/lib/bootstrap-tagsinput/bootstrap-tagsinput.css' %}" rel="stylesheet">
  <style>
    @media print {
      .pagebreak {
          clear: both;
          page-break-inside: always;
      }
      button, .hidden-print{
        display:none !important;
      }
  }
  </style>
{% endblock css-additional %}

{% block content %}
<main id="app">
  <div class="ard cer dcv tw-mb-16">
    <div class="ls" style="margin-top: 1rem; margin-bottom: 1rem; justify-content: space-between;">
      <nav class="ls" aria-label="Breadcrumb">
        <ol role="list" class="ls yu abe" style="list-style: none; margin: 0; padding: 0;">
          <li>
            <div>
              <a href="{% url 'core:redirect_dashboard' %}" class="axk bks">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="nu rw uk" style="width: 1.25rem; height: 1.25rem; flex-shrink: 0;">
                  <path fill-rule="evenodd" d="M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 11h-1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-3a1 1 0 00-1-1H9a1 1 0 00-1 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-6H3a1 1 0 01-.707-1.707l7-7z" clip-rule="evenodd"></path>
                </svg>
                <span class="t" style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0;">Painel</span>
              </a>
            </div>
          </li>
          <li>
            <div class="ls yu">
              <svg class="nu rw uk axj" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true" style="width: 1.25rem; height: 1.25rem; flex-shrink: 0; color: rgb(209 213 219);">
                <path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z"></path>
              </svg>
              <a href="{% url 'exams:exams_list' %}?category=exam" class="js avv avz axm bku" style="margin-left: 1rem; font-size: 0.875rem; line-height: 1.25rem; font-weight: 500;">Cadernos</a>
            </div>
          </li>
          <li>
            <div class="ls yu">
              <svg class="nu rw uk axj" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true" style="width: 1.25rem; height: 1.25rem; flex-shrink: 0; color: rgb(209 213 219);">
                <path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z"></path>
              </svg>
              <a href="data:text/plain," class="js avv avz axm bku" aria-current="page" style="margin-left: 1rem; font-size: 0.875rem; line-height: 1.25rem; font-weight: 500;">Detalhes</a>
            </div>
          </li>
        </ol>
      </nav>
      {% include "dashboard/exams/includes/exam/exam-nav-links.html" with page="comparations" %}
    </div>
    <div class="row row-xs" id="divPrint">
      <div class="col-12 mg-t-10">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mg-b-0">CADERNO: {{ object.name }} <span class="badge badge-primary align-middle ml-2">Utilizado {{object.count_applications_count}} vez(es)</span></h6>
            <div class="float-right text-right">
              <button class="btn btn-sm btn-info btn-icon rounded-pill" @click="printPDF('divPrint')">
                <i class="fas fa-print"></i> Exportar PDF          
              </button>
              <button data-toggle-off-canvas="#right-off-canvas"
                class="btn btn-sm btn-info btn-icon rounded-pill off-canvas-menu">
                <i class="fas fa-search"></i> Filtrar Resultados           
                {% if count_filters > 0 %}
                <span class="badge badge-danger">{{count_filters}} Aplicado(s)</span>
                {% endif %}
              </button>
              {% if count_filters > 0 %}
              <a href="{% url 'exams:dash_exam_teacher_detail_bncc' pk=object.pk %}"
                class="btn btn-sm btn-info btn-icon rounded-pill">
                <i class="fas fa-eraser"></i> Apagar filtro(s)
              </a>
              {% endif %}
            </div>
          </div>
          <div class="card-body pd-0">
            <div class="row no-gutters">
              <div class="col col-sm-6 col-lg bd-t bd-sm-t-0 bd-sm-l">
                <div class="crypto">
                  <div class="media mg-b-10">
                    <div class="crypto-icon bg-primary">
                      <i class="fas fa-chart-pie"></i>
                    </div>
                    <div class="media-body pd-l-8">
                      <h6 class="tx-11 tx-spacing-1 tx-uppercase tx-semibold mg-b-5">
                        Assuntos abordados
                      </h6>
                      <div class="d-flex align-items-baseline tx-rubik">
                        <h5 class="tx-20 mg-b-0">{{ total_topics }}</h5>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col col-sm-6 col-lg bd-t bd-sm-t-0 bd-sm-l">
                <div class="crypto">
                  <div class="media mg-b-10">
                    <div class="crypto-icon bg-primary">
                      <i class="fas fa-chart-pie"></i>
                    </div>
                    <div class="media-body pd-l-8">
                      <h6 class="tx-11 tx-spacing-1 tx-uppercase tx-semibold mg-b-5">
                        Habilidades
                      </h6>
                      <div class="d-flex align-items-baseline tx-rubik">
                        <h5 class="tx-20 mg-b-0">{{ total_abilities }}</h5>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col col-sm-6 col-lg bd-t bd-sm-t-0 bd-sm-l">
                <div class="crypto">
                  <div class="media mg-b-10">
                    <div class="crypto-icon bg-primary">
                      <i class="fas fa-chart-pie"></i>
                    </div>
                    <div class="media-body pd-l-8">
                      <h6 class="tx-11 tx-spacing-1 tx-uppercase tx-semibold mg-b-5">
                        Competências
                      </h6>
                      <div class="d-flex align-items-baseline tx-rubik">
                        <h5 class="tx-20 mg-b-0">{{ total_competences }}</h5>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 mg-t-10">
        <div class="card">
          <div class="card-body pt-2">
            <div class="nav-wrapper mg-b-20 tx-13">
              <nav class="nav nav-line tx-medium">
                <a href="#topics" class="nav-link active" data-toggle="tab">Assuntos Abordados <span class="badge badge-primary">#{bncc.topics.list.length}</span></a>
                <a href="#abilities" class="nav-link" data-toggle="tab">Habilidades <span class="badge badge-primary">#{bncc.abilities.list.length}</span></a>
                <a href="#competences" class="nav-link" data-toggle="tab">Competências <span class="badge badge-primary">#{bncc.competences.list.length}</span></a>
              </nav>
            </div>
  
            <div class="tab-content">
              <div id="topics" class="tab-pane fade active show">
                <div class="col-12 mg-t-10">
                  <div class="row card-events" v-show="!load">
                    <template v-for="(topic, index) in bncc.topics.list">
                      <template>
                        <div class="col-lg-6 my-2">
                          <div class="media-body rounded ml-0 pt-2 h-100" :class="{'event-panel-green': topic.sumary.percentage_of_hits.toFixed(0) >= 50, 'event-panel-gray': topic.sumary.percentage_of_hits.toFixed(0) < 50}">
                            <div class="row">
                              <div class="col-12">
                                <div class="d-flex justify-content-between mb-1">
                                  <div>
                                    <h4 class="tx-bold cp" v-if="topic.code"><span v-if="topic.code" data-toggle="popover" data-placement="bottom" data-content="Código da habilidade">(#{topic.code})</span></h4>
                                  </div>
                                  <button class="btn btn-outline-primary btn-xs" @click="selectedObject = topic, selectedObject['type'] = 'topic', getDetail(topic, 'classes'), getDetail(selectedObject, 'unities')" data-toggle="modal" data-target="#modalBNCCDetail" :disabled="!topic.sumary.percentage_of_hits > 0"><i class="fas fa-eye" data-toggle="popover" data-placement="bottom" data-content="Ver detalhes da habilidade"></i></button>
                                </div>
                                <h6 class="text-primary tx-bold mb-2">#{topic.text}</h6>
                              </div>
                              <div class="col-12">
                                <div class="row mb-0">
                                  <div class="col-12">
                                    <h6 class="tx-bold text-muted my-2">
                                      <span v-if="topic.sumary.total_questions == 1">Uma questão utiliza esta habilidade</span>
                                      <span v-else-if="topic.sumary.total_questions > 1">#{topic.sumary.total_questions} questões utilizam esta habilidade</span>
                                      <span v-else>Nenhuma questão utiliza esta habilidade</span>
                                    </h6>
                                  </div>
                                  <div class="col" v-if="topic.acting_field">
                                    <h6 class="tx-bold mb-0">
                                      Campos de atuação
                                    </h6>
                                    <p class="tx-12 mb-1">#{topic.acting_field}</p>
                                  </div>
                                  <div class="col-6" v-if="topic.axis">
                                    <h6 class="tx-bold mb-0">
                                      Eixo
                                    </h6>
                                    <p class="tx-12 mb-1">#{topic.axis}</p>
                                  </div>
                                  <div class="col-6" v-if="topic.language_practice">
                                    <h6 class="tx-bold mb-0">
                                      Prática de linguagem
                                    </h6>
                                    <p class="tx-12 mb-1">#{topic.language_practice}</p>
                                  </div>
                                </div>
                              </div>
                              <div class="col-12">
                                <div class="d-flex align-items-end justify-content-between my-0">
                                  <h6 class="tx-normal tx-rubik tx-color-03 op-6 lh-2 mg-b-0">#{topic.sumary.total_answers} Respostas</h6>
                                  <h6 class="tx-normal tx-rubik tx-color-03 op-6 text-success lh-2 mg-b-0">#{topic.sumary.total_correct_objetives} Acertos</h6>
                                  <h6 class="tx-normal tx-rubik tx-color-03 op-6 text-danger lh-2 mg-b-0">#{topic.sumary.total_incorrect_objetives} Erros</h6>
                                  <h5 class="tx-normal tx-rubik lh-2 tx-20 mg-b-0 cp" data-toggle="popover" data-placement="bottom" data-content="Desempenho dos alunos nessa habilidade">#{topic.sumary.percentage_of_hits.toFixed(2)}%</h5>
                                </div>
                                <div class="progress ht-4 mg-b-0 op-5" style="height: 15px;">
                                  <div class="progress-bar" :class="{'bg-teal': topic.sumary.percentage_of_hits.toFixed(0) > 50, 'bg-pink': topic.sumary.percentage_of_hits.toFixed(0) < 50}" role="progressbar" :style="'width: ' + topic.sumary.percentage_of_hits.toFixed(0) + '%;'" :aria-valuenow="topic.sumary.percentage_of_hits.toFixed(0)" aria-valuemin="0" aria-valuemax="100"></div>
                                  <div class="progress-bar bg-secondary op-3" role="progressbar" :style="'width: ' + (100 -topic.sumary.percentage_of_hits.toFixed(0)) + '%;'" :aria-valuenow="(100 -topic.sumary.percentage_of_hits.toFixed(0))" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </template>
                    </template>
                    <div class="col-12" v-if="!bncc.topics.list.length">
                      <div class="alert alert-secondary" role="alert">
                        Não há assuntos abordados
                      </div>
                    </div>
                  </div>
                  <div class="row" v-if="load">
                    <p class="text-center">Aguarde enquanto carregamos os dados 
                      <div class="spinner-border text-info mx-3" role="status">
                        <span class="sr-only"></span>
                      </div>
                    </p>
                  </div>
                </div>
              </div>
              <div id="abilities" class="tab-pane fade">
                <div class="col-12 mg-t-10">
                  <div class="row card-events" v-show="!load">
                    <template v-for="(ability, index) in bncc.abilities.list">
                      <template>
                        <div class="col-lg-6 my-2">
                          <div class="media-body rounded ml-0 pt-2 h-100" :class="{'event-panel-green': ability.sumary.percentage_of_hits.toFixed(0) > 50, 'event-panel-gray': ability.sumary.percentage_of_hits.toFixed(0) < 50}">
                            <div class="row">
                              <div class="col-12">
                                <div class="d-flex justify-content-between mb-1">
                                  <div>
                                    <h4 class="tx-bold cp" v-if="ability.code"><span v-if="ability.code" data-toggle="popover" data-placement="bottom" data-content="Código da habilidade">(#{ability.code})</span></h4>
                                  </div>
                                  <button class="btn btn-outline-primary btn-xs" @click="selectedObject = ability, selectedObject['type'] = 'ability', getDetail(ability, 'classes'), getDetail(selectedObject, 'unities')" data-toggle="modal" data-target="#modalBNCCDetail" :disabled="!ability.sumary.percentage_of_hits > 0"><i class="fas fa-eye" data-toggle="popover" data-placement="bottom" data-content="Ver detalhes da habilidade"></i></button>
                                </div>
                                <h6 class="text-primary tx-bold mb-2">#{ability.text}</h6>
                              </div>
                              <div class="col-12">
                                <div class="row mb-0">
                                  <div class="col-12">
                                    <h6 class="tx-bold text-muted my-2">
                                      <span v-if="ability.sumary.total_questions == 1">Uma questão utiliza esta habilidade</span>
                                      <span v-else-if="ability.sumary.total_questions > 1">#{ability.sumary.total_questions} questões utilizam esta habilidade</span>
                                      <span v-else>Nenhuma questão utiliza esta habilidade</span>
                                    </h6>
                                  </div>
                                  <div class="col" v-if="ability.acting_field">
                                    <h6 class="tx-bold mb-0">
                                      Campos de atuação
                                    </h6>
                                    <p class="tx-12 mb-1">#{ability.acting_field}</p>
                                  </div>
                                  <div class="col-6" v-if="ability.axis">
                                    <h6 class="tx-bold mb-0">
                                      Eixo
                                    </h6>
                                    <p class="tx-12 mb-1">#{ability.axis}</p>
                                  </div>
                                  <div class="col-6" v-if="ability.language_practice">
                                    <h6 class="tx-bold mb-0">
                                      Prática de linguagem
                                    </h6>
                                    <p class="tx-12 mb-1">#{ability.language_practice}</p>
                                  </div>
                                </div>
                              </div>
                              <div class="col-12">
                                <div class="d-flex align-items-end justify-content-between my-0">
                                  <h6 class="tx-normal tx-rubik tx-color-03 op-6 lh-2 mg-b-0">#{ability.sumary.total_answers} Respostas</h6>
                                  <h6 class="tx-normal tx-rubik tx-color-03 op-6 text-success lh-2 mg-b-0">#{ability.sumary.total_correct_objetives} Acertos</h6>
                                  <h6 class="tx-normal tx-rubik tx-color-03 op-6 text-danger lh-2 mg-b-0">#{ability.sumary.total_incorrect_objetives} Erros</h6>
                                  <h5 class="tx-normal tx-rubik lh-2 tx-20 mg-b-0 cp" data-toggle="popover" data-placement="bottom" data-content="Desempenho dos alunos nessa habilidade">#{ability.sumary.percentage_of_hits.toFixed(2)}%</h5>
                                </div>
                                <div class="progress ht-4 mg-b-0 op-5" style="height: 15px;">
                                  <div class="progress-bar" :class="{'bg-teal': ability.sumary.percentage_of_hits.toFixed(0) > 50, 'bg-pink': ability.sumary.percentage_of_hits.toFixed(0) < 50}" role="progressbar" :style="'width: ' + ability.sumary.percentage_of_hits.toFixed(0) + '%;'" :aria-valuenow="ability.sumary.percentage_of_hits.toFixed(0)" aria-valuemin="0" aria-valuemax="100"></div>
                                  <div class="progress-bar bg-secondary op-3" role="progressbar" :style="'width: ' + (100 -ability.sumary.percentage_of_hits.toFixed(0)) + '%;'" :aria-valuenow="(100 -ability.sumary.percentage_of_hits.toFixed(0))" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </template>
                    </template>
                    <div class="col-12" v-if="!bncc.abilities.list.length">
                      <div class="alert alert-secondary" role="alert">
                        Não há habilidades
                      </div>
                    </div>
                  </div>
                  <div class="row" v-if="load">
                    <p class="text-center">Aguarde enquanto carregamos os dados 
                      <div class="spinner-border text-info mx-3" role="status">
                        <span class="sr-only"></span>
                      </div>
                    </p>
                  </div>
                </div>
              </div>
  
              <div id="competences" class="tab-pane fade">
                <div class="col-12 mg-t-10">
                  <div class="row card-events" v-show="!load">
                    <template v-for="(competence, index) in bncc.competences.list">
                      <template>
                        <div class="col-lg-6 my-2">
                          <div class="media-body rounded ml-0 pt-2 h-100" :class="{'event-panel-green': competence.sumary.percentage_of_hits.toFixed(0) > 50, 'event-panel-gray': competence.sumary.percentage_of_hits.toFixed(0) < 50}">
                            <div class="row">
                              <div class="col-12">
                                <div class="d-flex justify-content-between mb-1">
                                  <div>
                                    <h4 class="tx-bold cp" v-if="competence.code"><span v-if="competence.code" data-toggle="popover" data-placement="bottom" data-content="Código da habilidade">(#{competence.code})</span></h4>
                                  </div>
                                  <button class="btn btn-outline-primary btn-xs" @click="selectedObject = competence, selectedObject['type'] = 'competence', getDetail(competence, 'classes'), getDetail(selectedObject, 'unities')" data-toggle="modal" data-target="#modalBNCCDetail" :disabled="!competence.sumary.percentage_of_hits > 0"><i class="fas fa-eye" data-toggle="popover" data-placement="bottom" data-content="Ver detalhes da habilidade"></i></button>
                                </div>
                                <h6 class="text-primary tx-bold mb-2">#{competence.text}</h6>
                              </div>
                              <div class="col-12">
                                <div class="row mb-0">
                                  <div class="col-12">
                                    <h6 class="tx-bold text-muted my-2">
                                      <span v-if="competence.sumary.total_questions == 1">Uma questão utiliza esta habilidade</span>
                                      <span v-else-if="competence.sumary.total_questions > 1">#{competence.sumary.total_questions} questões utilizam esta habilidade</span>
                                      <span v-else>Nenhuma questão utiliza esta habilidade</span>
                                    </h6>
                                  </div>
                                  <div class="col" v-if="competence.acting_field">
                                    <h6 class="tx-bold mb-0">
                                      Campos de atuação
                                    </h6>
                                    <p class="tx-12 mb-1">#{competence.acting_field}</p>
                                  </div>
                                  <div class="col-6" v-if="competence.axis">
                                    <h6 class="tx-bold mb-0">
                                      Eixo
                                    </h6>
                                    <p class="tx-12 mb-1">#{competence.axis}</p>
                                  </div>
                                  <div class="col-6" v-if="competence.language_practice">
                                    <h6 class="tx-bold mb-0">
                                      Prática de linguagem
                                    </h6>
                                    <p class="tx-12 mb-1">#{competence.language_practice}</p>
                                  </div>
                                </div>
                              </div>
                              <div class="col-12">
                                <div class="d-flex align-items-end justify-content-between my-0">
                                  <h6 class="tx-normal tx-rubik tx-color-03 op-6 lh-2 mg-b-0">#{competence.sumary.total_answers} Respostas</h6>
                                  <h6 class="tx-normal tx-rubik tx-color-03 op-6 text-success lh-2 mg-b-0">#{competence.sumary.total_correct_objetives} Acertos</h6>
                                  <h6 class="tx-normal tx-rubik tx-color-03 op-6 text-danger lh-2 mg-b-0">#{competence.sumary.total_incorrect_objetives} Erros</h6>
                                  <h5 class="tx-normal tx-rubik lh-2 tx-20 mg-b-0 cp" data-toggle="popover" data-placement="bottom" data-content="Desempenho dos alunos nessa habilidade">#{competence.sumary.percentage_of_hits.toFixed(2)}%</h5>
                                </div>
                                <div class="progress ht-4 mg-b-0 op-5" style="height: 15px;">
                                  <div class="progress-bar" :class="{'bg-teal': competence.sumary.percentage_of_hits.toFixed(0) > 50, 'bg-pink': competence.sumary.percentage_of_hits.toFixed(0) < 50}" role="progressbar" :style="'width: ' + competence.sumary.percentage_of_hits.toFixed(0) + '%;'" :aria-valuenow="competence.sumary.percentage_of_hits.toFixed(0)" aria-valuemin="0" aria-valuemax="100"></div>
                                  <div class="progress-bar bg-secondary op-3" role="progressbar" :style="'width: ' + (100 -competence.sumary.percentage_of_hits.toFixed(0)) + '%;'" :aria-valuenow="(100 -competence.sumary.percentage_of_hits.toFixed(0))" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </template>
                    </template>
                    <div class="col-12" v-if="!bncc.competences.list.length">
                      <div class="alert alert-secondary" role="alert">
                        Não há competências
                      </div>
                    </div>
                  </div>
                  <div class="row" v-if="load">
                    <p class="text-center">Aguarde enquanto carregamos os dados 
                      <div class="spinner-border text-info mx-3" role="status">
                        <span class="sr-only"></span>
                      </div>
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <div class="modal fade effect-sign" id="modalBNCCDetail" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
      <div class="modal-content">
        <div class="modal-body pd-x-30 pd-sm-x-30" v-if="selectedObject">
          <a href="" role="button" class="close pos-absolute t-15 r-15" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">×</span>
          </a>

          <div class="nav-wrapper mg-b-20 tx-13">
            <div>
              <nav class="nav nav-line tx-medium">
                <a href="#comparate_classes" class="nav-link active" data-toggle="tab">Comparar Turmas</a>
                <a href="#comparate-unities" class="nav-link" data-toggle="tab">Comparar Unidades</a>
              </nav>
            </div>
          </div>

          <div class="tab-content">
            <div id="comparate_classes" class="tab-pane fade active show">
              <div class="row no-gutters" v-if="selectedObject">
                <div class="col-12 bg-white rounded-right">
                  <div class="ht-100p d-flex flex-column justify-content-center pb-3">
                    <h4 class="mg-b-10 mg-md-b-10">
                      #{ selectedObject.code ? '('+selectedObject.code+') ' : '' } #{selectedObject.knowledge_object}
                    </h4>
                    <div class="tx-14 tx-md-16 tx-color-02 clean-v-html" v-html="selectedObject.text"></div>
                  </div>
                </div>
              </div>

              <div class="row" v-if="selectedClasses.length > 0">
                <div class="col-12">
                  <div class="d-flex my-2">
                    <h6 class="mb-0">Turmas Selecionadas</h6>
                    <span class="badge badge-primary mx-1 cp" @click="selectedClasses = []">Desselecionar todas</span>
                  </div>
                  <span class="badge badge-primary rounded-pill m-1 cp" v-for="classe in selectedClasses">#{classe.name} <span class="badge badge-danger rounded-circle" @click="selectClasse(classe)">x</span></span>
                  <button class="btn btn-outline-primary btn-xs" v-if="classes.length > 2" :disabled="selectedClasses.length < 2" @click="getDetail(selectedObject, 'classes')">Comparar Turmas <i class="fas fa-angle-double-down"></i></button>
                </div>
              </div>
              <div class="row" v-if="!(selectedClasses.length == classes.length)">
                <div class="col-12">
                  <div class="d-flex my-2">
                    <h6 class="mb-0">Todas as turmas</h6>
                    <span class="badge badge-primary mx-1 cp" @click="selectedClasses = [], classes.forEach((classe) => selectedClasses.push(classe))">Selecionar todas</span>
                  </div>
                  <span class="badge badge-primary rounded-pill m-1 cp" v-for="classe in classes" v-if="!selectedClasses.find((_classe) => _classe.id == classe.id)" @click="selectClasse(classe)">#{classe.name}</span>
                </div>
              </div>
              <template v-if="classes.length">
                <div class="divider-text">Comparação entre turmas</div>
                <div v-show="loads.comparateClassesSummary" class="mb-4 mt-2 text-center">
                  <h5>Aguarde enquanto carregamos os dados...</h5>
                  <div class="text-primary">
                    <div class="spinner-border"></div>
                  </div>
                </div>
                <div class="row m-0" v-show="!loads.comparateClassesSummary">
                  <div class="col-12">
                    <div id="comparateClassesChart"></div>
                  </div>
                </div>
              </template>
              <template v-else>
                <h5 class="text-muted">Não há turmas para serem comparadas</h5>
              </template>  
            </div>
            <div id="comparate-unities" class="tab-pane fade">
              <div class="row no-gutters" v-if="selectedObject">
                <div class="col-12 bg-white rounded-right">
                  <div class="ht-100p d-flex flex-column justify-content-center pb-3">
                    <h4 class="mg-b-10 mg-md-b-10">
                      #{ selectedObject.code ? '('+selectedObject.code+') ' : '' } #{selectedObject.knowledge_object}
                    </h4>
                    <div class="tx-14 tx-md-16 tx-color-02 clean-v-html" v-html="selectedObject.text"></div>
                  </div>
                </div>
              </div>              
              <div class="row no-gutters" v-if="selectedUnities.length > 0">
                <div class="col-12">
                  <div class="d-flex my-2">
                    <h6 class="mb-0">Unidades Selecionadas</h6>
                    <span class="badge badge-primary mx-1 cp" @click="selectedUnities = []">Desselecionar todas</span>
                  </div>
                  <span class="badge badge-primary rounded-pill m-1 cp" v-for="unity in selectedUnities">#{unity.name} <span class="badge badge-danger rounded-circle" @click="selectUnity(unity)">x</span></span>
                  <button class="btn btn-primary btn-xs" v-if="unities.length > 2" :disabled="selectedUnities.length < 2" @click="getDetail(selectedObject, 'unities')">Comparar Unidades</button>
                </div>
              </div>
              <div class="row" v-if="!(selectedUnities.length == unities.length)">
                <div class="col-12">
                  <div class="d-flex my-2">
                    <h6 class="mb-0">Todas as unidades</h6>
                    <span class="badge badge-primary mx-1 cp" @click="selectedUnities = [], unities.forEach((unity) => selectedUnities.push(unity))">Selecionar todas</span>
                  </div>
                  <span class="badge badge-primary rounded-pill m-1 cp" v-for="unity in unities" v-if="!selectedUnities.find((_unity) => _unity.id == unity.id)" @click="selectUnity(unity)">#{unity.name}</span>
                </div>
              </div>
              <template v-if="unities.length">
                <div class="divider-text">Comparação entre unidades</div>
                <div v-show="loads.comparateUnitiesSummary" class="mb-4 mt-2 text-center">
                  <h5>Aguarde enquanto carregamos os dados...</h5>
                  <div class="text-primary">
                    <div class="spinner-border"></div>
                  </div>
                </div>
                <div class="row m-0" v-show="!loads.comparateUnitiesSummary">
                  <div class="col-12">
                    <div id="comparateUnitiesChart"></div>
                  </div>
                </div>
              </template>
              <template v-else>
                <h5 class="text-muted">Não há unidades para serem comparadas</h5>
              </template>  
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-block btn-primary mb-2" data-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>
</main>

{% endblock content %}

{% block off-canvas %}
  <div id="right-off-canvas" class="off-canvas off-canvas-right wd-400 bg-white"
    style="overflow-y: auto; overflow-x: hidden;">
    <form action="" method="GET">
      <div class="row p-3">
        <div class="col-12">
          <h5>Filtrar cadernos</h5>
          <p>Adiciona abaixo os filtros que você deseja aplicar na listagem abaixo</p>
          <hr/>
        </div>

        <div class="col-12">
          <div class="form-group mb-3">
            <label for="id_application" class="mb-1">Aplicações</label>
            <select name="q_applications" id="id_application" class="form-control">
              {% for application in applications %}
                <option value="{{application.id}}" {% if application.id|stringformat:'s' in q_applications %} selected="selected" {% endif %}>
                  {{application.date|date:'d/m/Y'}} {{application.start}} as {{application.end}} com {{application.students.count}} alunos
              </option>
              {% endfor %}
            </select>
          </div>
        </div>

        {% comment %} <div class="col-12">
          <div class="custom-control custom-switch ">
            <input {% if q_has_questions %}checked="checked"{% endif %} type="checkbox" id="has_questions_id" name="q_has_questions" class="custom-control-input">
            <label class="custom-control-label" for="has_questions_id">Provas com questões</label>
            <small class="form-text text-muted mt-0">Selecione caso queira ver apenas provas com questões já cadastradas.</small>
          </div>
        </div> {% endcomment %}
        
        <div class="col-12 mt-5">
          <button type="submit" class="btn btn-primary btn-block">
            <i class="fas fa-search"></i>
            Aplicar filtro
          </button>
        </div>
      </div>
    </form>
  </div>
{% endblock %}

{% block js-additional %}
<script src="{% static 'administration/lib/bootstrap-tagsinput/bootstrap-tagsinput.min.js' %}"></script>
<script src="{% static 'administration/lib/select2/js/select2.min.js' %}"></script>
<script src="{% static 'dashboard/lib/apexcharts/apexcharts.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/print_this.js' %}"></script>


<script>
  var app = new Vue({
    delimiters: ["#{", "}"],
    el: "#app",
    data: {
      load: true,
      urls: {
        abilityDetail: "{% url 'api:bncc:ability_retrieve_api' pk='00000000-0000-0000-0000-000000000000' %}",
        competencesDetail: "{% url 'api:bncc:competence_retrieve_api' pk='00000000-0000-0000-0000-000000000000' %}",
        topicDetail: "{% url 'api:bncc:topic_retrieve_api' pk='00000000-0000-0000-0000-000000000000' %}",
        applicationStudentDetails: "{% url 'applications:application_exam_student_detail_v2' pk='00000000-0000-0000-0000-000000000000' %}",
      },
      list_type: '{{list_type|default:"grid"}}',
      classes: [
        {% for classe in classes %}
          {
            id: '{{classe.id}}',
            name: '{{classe.coordination.unity.name}} - {{classe.name}}',
          },
        {% endfor %}
      ],
      unities: [
        {% for unity in unities %}
          {
            id: '{{unity.id}}',
            name: '{{unity.name}}',
          },
        {% endfor %}
      ],
      bncc: {
        topics: {
          list: [
            {% for topic in bncc.topics.list %}
              {
                id: '{{topic.id}}',
                code: '{{topic.code|default:""}}',
                short_text: '{{topic.name|remove_line_break|safe|truncatewords:5}}',
                text: '{{topic.name|remove_line_break|safe}}',
                sumary: {% get_ability_percentages topic object user %},
                grades: [
                  {% for grade in topic.grades.all %}
                    {
                      id: '{{grade.id}}',
                      name: '{{grade.name_grade}}',
                    },
                  {% endfor %}
                ],
              },
            {% endfor %}
          ],
        },
        abilities: {
          list: [
            {% for ability in bncc.abilities.list %}
              {
                id: '{{ability.id}}',
                code: '{{ability.code|default:""}}',
                text: '{{ability.text|remove_line_break|safe}}',
                thematic_unit: '{{ability.thematic_unit.text|default:""|remove_line_break|safe}}',
                knowledge_object: '{{ability.knowledge_object.text|default:""|remove_line_break|safe}}',
                language_practice: '{{ability.language_practice.text|default:""|remove_line_break|safe}}',
                subject: '{{ability.subject.text|default:""}}',
                acting_field: '{{ability.acting_field.text|default:""}}',
                axis: '{{ability.axis.text|default:""}}',
                sumary: {% get_ability_percentages ability object user %},
                grades: [
                  {% for grade in ability.grades.all %}
                    {
                      id: '{{grade.id}}',
                      name: '{{grade.name_grade}}',
                    },
                  {% endfor %}
                ],
              },
            {% endfor %}
          ],
        },
        competences: {
          list: [
            {% for competence in bncc.competences.list %}
              {
                id: '{{competence.id}}',
                code: '{{competence.code|default:""}}',
                short_text: '{{competence.text|truncatewords:5}}',
                text: '{{competence.text|remove_line_break|safe}}',
                sumary: {% get_ability_percentages competence object user %},
              },
            {% endfor %}
          ]
        },
      },
      loads: {
        comparateClassesSummary: false,
        comparateUnitiesSummary: false,
      },
      selectedClasses: [],
      selectedUnities: [],
      selectedObject: '',
    },
    watch: {
      list_type: function(val) {
        setTimeout(() => {
          $('[data-toggle="tooltip"]').tooltip()
          $('[data-toggle="popover"]').popover({ trigger: "hover" })
        }, 500)
      },
    },
    methods: {
      printPDF(elem){
          $("#"+elem).printThis();
      },
      getDetail(object, comparate) {
        let url = ''
        if (this.selectedObject['type'] == 'ability') {
          url = this.urls.abilityDetail
        } else if (this.selectedObject['type'] == 'competence') {
          url = this.urls.competencesDetail
        } else if (this.selectedObject['type'] == 'topic') {
          url = this.urls.topicDetail
        }
        if(comparate == 'classes' && this.classes.length) {
          this.loads.comparateClassesSummary = true
          axios.get(`${this.getUrl(url, object.id)}?exam={{object.id}}&classes=${this.selectedClasses.map(classe => classe.id)}`).then((response) => {
            this.createChartComparateClasses(response.data.classes)
          }).finally(() => {
            this.loads.comparateClassesSummary = false
          })
        } else if(comparate == 'unities' && this.unities.length) {
          this.loads.comparateUnitiesSummary = true
          axios.get(`${this.getUrl(url, object.id)}?exam={{object.id}}&unities=${this.selectedUnities.map(unity => unity.id)}`).then((response) => {
            this.createChartComparateUnities(response.data.unities)
          }).finally(() => {
            this.loads.comparateUnitiesSummary = false
          })
        }
      },
      selectClasse(classe) {
        if(this.selectedClasses.find((_classe) => _classe.id == classe.id)) {
          this.selectedClasses.splice(this.selectedClasses.indexOf(classe), 1)
        } else {
          this.selectedClasses.push(classe)
        }
      },
      selectUnity(unity) {
        if(this.selectedUnities.find((_unity) => _unity.id == unity.id)) {
          this.selectedUnities.splice(this.selectedUnities.indexOf(unity), 1)
        } else {
          this.selectedUnities.push(unity)
        }
      },
      getUrl(url, id, params = false) {
        if (params) {
          url += params;
        }
        return url.replace('00000000-0000-0000-0000-000000000000', id);
      },
      createChartComparateClasses(data) {
        var options = {
          series: [
            {
              name: 'Desempenho',
              data: data.map((item, index) => item.value.toFixed(2)),
            }
          ],
          chart: {
            type: 'bar',
            height: 350,
          },
          annotations: {
            yaxis: [
              {
                y: data.reduce((total, item) => total + item.value, 0) / data.length,
                borderColor: '#00E396',
                label: {
                  borderColor: '#1D9EDE',
                  style: {
                    color: '#fff',
                    background: '#1D9EDE',
                  },
                  text: 'Média ' + (data.reduce((total, item) => total + item.value, 0) / data.length).toFixed(2) + '%',
                }
              }
            ]
          },
          colors: ['#00bcd4', '#ff9800', '#f44336', '#9c27b0', '#2196f3', '#009688', '#4caf50', '#ffeb3b', '#795548', '#607d8b'],
          plotOptions: {
            bar: {
              distributed: true,
              columnWidth: '20%',
            },
          },
          legend: {
            show: false
          },
          stroke: {
            show: true,
            width: 2,
            colors: ['transparent']
          },
          xaxis: {
            categories: data.map((item, index) => item.name), 
          },
          yaxis: {
            title: {
              text: 'Desempenho'
            },
            max: 100,
          },
          fill: {
            opacity: 1
          },
          tooltip: {
            y: {
              formatter: function (val) {
                return val + " %"
              }
            }
          }
        };
        let chart = new ApexCharts(document.querySelector("#comparateClassesChart"), options);
        chart.render();
      },
      createChartComparateUnities(data) {
        var options = {
          series: [
            {
              name: 'Desempenho',
              data: data.map((item, index) => item.value.toFixed(2)),
            }
          ],
          chart: {
            type: 'bar',
            height: 350,
          },
          colors: ['#00bcd4', '#ff9800', '#f44336', '#9c27b0', '#2196f3', '#009688', '#4caf50', '#ffeb3b', '#795548', '#607d8b'],
          plotOptions: {
            bar: {
              distributed: true,
              columnWidth: '20%',
              endingShape: 'rounded'
            },
          },
          legend: {
            show: false
          },
          stroke: {
            show: true,
            width: 2,
            colors: ['transparent']
          },
          xaxis: {
            categories: data.map((item, index) => item.name), 
          },
          yaxis: {
            title: {
              text: 'Desempenho'
            },
            max: 100,
          },
          fill: {
            opacity: 1
          },
          tooltip: {
            x: {
              formatter: function (val) {
                return val + " %"
              }
            }
          }
        };
        let chart = new ApexCharts(document.querySelector("#comparateUnitiesChart"), options);
        chart.render();
      },
      initOnStarted() {
        {% if not topic and not ability and not competence %}
          return
        {% endif %}

        {% if topic %}
          this.selectedObject = this.bncc.topics.list.find((item) => item.id == '{{topic.id}}')
          this.selectedObject['type'] = 'topic'
        {% elif ability %}
          this.selectedObject = this.bncc.abilities.list.find((item) => item.id == '{{ability.id}}')
          this.selectedObject['type'] = 'ability' 
        {% elif competence %}
          this.selectedObject = this.bncc.competences.list.find((item) => item.id == '{{competence.id}}')
          this.selectedObject['type'] = 'competence' 
        {% endif %}
        this.getDetail(this.selectedObject, 'classes')
        this.getDetail(this.selectedObject, 'unities')
        $("#modalBNCCDetail").modal('show')
      },
    },
    mounted() {
      moment.locale('pt-br');
      setTimeout(() => {
        $('[data-toggle="tooltip"]').tooltip()
        $('[data-toggle="popover"]').popover({ trigger: "hover" })
        this.initOnStarted()
      }, 500)
      this.selectedClasses = this.classes.slice(0, 2)
      this.selectedUnities = this.unities.slice(0, 2)
      this.load = false

      $('#id_application').select2({
        placeholder: "Selecione uma aplicação",
        width: '100%',
        closeOnSelect: false,
        multiple: true,
      });

      $('.off-canvas-menu').on('click', function (e) {
        e.preventDefault();
        var target = $(this).attr('data-toggle-off-canvas');
        $(target).addClass('show');
      });
  
      $('.off-canvas .close').on('click', function (e) {
        e.preventDefault();
        $(this).closest('.off-canvas').removeClass('show');
      })
  
      $(document).on('click touchstart', function (e) {
        if($(e.target).hasClass('select2-results__option') || $(e.target).hasClass('select2-results__custom_option')) {
          return
        }
        e.stopPropagation();
  
        if (!$(e.target).closest('.off-canvas-menu').length) {
          var offCanvas = $(e.target).closest('.off-canvas').length;
          if (!offCanvas) {
            $('.off-canvas.show').removeClass('show');
          }
        }
      });

      setTimeout(() => {
        axios.post("{% url 'notifications:api-especial-notification' %}", { where: "after_view_exam_results" }) 
      }, 8000)

    }
  });
</script>
{% endblock js-additional %}

