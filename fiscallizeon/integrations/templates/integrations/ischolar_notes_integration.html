{% extends 'redesign/base.html' %}
{% comment %} {% extends 'dashboard/base_fixed.html' %} {% endcomment %}
{% load static %}
{% load widget_tweaks %}
{% load students_tags %}

{% block title %}Composição de notas - Lize{% endblock title %}

{% block css-additional %}
  <link href="{% static 'administration/lib/select2/css/select2.min.css' %}" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
  <style>
    .table-scroll {
      position: relative;
      margin: auto;
      overflow: hidden;
    }
    .table-wrap {
      overflow: auto;
    }
    .table-scroll table {
      width: 100%;
      margin: auto;
      border-collapse: separate;
      border-spacing:0;
    }
    .table-scroll th, .table-scroll td {
      white-space: nowrap;
      vertical-align: top;
    }
    .table-scroll thead, .table-scroll tfoot {
      background:#f9f9f9;
    }
    .fixed-table {
      position:absolute;
      top:0;
      left:0;
      pointer-events:none;
    }
    .fixed-table th, .fixed-table td {
      visibility:hidden
    }
    .fixed-table td, .fixed-table th {
      border-color: transparent
    }
    .fixed-table tbody th {
      visibility:visible;
    }
    .fixed-table .fixed-side {
      border:1px solid rgb(214, 214, 214);
      background:#eee;
      visibility:visible;
    }
    .fixed-table thead, .fixed-table tfoot {
      background: transparent;
    }
  </style>
{% endblock css-additional %}

{% comment %}
{% block breadcrumb-fixed %}
  <div class="d-sm-flex align-items-center justify-content-between mg-b-20 mg-lg-b-25 mg-xl-b-10">
    <div>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb breadcrumb-style1 mg-b-10">
          <li class="breadcrumb-item"><a href="{% url 'students:students_list' %}">NOTAS</a></li>
          <li class="breadcrumb-item active" aria-current="page">COMPOSIÇÃO</li>
        </ol>
      </nav> 
      <h4>Gerenciamento composição de notas</h4>
    </div>
    <div class="d-none d-md-block">
        <a href="#" onclick="history.back()" class="btn btn-sm pd-x-15 btn-white btn-uppercase">
            <i data-feather="arrow-left" class="wd-10 mg-r-5"></i> Voltar
        </a>
    </div>
  </div>
{% endblock breadcrumb-fixed %}
{% endcomment %}

{% block content-fixed %}
<div class="ard cer dcv">
  <div class="ls" style="margin-top: 0.625rem; margin-bottom: 0.625rem; justify-content: space-between;">
    <!-- Empty -->
  </div>
  <div>
    <h4>Gerenciamento composição de notas</h4>
  </div>
<div class="card mg-b-10">
  <div class="card-header pd-t-20 d-sm-flex align-items-start justify-content-between bd-b-0 pd-b-0">
    <div>
      <h3 class="mg-b-5">Enviar notas para a ISCHOLAR</h3>
      <p class="tx-13 tx-color-03 mg-b-5"></p>
    </div>
  </div>
  <div class="card-body">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb breadcrumb-style3">
        <li class="breadcrumb-item cp d-flex align-items-center" @click="wizzard.index > 0 ? wizzard.index = 0:''">
          <span 
            class="d-flex align-items-center justify-content-center badge shadow-sm tx-16 rounded-circle mx-1" 
            style="width: 35px; height: 35px;" 
            :class="wizzard.index > 0 ? 'badge-success' : wizzard.index === 0 ? 'badge-primary':'badge-secondary'"
          >1</span> 
          Turmas/Disciplinas/Fase de notas
        </li>
        <li class="breadcrumb-item cp d-flex align-items-center">
          <span 
            class="d-flex align-items-center justify-content-center badge shadow-sm tx-16 rounded-circle mx-1" 
            style="width: 35px; height: 35px;" 
            :class="wizzard.index === 1 ? 'badge-primary':'badge-secondary'"
          >2</span> 
          Confirmar importação de notas
        </li>
      </ol>
    </nav>
  </div>
</div>
<div class="row">
  <div class="col-md-4">
    <div style="position: -webkit-sticky; position: sticky; top: 100px;">
      <div class="card mg-b-10">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h4 class="mb-1">${wizzard.index ? 'Confirmação':'Seleção de cadernos e série'}</h4>
        </div>
        <div class="card-body">
          <div v-show="wizzard.index === 0">
            <div class="form-group row">
              <div class="col-12">
                <label for="grade_id">Série <span class="text-danger tx-bold">*</span></label>
                <select id="grade_id" data-container="body" v-model="composition.grade" data-live-search="true" class="selectpicker form-control" required>
                  <option :value="grade.id" v-for="grade in grades">${grade.name}</option>
                </select>
                <small class="form-text text-muted" v-if="composition.errors['grade']">Este campo é obrigatório</small>
              </div>
            </div>
            <div class="form-group row">
              <div class="col-12">
                <label for="exams_id">Cadernos <span class="text-danger tx-bold">*</span></label>
                <select id="exams_id" data-container="body" v-model="composition.exams" data-live-search="true" data-actions-box="true" multiple required class="selectpicker form-control" multiple required :disabled="!composition.grade">
                  <option :value="exam.id" v-for="exam in exams">${exam.name}</option>
                </select>
                <small class="form-text text-muted" v-if="composition.errors['exams']">Este campo é obrigatório</small>
              </div>
              <div class="col-12 mt-2" v-if="loadingExams">
                <h6>Carregando cadernos <i class="fas fa-sync fa-spin"></i></h6>
              </div>
            </div>
            <div class="form-group row" v-if="composition.exams.length">
              <div class="col-12">
                <button type="button" @click="getStudentsScore(), wizzard.index = 1, startFixedTable()" class="btn btn-primary btn-block" :disabled="!continueIsValid()"><i class="fas fa-send"></i> Continuar</button>
              </div>
            </div>
          </div>
          <div v-show="wizzard.index == 1">
            <div class="row">
              <div class="col-12">
                <div class="alert alert-warning">
                  O processo de importação será iniciado após você clicar no botão
                  "Confirmar envio de notas"
                </div>
              </div>
            </div>
            <div class="form-group row">
              <div class="col-12">
                <template v-if="savingComposition">
                  <button type="button" class="btn btn-secondary btn-block" disabled><i class="fas fa-sync fa-spin"></i>
                    Aguarde a finalização
                  </button>
                </template>
                <template v-else>
                  <button type="button" @click="sendNotes()" class="btn btn-success btn-block" :disabled="!syncIsValid()"><i class="fas fa-sync"></i> Confirmar envio de notas</button>
                  <button type="button" @click="wizzard.index = 0" class="btn btn-secondary btn-block"><i class="fas fa-arrow-left"></i> Voltar</button>
                </template>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-8">
    <div class="card shadow-sm" v-if="!composition.exams.length">
      <div class="card-body" style="min-width: 750px; min-height: 700px;">
        <div class="row h-100">
          <div class="col-12 d-flex justify-content-center align-items-center text-center">
            <div>
              <h2 class="text-muted tx-medium mt-3">Você precisa selecionar a série e um caderno</h2>
              <img class="img-fluid" style="opacity: .8;" src="{% static 'administration/assets/img/empty_2.png' %}" alt="">
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row mb-1" v-for="(examCompositionID, examIndex) in composition.exams">
      <div class="col-12">
        <div class="card mg-b-10">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="text-truncate mb-0" style="max-width: 20rem;" :title="getExam(examCompositionID).name">${getExam(examCompositionID).name}</h5>
            <div class="d-flex align-items-center">
              <span class="tx-22 font-weight-bold mr-2">${getStudentsInSelectedClasses(getExam(examCompositionID)).length} Alunos</span>
              <button class="btn btn-outline-danger btn-xs" @click="removeExam(examCompositionID)"><span class="tx-16"><i class="fas fa-times"></i></span></button>
            </div>
          </div>
          <div class="card-body">
            <div v-show="wizzard.index === 0">
              <!-- Turmas -->
              <div class="form-group row mb-2">
                <div class="col-12">
                  <div class="d-flex justify-content-between align-items-center">
                    <label :for="'classes_id-' + examIndex">
                      <span>
                        Turmas <span class="text-danger tx-bold">*</span>
                      </span>
                    </label>
                  </div>
                  <select :id="'classes_id-' + examIndex" data-container="body" v-model="getExam(examCompositionID).selectedClasses" @change="getExamPhases(getExam(examCompositionID), '#examPhase-' + examIndex)" data-live-search="true" data-actions-box="true" multiple required class="selectpicker form-control">
                    <option :value="classe.id" v-for="classe in getExam(examCompositionID).classes">${classe.name}</option>
                  </select>
                </div>
              </div>
              <!-- Fim Turmas -->
              <!-- Após selecionar as turmas -->
              <div v-show="getExam(examCompositionID).divisions.length">
                <div class="form-group row">
                  <div class="col-12 px-1">
                    <div class="table-responsive">
                      <table class="table mb-0">
                        <thead>
                          <tr>
                            <th v-for="(division, i) in getExam(examCompositionID).divisions">
                              <div class="custom-control custom-radio">
                                <input type="radio" :id="'nc-'+examIndex+'-'+ i" @click="getExam(examCompositionID).division = division" :name="'ncRadio-' + examIndex" class="custom-control-input">
                                <label class="custom-control-label text-uppercase" :for="'nc-'+examIndex+'-'+i" @click="getExam(examCompositionID).division = division">
                                  <div class="text-truncate">
                                    ${division.descricao}
                                  </div>
                                </label>
                              </div>
                            </th>
                          </tr>
                        </thead>
                      </table>
                    </div>
                  </div>
                  <div class="col-12">
                    <hr>
                  </div>
                  <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                      <label :for="'avaliation_id-' + examIndex">
                        <span>
                          Avaliação <span class="text-danger tx-bold">*</span>
                        </span>
                      </label>
                    </div>
                    <template v-if="getExam(examCompositionID).division">
                      <select :id="'avaliation_id-' + examIndex" v-model="getExam(examCompositionID).avaliation" required class="form-control">
                        <option :value="avaliation.id_avaliacao" v-for="avaliation in getExam(examCompositionID).division.avaliacoes">${avaliation.nome_avaliacao} - ${avaliation.apelido_ava}</option>
                      </select>
                    </template>
                  </div>
                </div>
                <!-- Disciplinas -->
                <h6 class="mb-0">Selecione as disciplinas</h6>
                <div class="d-flex bg-white my-3">
                  <div class="flex-1 ht-200 bg-gray-100 rounded p-2">
                    <label>Disciplinas Lize <span class="text-danger tx-bold">*</span></label>
                    <select class="form-control h-75" v-model="subjectRelationOne" @change="handlerRelation(getExam(examCompositionID), 'fiscallize', $event)" multiple>
                      <option :value="subject.id" v-for="subject in getExam(examCompositionID).subjects">${subject.name}</option>
                    </select>
                  </div>
                  <div class="divider-text divider-vertical"><i class="fas fa-exchange-alt"></i></div>
                  <div class="flex-1 ht-200 bg-gray-100 rounded p-2">
                    <label>Disciplinas Ischolar <span class="text-danger tx-bold">*</span></label>
                    <select class="form-control h-75" v-model="subjectRelationTwo" @change="handlerRelation(getExam(examCompositionID), 'ischolar', $event)" multiple v-if="getExam(examCompositionID).subjectsIscholar">
                      <option :value="subject.id_disciplina" v-for="subject in getExam(examCompositionID).subjectsIscholar.filter(s => !getExam(examCompositionID).subjectsRelation.find(r => r.ischolar.id_disciplina == s.id_disciplina))">(Ischolar) - ${subject.disciplina_nome}</option>
                    </select>
                  </div>
                </div>
                <button class="btn btn-sm btn-block" :class="canAddRelation() ? 'btn-primary':'btn-secondary'" :disabled="!canAddRelation()" @click="addRelation(getExam(examCompositionID))">Adicionar disciplina</button>
                <div class="row m-0 bg-gray-100 mt-3 py-2">
                  <div class="col-12" v-for="relation in getExam(examCompositionID).subjectsRelation">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <h6 class="text-truncate mb-0" style="max-width: 20rem;" v-for="(subject, subjectIndex) in relation.fiscallize">(Ischolar) - ${subject.name}</h6>
                      </div>
                      <div class="divider-text divider-vertical"><i class="fas fa-exchange-alt"></i></div>
                      <div>
                        <h6 class="text-truncate mb-0">(Ischolar) - ${relation.ischolar.disciplina_nome}</h6>
                      </div>
                      <i class="fas fa-times text-danger cp" @click="getExam(examCompositionID).subjectsRelation.splice(getExam(examCompositionID).subjectsRelation.indexOf(getExam(examCompositionID).subjectsRelation.find(r => r.ischolar.id_disciplina == relation.ischolar.id_disciplina)), 1)"></i>
                    </div>
                    <hr class="my-2">
                  </div>
                </div>
                <!-- Fim Disciplinas -->
              </div>
              <template v-if="!getExam(examCompositionID).selectedClasses.length">
                <div class="row">
                  <div class="col-12">
                    <h6 class="text-muted">Você precisa selecionar pelo menos uma turma</h6>
                  </div>
                </div>
              </template>
              <template v-if="getExam(examCompositionID).loadingCompositions">
                <div class="row">
                  <div class="col-12">
                    <h6 class="text-muted">Carregando as composições, aguarde... <i class="fas fa-sync fa-spin"></i></h6>
                  </div>
                </div>
              </template>
              <!-- Fim após selecionar as turmas -->
            </div>
            <div v-show="wizzard.index == 1">
              <div>
                <ul class="nav nav-tabs" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" data-toggle="tab" :data-target="'#examSumary-'+examIndex" type="button" role="tab" aria-controls="home" aria-selected="true">Resumo</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" data-toggle="tab" :data-target="'#examLogs-'+examIndex" type="button" role="tab" aria-controls="profile" aria-selected="false">Logs de importação <span class="badge badge-danger ml-2" v-if="getExam(examCompositionID).logs.filter(l => l.type == 'error').length">${getExam(examCompositionID).logs.filter(l => l.type == 'error').length}</span></button>
                  </li>
                </ul>
                <div class="tab-content">
                  <div class="tab-pane fade show active" :id="'examSumary-'+examIndex" role="tabpanel">
                    <!-- Início do resumo -->
                    <div class="row mt-3">
                      <div class="col-sm-5" v-if="getExam(examCompositionID).division">
                        <h3 class="tx-normal tx-rubik tx-spacing--2 mg-b-5">Divisão: ${getExam(examCompositionID).division.descricao}</h3>
                        <h6 class="tx-uppercase tx-11 tx-spacing-1 tx-color-02 tx-semibold mg-b-10" v-if="getExam(examCompositionID).division.avaliacoes.find(a => a.id_avaliacao == getExam(examCompositionID).avaliation)">Avaliação: ${getExam(examCompositionID).division.avaliacoes.find(a => a.id_avaliacao == getExam(examCompositionID).avaliation).nome_avaliacao}</h6>
                      </div>
                    </div>
                    <!-- Fim do resumo -->
                    <!-- Alunos -->
                    <div class="row mt-1">
                      <div class="col-12">
                        <div :id="'table-scroll-'+examIndex" class="table-scroll">
                          <div class="table-wrap">
                            <table class="table table-striped table-bordered mb-0 main-table">
                              <thead>
                                <tr>
                                  <th class="fixed-side w-25" style="max-width: 4rem;">Matrícula</th>
                                  <th class="fixed-side w-25">Aluno</th>
                                  <th v-for="relation in getExam(examCompositionID).subjectsRelation" class="text-truncate tooltips cp" :data-tippy-content="relation.ischolar.disciplina_nome">${relation.ischolar.disciplina_nome.slice(0, 6)}</th>
                                </tr>
                              </thead>
                              <tbody>
                                <tr v-for="(student, studentIndex) in getStudentsInSelectedClasses(getExam(examCompositionID))">
                                  <td class="fixed-side w-25" style="max-width: 4rem;">${student.enrollmentNumber}</td>
                                  <td class="fixed-side text-uppercase text-truncate w-25">${student.name}</td>
                                  <td v-for="relation in getExam(examCompositionID).subjectsRelation">
                                    <template v-if="student.scoreLoaded">
                                      <span class="text-muted">
                                        ${student.score.subjects.filter(subject => subject.score !== null && relation.fiscallize.find(s => s.id == subject.id)).length ? student.score.subjects.filter(subject => subject.score >= 0 && relation.fiscallize.find(s => s.id == subject.id)).reduce((total = 0, s) => total += Number(s.score), 0).toFixed(2) : '--' }
                                      </span>
                                    </template>
                                    <template v-else>
                                      <i class="text-muted fas fa-sync fa-spin"></i>
                                    </template>
                                  </td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    </div>
                    <!-- Fim Alunos -->
                  </div>
                  <div class="tab-pane fade" :id="'examLogs-'+examIndex" role="tabpanel">
                    <div class="row mt-4">
                      <div class="col-12">
                        <div class="contact-content">
                          <div class="contact-content-header">
                            <nav class="nav">
                              <a :href="'#examLogsSuccess-'+examIndex" class="nav-link active" data-toggle="tab">Todos os envios</a>
                              <a :href="'#examLogsErrors-'+examIndex" v-show="getExam(examCompositionID).logs.filter(l => l.type == 'error').length" class="nav-link" data-toggle="tab">Apenas envios com erro <span class="badge badge-danger ml-2">${getExam(examCompositionID).logs.filter(l => l.type == 'error').length}</span></a>
                            </nav>
                          </div>
                          <div class="contact-content-body">
                            <div class="tab-content">
                              <div :id="'examLogsSuccess-'+examIndex"  class="tab-pane show active">
                                <div class="card card-widget card-events">
                                  <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    <ul class="list-unstyled media-list mg-b-0">
                                      <li class="media align-items-center" v-for="(log, index) in getExam(examCompositionID).logs">
                                        <div class="media-left">
                                          <p>${String(index + 1).padStart(2, '0')}</p>
                                        </div>
                                        <div class="media-body" :class="log.type == 'error' ? 'event-panel-pink':'event-panel-green'">
                                          <h6 class="event-title">${log.message}</h6>
                                        </div>
                                      </li>
                                    </ul>
                                  </div><!-- card-body -->
                                  <div class="card-footer bg-transparent">
                                    <span class="text-muted">Lista com todos os envios</span>
                                  </div><!-- card-footer -->
                                </div>
                              </div>
                              <div :id="'examLogsErrors-'+examIndex" class="tab-pane">
                                <div class="card card-widget card-events">
                                  <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    <ul class="list-unstyled media-list mg-b-0">
                                      <li class="media align-items-center" v-for="(log, index) in getExam(examCompositionID).logs.filter(l => l.type == 'error')">
                                        <div class="media-left">
                                          <p>${String(index + 1).padStart(2, '0')}</p>
                                        </div>
                                        <div class="media-body event-panel-pink">
                                          <h6 class="event-title">${log.message}</h6>
                                        </div>
                                      </li>
                                    </ul>
                                  </div><!-- card-body -->
                                  <div class="card-footer bg-transparent">
                                    <span class="text-muted">Lista de envios com erro</span>
                                  </div><!-- card-footer -->
                                </div>
                              </div><!-- tab-pane -->
                            </div><!-- tab-content -->
                          </div><!-- contact-content-body -->
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="mt-3" v-show="wizzard.index == 1">
      <div class="row">
        <div class="col-12">
          <div class="alert alert-warning">
            O processo de importação será iniciado após você clicar no botão
            "Confirmar envio de notas"
          </div>
        </div>
      </div>
      <div class="form-group row">
        <div class="col-12">
          <template v-if="savingComposition">
            <button type="button" class="btn btn-secondary btn-block" disabled><i class="fas fa-sync fa-spin"></i>
              Aguarde a finalização
            </button>
          </template>
          <template v-else>
            <button type="button" @click="sendNotes()" class="btn btn-success btn-block" :disabled="!syncIsValid()"><i class="fas fa-sync"></i> Confirmar envio de notas</button>
            <button type="button" @click="wizzard.index = 0" class="btn btn-secondary btn-block"><i class="fas fa-arrow-left"></i> Voltar</button>
          </template>
        </div>
      </div>
    </div>
  </div>
</div>
</div>
{% endblock content-fixed %}

{% block js-additional %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
<script src="{% static 'administration/lib/select2/js/select2.min.js' %}"></script>
<script src="{% static 'administration/lib/jquery-steps/build/jquery.steps.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>

<script>
  var app = new Vue({
    delimiters: ['${', '}'],
    el: '#app',
    data: {
      relationObject: {
        fiscallize: null,
        ischolar: null,
      },
      tablesStarteds: false,
      ischolarSubjects: [],
      subjectRelationOne: [],
      subjectRelationTwo: [],
      canSync: false,
      examsOriginal: [],
      exams: [],
      grades: [
        {% for grade in grades %}
          {
            id: "{{grade.id}}",
            name: "{{grade}}",
          },
        {% endfor %}
      ],
      subjectsFiscallize: [
        {% for subject in subjects %}
          {
            id: '{{subject.id}}',
            name: '{{subject}}',
          },
        {% endfor %}
      ],
      classesFiscallize: [],
      studentsFiscallize: [],
      subjects: [],
      phases: [],
      students: [],
      wizzard: {
        index: 0,
        labels: {
          next: 'Próximo',
          previous: 'Anterior',
          finish: 'Confirmar',
        }
      },
      composition: {
        grade: null,
        classe: null,
        classes: [],
        classesSubjects: [],
        subject: null,
        selectedSubjectsExams: [],
        phase: null,
        classesDetail: [],
        note: null,
        selectedExams: [],
        notes: [],
        exams: [],
        students: [],
        errors: {},
        syncType: 'exam',
        syncSubjects: false, 
        sumNotes: false,
        sumSubjectNotes: false,
      },
      loadStudents: false,
      loadSummary: false,
      loadingExams: false,
      promissesInterval: null,
      savingComposition: false,
      syncProofs: [],
    },
    updated() {
      
    },
    watch: {
      'composition.sumNotes': function(val) {
        if(val) {
          this.composition.syncSubjects = false
          this.composition.selectedSubjectsExams = []
          this.composition.selectedExams.forEach((exam) => exam.selectedSubjects = [])
        }
      },
      'composition.grade': function(val) {
        if(val) {
          this.exams = []
          this.loadingExams = true
          this.composition.exams = []
          this.handlerExamsGrade(val)
        }
      },
      'composition.exams': function(val) {
        if(val.length) {
          this.handlerExamsClasses(this.composition.grade)
        }
      },
      subjectRelationTwo: function(val) {
        if(val.length > 1) {
          this.subjectRelationTwo = [val.pop()]
        }
      },
    },
    methods: {
      getGradeProportion(grade, maxGradeLize, maxGradeIcholar) {
        return (grade / maxGradeLize) * maxGradeIcholar;
      },
      removeExam(examID) {
        Swal.fire({
          title: 'Confirmação',
          text: "Você confirma a remoção do caderno da composição?",
          icon: "question",
          showCancelButton: true,
          cancelButtonText: 'Cancelar',
          confirmButtonColor: '#3085d6',
          confirmButtonText: 'Sim, confirmo',
          showConfirmButton: true,
        }).then((result) => {
          if (result.value) {
            this.composition.exams.splice(this.composition.exams.indexOf(examID), 1)
            this.handlerSelectInputs('#exams_id')
          }
        })
      },
      continueIsValid() {
        return this.getSelectedExams().every((exam) => {
          if(!exam.avaliation) return false;
          else if(!exam.selectedClasses.length) return false;
          else if(!exam.subjectsRelation.length) return false;
          else {
            return true
          }
        })
      },
      syncIsValid() {
        return this.getSelectedExams().every((exam => this.getStudentsInSelectedClasses(exam).every(student => student.scoreLoaded)))
      },
      log(exam, student, message, type = 'success') {
        exam.logs.push({
          student: student,
          message: message,
          type: type,
        })
      },
      getSelectedExams() {
        return this.exams.filter(exam => this.composition.exams.includes(exam.id))
      },
      handlerCanSync() {
        this.getSelectedExams().forEach((exam) => {
          if(exam.students.every(student => student.scoreLoaded)) {
            this.canSync = true
          }
        })
      },
      getStudentsInSelectedClasses(exam) {
        return exam.students.filter(student => student.classe && exam.selectedClasses.includes(student.classe.id))
      },
      async getStudentsScore() {
        for (examID of this.composition.exams) {
          let exam = this.getExam(examID)
          let students = this.getStudentsInSelectedClasses(exam)
          
          for(student of students) {
            
            student.scoreLoaded = false

            await this.getStudentScore(exam, student).then((response) => {

              // Inicializa a variável subjects dentro de score
              if(!student.score) {
                student.score = {
                  subjects: []
                }
              }
              
              // Chega se tem response (Quando fo uma promise vazia o response não vai existir)
              if(response) {
                response.data.subjects.forEach((subject) => {
                  if(!student.score.subjects.find((s => s.id == subject.id))) {
                    student.score.subjects.push(subject)
                  }
                })
  
                student.score.subjects.forEach((subject) => {
                  this.handlerCanSync()
                })

              }
            }).finally(() => student.scoreLoaded = true)
          }
        }
      },
      handlerRelation(exam, who, event) {
        if(who == 'fiscallize') {
          this.relationObject.fiscallize = exam.subjects.filter(subject => this.subjectRelationOne.includes(subject.id))
        } else {
          this.relationObject.ischolar = exam.subjectsIscholar.find(subject => subject.id_disciplina == event.target.value)
        }
      },
      addRelation(exam) {
        if(this.canAddRelation(showError = true)) {
          exam.subjectsRelation.push(this.relationObject)
          this.resetRelationObject()
        }
      },
      canAddRelation(showError) {
        if((this.relationObject.fiscallize && this.relationObject.fiscallize.length) && this.relationObject.ischolar) {
          return true
        } 
        if (showError) {
          Swal.fire({
            text: 'Erro ao adicionar relação',
            icon: 'error',
          })
        }
        return false
      },
      resetRelationObject() {
        this.relationObject = {
          fiscallize: null,
          ischolar: null,
        }
        this.subjectRelationOne = []
        this.subjectRelationTwo = []
      },
      async getIscholarClasseSubjects(classeID) {
        return await axios.get(`{{user.client.integration.urls.classe_subjects}}?id_turma=${Number(classeID)}`, { headers: this.headers() })
      },
      async getExamPhases(exam, selector) {
        new Promise((resolve) => {
          let firstClasse = exam.classes.filter(classe => classe.students.length).at(0)
          if (firstClasse) {
            this.getClasseDataOnIscholar(firstClasse.idErp).then((response) => {
              let classe = response.data.data.turma[0]
              let sistem = classe.sistema_avaliativo
              exam.divisions = sistem.divisoes
            }).finally(() => {
              
              this.getIscholarClasseSubjects(firstClasse.idErp).then((subjectsResponse) => {
                exam.subjectsIscholar = subjectsResponse.data.dados
              }).finally(() => {
                exam.loadingCompositions = false
              })
              
            })
          }
        }).then(() => {
          this.handlerSelectInputs(selector)
        })
      },
      handlerExams() {
        let examsCopy = Object.assign(this.examsOriginal.filter(exam => exam.students.length), [])
        this.exams = examsCopy
      },
      async getExamStudents(exam) {
        return await axios.get(`{% url 'integrations:api-get-exams-students' %}?exam=${exam.id}`)
      },
      async handlerExamsClasses(gradeID) {
        for(examID of this.composition.exams) {
          let exam = this.getExam(examID)
          if(!exam.studentsLoaded) {
            await this.getExamStudents(exam).then((response) => {
              exam.students = response.data.filter(s => s.classe)
              exam.studentsLoaded = true
            }).finally(() => {
              let classes = []
              exam.students.forEach((student) => {
                if(student.classe && student.classe.grade.id == gradeID) {
                  let classe = classes.find(classe => classe.id == student.classe.id)
                  if(classe) {
                    classe.students.push(student)
                  } else {
                    classes.push({
                      id: student.classe.id,
                      name: student.classe.name,
                      idErp: student.classe.idErp,
                      students: [student]
                    })
                  }
                }
              })
              exam.classes = classes
              this.handlerSelectInputs('#classes_id-' + this.composition.exams.indexOf(exam.id))
            })
          }
        }
      },
      async getExamsFromDB(gradeID) {
        return await axios.get(`{% url 'integrations:api-get-exams' %}?grade=${gradeID}`)
      },
      handlerExamsGrade(gradeID){
        this.getExamsFromDB(gradeID).then((response) => {
          this.examsOriginal = response.data
          let examsCopy = Object.assign(this.examsOriginal, [])
          this.exams = examsCopy
          this.handlerSelectInputs('#exams_id')
        }).finally(() => this.loadingExams = false)
      }, 
      getExam(examID) {
        return this.exams.find((exam) => exam.id == examID)
      },
      headers(token) {
        return {{headers|safe}}
      },
      reset(option) {
        if (option == 'classes') {
        
          this.classesFiscallize = []
          this.composition.classes = []
        
        } else if(option == 'students') {
          
          this.studentsFiscallize = []

        } else {
        
          this.loadStudents = false
          this.students = []
          this.subjects = []
          this.phases = []
          this.composition.notes = []
        
        }
      },
      async getStudentScore(exam, student) {
        
        let subjects = []

        exam.subjectsRelation.forEach(relation => {
          relation.fiscallize.forEach(s => {
            subjects.push(s.id)
          })
        })

        // Check if not includes in subjects loadeds
        subjects = subjects.filter(s => student.score && !student.score.subjects.find(subject => subject.id == s) || !student.score)

        if (!subjects.length) {

          // Retorna promessa vazia para não quebrar a função
          return await new Promise((resolve) => resolve())

        } else {
          
          let payload =  {
            exam: exam.id, 
            student: student.id, 
            subjects: subjects,
          }

          return await axios.post("{% url 'api2:students-get-score' %}", payload)
        
        }
      },
      async getClasseDataOnIscholar(classeIDErp) {
        const url = `{{user.client.integration.urls.evaluation_system}}?id_turma=${Number(classeIDErp)}`;
        return await axios({
          method: 'GET',
          url: url, 
          headers: this.headers(),
        })
      },
      handlerSelectInputs(selector = 'select') {
        setTimeout(() => {
          $(selector).selectpicker('destroy');
          $(selector).selectpicker({
            style: 'btn-white',
            placeholder: "Selecione uma opção",
            noneSelectedText: 'Nenhuma seleção',
            noneResultsText: 'Nenhum resultado encontrado',
            selectAllText: 'Todos',
            deselectAllText: 'Nenhum'
          })
        }, 300)
      },
      async sendNoteToIscholar(compostion) {
        const url = `{{user.client.integration.urls.send_notes}}`
        return await axios.post(url, compostion, { headers: this.headers() })
      },
      handSendNote(exam) {
        this.savingComposition = true;
        exam.inSync = true;
    
        let students = this.getStudentsInSelectedClasses(exam);
        let studentsCount = students.length * exam.subjectsRelation.length;
    
        let proofsLength = this.syncProofs.push({
            exam: exam.id,
            students: [],
        });
    
        let currentProof = this.syncProofs[proofsLength - 1];
        let compositions = [];
    
        exam.subjectsRelation.forEach((relation) => {
            students.forEach((student) => {
                let scores = student.score.subjects.filter(subject => subject.score !== null && relation.fiscallize.find(s => s.id == subject.id));
                let totalScore = scores.reduce((total = 0, s) => total += Number(s.score), 0);
                let maxGradeIcholar = exam.division.avaliacoes.find(a => a.id_avaliacao == exam.avaliation).valor;
                let maxGradeLize = scores.reduce((total = 0, s) => total += Number(s.max_score), 0);

    
                let composition = {
                    "id_professor": relation.ischolar.professores ? Number(relation.ischolar.professores.id_professor): '',
                    "id_matricula": Number(student.idEnrollmentErp),
                    "id_disciplina": Number(relation.ischolar.id_disciplina),
                    "id_avaliacao": Number(exam.avaliation),
                    "valor": scores.length ? this.getGradeProportion(Number(totalScore).toFixed(5), maxGradeLize, maxGradeIcholar).toFixed(2) : null // Aqui eu pego uma proporção da nota do aluno
                };
                if(exam.division.avaliacoes.find(a => a.id_avaliacao == exam.avaliation).somente_escola === '1') {
                  delete composition.id_professor
                }
    
                let studentsProofLength = currentProof.students.push({
                    pk: student.id,
                    relation: relation,
                    composition: composition,
                    errorMessage: "",
                });
    
                compositions.push({
                    composition: composition,
                    exam: exam,
                    student: student,
                    currentStudentProof: currentProof.students[studentsProofLength - 1]
                });
            });
        });
    
        const sendCompositionsRecursively = (index, exam) => {
            if (index >= compositions.length) {
                exam.inSync = false;
                this.handlerExamsSync();
                return;
            }
    
            let { composition, student, currentStudentProof } = compositions[index];
    
            this.sendNoteToIscholar(composition).then((response) => {
                if (response.data.status == 'sucesso') {
                    this.log(exam, student, message = `As notas do aluno ${student.name} com matrícula ${student.enrollmentNumber} foi lançada`, type = 'succes');
                } else {
                    this.log(exam, student, message = String(response.data.mensagem), type = 'error');
                    currentStudentProof.errorMessage = String(response.data.mensagem);
                }
            }).catch((e) => {
                this.log(exam, student, message = String(e.response.data.message), type = 'error');
                currentStudentProof.errorMessage = String(e.response.data.message);
            }).finally(() => {
                sendCompositionsRecursively(index + 1, exam);
            });
        };
    
        sendCompositionsRecursively(0, exam);
      },
      sendNotes() {
        
        let exams = this.getSelectedExams()
        
        exams.forEach((exam) => {
          let studentsWithErrors = exam.students.filter(s => exam.errors.includes(Number(s.idErp))).map(s => s.name)
          if(studentsWithErrors.length) {
            Swal.fire({
              title: 'Confirmação',
              html: `
                Os seguintes alunos do caderno <h5>${exam.name}</h5> não tiveram suas notas carregadas por terem <strong>mudado de turma ou saído da escola</strong>
                <br>
                <br>
                <ul>
                  ${studentsWithErrors.map(n => `<li>${n}</li>`).join(' ')}
                <ul>
                <br>
                <br>
                <strong>enviar mesmo assim?</strong> 
                <br>
                (esses alunos não terão notas no Active)
              `,
              icon: 'info',
              confirmButtonText: "Sim, enviar!",
              showCancelButton: true,
              cancelButtonText: "Não, cancelar!"
            }).then(({ isConfirmed }) => {
              if(isConfirmed) {
                this.handSendNote(exam)
              }
            })
          } else {
            this.handSendNote(exam)
          }
        })
      }, 
      handlerExamsSync() {
        exams = this.getSelectedExams()
        if(exams.every(exam => !exam.inSync)) {
          axios.post('{% url "integrations:notes-migration-proof-create" %}', {
            proofs: this.syncProofs,
          }).then((response) => {
            console.log("Comprovante de migração de notas gerado.")
          })
          
          Swal.fire({
            title: 'Finalizado',
            text: 'Composição de notas concluída com sucesso',
            icon: 'success',
          }).then(({ isConfirmed }) => {
            if(isConfirmed) {
              this.savingComposition = false
              //window.location.href = ''
            }
          })
          
          axios.post("{% url 'notifications:api-especial-notification' %}", { where: "after_send_note" }) // Responsável por criar notificação personalizada após enviar notas para active

        }
      },
      getAllHandlers() {
        this.handlerExams()
        this.handlerSelectInputs()
      },
      startFixedTable() {
        if(!this.tablesStarteds) {
          const tables = $('.main-table')
          if(tables.length) {
            tables.each((i, table) => {
              let clone = table.cloneNode(true)
              clone.className += " fixed-table";
              let tableBody = $(`#table-scroll-${i}`);
              tableBody.append(clone);
            })
          }
        }
        this.tablesStarteds = true
      }
    },
    mounted() {
      this.getAllHandlers()
    }
  })
</script>


{% endblock %}